<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المتجر الاحترافي المتكامل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- مكتبة Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- مكتبة Animate.css للتأثيرات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #2c3e50;
            --dark: #1a252f;
            --bg-primary: linear-gradient(135deg, #1a237e 0%, #3f51b5 100%);
            --bg-secondary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.8);
            --border-color: rgba(255,255,255,0.2);
            --animation-speed: 1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #3f51b5 50%, #667eea 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            direction: rtl;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* شريط التنقل */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            backdrop-filter: blur(15px);
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
            border-left: 1px solid var(--border-color);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }

        .logo h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.15);
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.3);
        }

        .nav-link.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border-color: #ffd700;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            border-right: 3px solid #ffd700;
        }

        .nav-link .icon {
            margin-left: 15px;
            font-size: 1.2em;
        }

        /* المحتوى الرئيسي */
        .main-content {
            flex: 1;
            margin-right: 280px;
            padding: 20px;
            overflow-y: auto;
        }

        .section {
            display: none;
            background: var(--bg-secondary);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .section.active {
            display: block;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .content-header h2 {
            font-size: 2em;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* الأزرار */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #20c997);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #e74c3c);
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning), #f39c12);
            color: #333;
        }

        .btn-info {
            background: linear-gradient(45deg, var(--info), #3498db);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.3);
        }

        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* الجداول */
        .table-container {
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        th {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            font-weight: 600;
            font-size: 1.1em;
            color: var(--text-primary);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        td {
            color: var(--text-primary);
        }

        tr:hover {
            background: rgba(255,255,255,0.1);
        }

        /* النماذج */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100% !important;
            padding: 14px 16px !important;
            border: 2px solid rgba(102, 126, 234, 0.3) !important;
            border-radius: 12px !important;
            background: rgba(255, 255, 255, 0.98) !important;
            color: #2c3e50 !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }

        .form-control::placeholder {
            color: rgba(44, 62, 80, 0.6) !important;
            font-weight: 400 !important;
        }

        .form-control:focus {
            outline: none !important;
            border-color: #667eea !important;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15), 0 4px 12px rgba(0, 0, 0, 0.12) !important;
            background: rgba(255, 255, 255, 1) !important;
            transform: translateY(-1px) !important;
        }

        .form-control:hover {
            border-color: rgba(102, 126, 234, 0.5) !important;
            box-shadow: 0 2px 12px rgba(102, 126, 234, 0.1) !important;
        }

        /* تحسينات القوائم المنسدلة الاحترافية */
        select.form-control {
            background: rgba(255, 255, 255, 0.98) !important;
            color: #2c3e50 !important;
            cursor: pointer !important;
            appearance: none !important;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: left 12px center !important;
            background-size: 16px !important;
            padding-left: 40px !important;
            font-weight: 500 !important;
        }

        select.form-control:hover {
            border-color: #667eea !important;
            box-shadow: 0 2px 12px rgba(102, 126, 234, 0.15) !important;
        }

        select.form-control option {
            background: #ffffff !important;
            color: #2c3e50 !important;
            padding: 12px 16px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            border: none !important;
        }

        select.form-control option:hover,
        select.form-control option:focus {
            background: #f8f9ff !important;
            color: #667eea !important;
        }

        select.form-control option:checked,
        select.form-control option:selected {
            background: #667eea !important;
            color: #ffffff !important;
            font-weight: 600 !important;
        }

        /* تحسينات textarea الاحترافية */
        textarea.form-control {
            background: rgba(255, 255, 255, 0.98) !important;
            color: #2c3e50 !important;
            resize: vertical !important;
            min-height: 80px !important;
            line-height: 1.5 !important;
            font-family: inherit !important;
        }

        textarea.form-control:focus {
            min-height: 120px !important;
        }

        /* إصلاح شامل لجميع القوائم المنسدلة */
        select {
            background: rgba(255,255,255,0.98) !important;
            color: #333 !important;
        }

        select option {
            background: #ffffff !important;
            color: #333 !important;
            padding: 8px 12px !important;
        }

        select option:hover {
            background: #e3f2fd !important;
            color: #333 !important;
        }

        select option:checked,
        select option:selected {
            background: var(--primary) !important;
            color: white !important;
        }

        /* إصلاح خاص للقوائم في النوافذ المنبثقة */
        .modal select,
        .modal select.form-control {
            background: rgba(255,255,255,0.98) !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

        .modal select option {
            background: #ffffff !important;
            color: #333 !important;
        }

        /* إصلاح للقوائم في الإعدادات */
        #settings select,
        #settings select.form-control {
            background: rgba(255,255,255,0.98) !important;
            color: #333 !important;
        }

        #settings select option {
            background: #ffffff !important;
            color: #333 !important;
        }

        /* إصلاح شامل لجميع الحقول في النوافذ المنبثقة */
        .modal input[type="text"],
        .modal input[type="number"],
        .modal input[type="email"],
        .modal input[type="tel"],
        .modal textarea {
            background: rgba(255,255,255,0.98) !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

        .modal input[type="text"]:focus,
        .modal input[type="number"]:focus,
        .modal input[type="email"]:focus,
        .modal input[type="tel"]:focus,
        .modal textarea:focus {
            background: rgba(255,255,255,1) !important;
            color: #333 !important;
            border-color: var(--primary) !important;
        }

        /* إصلاح للحقول في الإعدادات */
        #settings input[type="text"],
        #settings input[type="number"],
        #settings input[type="email"],
        #settings input[type="tel"],
        #settings textarea {
            background: rgba(255,255,255,0.98) !important;
            color: #333 !important;
        }

        /* إصلاح labels في النوافذ المنبثقة */
        .modal label {
            color: var(--text-primary) !important;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* تحسينات احترافية متقدمة */

        /* تأثيرات الحركة المتقدمة */
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        /* تطبيق متغير السرعة على التأثيرات */
        .sidebar {
            animation: slideInFromRight calc(0.6s * var(--animation-speed)) ease-out;
        }

        .main-content {
            animation: slideInFromLeft calc(0.6s * var(--animation-speed)) ease-out;
        }

        .section.active {
            animation: fadeInUp calc(0.5s * var(--animation-speed)) ease-out;
        }

        .stat-card {
            animation: scaleIn calc(0.4s * var(--animation-speed)) ease-out;
            animation-fill-mode: both;
        }

        /* تطبيق التأثيرات على العناصر */
        .sidebar {
            animation: slideInFromRight 0.6s ease-out;
        }

        .main-content {
            animation: slideInFromLeft 0.6s ease-out;
        }

        .section.active {
            animation: fadeInUp 0.5s ease-out;
        }

        .stat-card {
            animation: scaleIn 0.4s ease-out;
            animation-fill-mode: both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        /* تحسينات الأزرار الاحترافية */
        .btn {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--bg-secondary), rgba(255,255,255,0.1));
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.4);
        }

        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* أزرار ملونة احترافية */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #218838 0%, #1ba085 100%);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            border: none;
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #d62c1a 100%);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            border: none;
            color: #333;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, #e68900 100%);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #3498db 100%);
            border: none;
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #138496 0%, #2980b9 100%);
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.4);
        }

        /* تحسينات الجداول الاحترافية */
        .table-container {
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .table-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            position: relative;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.4), rgba(118, 75, 162, 0.4));
            border-bottom: 2px solid var(--border-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 12px;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffd700, transparent);
        }

        tr {
            transition: all 0.3s ease;
        }

        tr:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        td {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        /* تحسينات البطاقات الاحترافية */
        .stat-card {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--bg-secondary), rgba(255,255,255,0.1));
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::after {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.4);
        }

        .stat-icon {
            transition: all 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.2) rotate(5deg);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }

        .stat-number {
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card:hover .stat-number {
            transform: scale(1.1);
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
        }

        /* تحسينات النوافذ المنبثقة الاحترافية */
        .modal {
            backdrop-filter: blur(10px);
            animation: modalBackdropFadeIn 0.4s ease;
        }

        @keyframes modalBackdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            overflow: hidden;
            border: 2px solid var(--border-color);
            box-shadow: 0 25px 50px rgba(0,0,0,0.6);
            animation: modalContentSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalContentSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
        }

        .modal-header {
            position: relative;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffd700, transparent);
        }

        .modal-title {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .modal-close {
            transition: all 0.3s ease;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .modal-footer {
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.4), rgba(52, 73, 94, 0.4));
            border-top: 2px solid var(--border-color);
        }

        /* تحسينات الحقول الاحترافية */
        .form-control {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-control:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            border-color: var(--primary);
        }

        .form-control:hover {
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* تحسينات الشريط الجانبي */
        .nav-link {
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #ffd700, #ffeb3b);
            box-shadow: 0 0 10px #ffd700;
        }

        /* تحسينات الإشعارات الاحترافية */
        .notification {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            animation: notificationSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea, #764ba2);
        }

        .notification.success::before {
            background: linear-gradient(180deg, #28a745, #20c997);
        }

        .notification.error::before {
            background: linear-gradient(180deg, #dc3545, #e74c3c);
        }

        .notification.warning::before {
            background: linear-gradient(180deg, #ffc107, #ff9800);
        }

        .notification.info::before {
            background: linear-gradient(180deg, #17a2b8, #3498db);
        }

        /* تأثيرات التحميل الاحترافية */
        .loading-spinner {
            position: relative;
            width: 40px;
            height: 40px;
            margin: 20px auto;
        }

        .loading-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* تحسينات الأيقونات */
        .nav-link i,
        .btn i,
        .stat-icon {
            transition: all 0.3s ease;
        }

        .nav-link:hover i {
            transform: scale(1.2);
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
        }

        .btn:hover i {
            transform: scale(1.1);
        }

        /* تأثيرات الخلفية المتحركة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
            animation: backgroundMove 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes backgroundMove {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(30px, -30px) scale(1.1);
            }
            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }
        }

        /* تحسينات التمرير */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea, #764ba2);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #5a6fd8, #6a4190);
        }

        /* تأثيرات إضافية للتحسينات الاحترافية */

        /* تأثير الموجة للأزرار */
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* تأثير الظهور التدريجي */
        .animate-in {
            animation: fadeInUp 0.6s ease-out;
        }

        /* تأثير التحميل للأزرار */
        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn.loading i {
            animation: spin 1s linear infinite;
        }

        /* تحسينات الصور */
        img.lazy {
            opacity: 0;
            transition: opacity 0.3s;
        }

        img.lazy.loaded {
            opacity: 1;
        }

        /* تأثيرات الجوال */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                font-size: 16px;
            }

            .form-control {
                min-height: 44px;
                font-size: 16px;
            }

            .modal-content {
                margin: 10px;
                max-height: 90vh;
            }

            .stat-card {
                padding: 15px;
            }

            .nav-link {
                padding: 12px 15px;
            }
        }

        /* تأثيرات الفوكس المتقدمة */
        .form-control:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .btn:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* تحسينات الطباعة */
        @media print {
            .sidebar,
            .quick-ideas,
            .btn,
            .modal {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            .section {
                background: white !important;
                color: black !important;
                box-shadow: none !important;
            }
        }

        /* تأثيرات الحركة المتقدمة */
        .section {
            transition: all 0.3s ease;
        }

        .section.active {
            transform: translateX(0);
        }

        .section:not(.active) {
            transform: translateX(-20px);
            opacity: 0;
        }

        /* تحسينات الأداء */
        * {
            will-change: auto;
        }

        .btn,
        .nav-link,
        .stat-card,
        .form-control {
            will-change: transform, box-shadow;
        }

        /* تأثيرات الألوان الديناميكية */
        .dynamic-color {
            transition: all 0.3s ease;
        }

        .success-glow {
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
        }

        .error-glow {
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.5);
        }

        .warning-glow {
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
        }

        .info-glow {
            box-shadow: 0 0 20px rgba(23, 162, 184, 0.5);
        }

        /* تحسينات متقدمة إضافية */

        /* تأثيرات الجسيمات المتحركة */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* تأثيرات الإضاءة الديناميكية */
        .dynamic-lighting {
            position: relative;
            overflow: hidden;
        }

        .dynamic-lighting::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent,
                rgba(102, 126, 234, 0.1),
                transparent,
                rgba(118, 75, 162, 0.1),
                transparent
            );
            animation: rotate 10s linear infinite;
            pointer-events: none;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* تحسينات الخطوط والنصوص */
        .text-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2, #ffd700);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* تأثيرات الحدود المتحركة */
        .animated-border {
            position: relative;
            border: 2px solid transparent;
            background: linear-gradient(var(--bg-secondary), var(--bg-secondary)) padding-box,
                        linear-gradient(45deg, #667eea, #764ba2, #ffd700, #667eea) border-box;
            animation: borderRotate 3s linear infinite;
        }

        @keyframes borderRotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* تأثيرات الظلال المتقدمة */
        .advanced-shadow {
            box-shadow:
                0 0 20px rgba(102, 126, 234, 0.3),
                0 0 40px rgba(118, 75, 162, 0.2),
                0 0 60px rgba(255, 215, 0, 0.1);
            transition: all 0.3s ease;
        }

        .advanced-shadow:hover {
            box-shadow:
                0 0 30px rgba(102, 126, 234, 0.5),
                0 0 60px rgba(118, 75, 162, 0.4),
                0 0 90px rgba(255, 215, 0, 0.3);
        }

        /* تحسينات الشبكة والتخطيط */
        .grid-container {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            animation: gridFadeIn 0.8s ease-out;
        }

        @keyframes gridFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تأثيرات التمرير المتقدمة */
        .scroll-reveal {
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scroll-reveal.revealed {
            opacity: 1;
            transform: translateY(0);
        }

        /* تحسينات الأيقونات */
        .icon-bounce {
            animation: iconBounce 2s infinite;
        }

        @keyframes iconBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .icon-pulse {
            animation: iconPulse 2s infinite;
        }

        @keyframes iconPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* تأثيرات الخلفية المتقدمة */
        .mesh-gradient {
            background:
                radial-gradient(circle at 25% 25%, rgba(102, 126, 234, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(118, 75, 162, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: meshMove 15s ease-in-out infinite;
        }

        @keyframes meshMove {
            0%, 100% {
                background-position: 0% 0%, 100% 100%, 50% 50%;
            }
            33% {
                background-position: 30% 70%, 70% 30%, 80% 20%;
            }
            66% {
                background-position: 70% 30%, 30% 70%, 20% 80%;
            }
        }

        /* تحسينات الشفافية والضبابية */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .frosted-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px) brightness(1.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* تأثيرات الانتقال المتقدمة */
        .page-transition {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }

        .slide-in-left {
            animation: slideInLeft 0.6s ease-out;
        }

        .slide-in-up {
            animation: slideInUp 0.6s ease-out;
        }

        .slide-in-down {
            animation: slideInDown 0.6s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* تحسينات التفاعل المتقدمة */
        .interactive-element {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .interactive-element:hover {
            transform: translateY(-5px) scale(1.02);
        }

        .interactive-element:active {
            transform: translateY(-2px) scale(0.98);
        }

        /* تأثيرات الإضاءة الجانبية */
        .side-glow {
            position: relative;
        }

        .side-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: -2px;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, #667eea, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .side-glow:hover::before {
            opacity: 1;
        }

        /* تحسينات الأرقام والإحصائيات */
        .counter-animation {
            font-variant-numeric: tabular-nums;
            transition: all 0.3s ease;
        }

        .number-highlight {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }

        /* تأثيرات الحدود المضيئة */
        .glowing-border {
            border: 2px solid transparent;
            background: linear-gradient(var(--bg-secondary), var(--bg-secondary)) padding-box,
                        linear-gradient(45deg, #667eea, #764ba2) border-box;
            position: relative;
        }

        .glowing-border::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: inherit;
            z-index: -1;
            filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .glowing-border:hover::after {
            opacity: 0.7;
        }

        /* تحسينات نهائية احترافية */

        /* تأثيرات الماوس المتقدمة */
        .mouse-trail {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.6), transparent);
            pointer-events: none;
            z-index: 9999;
            transition: all 0.1s ease;
        }

        /* تأثيرات الضوء المتتبع */
        .light-cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3), transparent);
            pointer-events: none;
            z-index: 9998;
            transition: all 0.2s ease;
            mix-blend-mode: screen;
        }

        /* تحسينات الخطوط المتقدمة */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-feature-settings: 'liga' 1, 'kern' 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* تحسينات الأداء المتقدمة */
        .gpu-accelerated {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        /* تأثيرات الانعكاس */
        .reflection-effect {
            position: relative;
        }

        .reflection-effect::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to bottom,
                rgba(255,255,255,0.1) 0%,
                transparent 100%);
            transform: scaleY(-1);
            opacity: 0.3;
            pointer-events: none;
        }

        /* تأثيرات الهولوجرام */
        .hologram-effect {
            background: linear-gradient(45deg,
                transparent 30%,
                rgba(255,255,255,0.1) 50%,
                transparent 70%);
            background-size: 20px 20px;
            animation: hologramMove 2s linear infinite;
        }

        @keyframes hologramMove {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        /* تحسينات الشفافية المتقدمة */
        .ultra-glass {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(25px) saturate(200%) contrast(120%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* تأثيرات الطاقة */
        .energy-pulse {
            position: relative;
            overflow: hidden;
        }

        .energy-pulse::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(102, 126, 234, 0.4),
                transparent);
            animation: energyPulse 3s infinite;
        }

        @keyframes energyPulse {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        /* تحسينات الاستجابة المتقدمة */
        @media (max-width: 1200px) {
            .advanced-shadow {
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
        }

        @media (max-width: 992px) {
            .particles-container {
                display: none;
            }

            .dynamic-lighting::before {
                animation-duration: 20s;
            }
        }

        @media (max-width: 576px) {
            .text-gradient {
                background-size: 100% 100%;
                animation: none;
            }

            .hologram-effect {
                animation: none;
            }
        }

        /* تحسينات إمكانية الوصول */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* تحسينات الوضع المظلم */
        @media (prefers-color-scheme: dark) {
            :root {
                --text-primary: #ffffff;
                --text-secondary: rgba(255,255,255,0.8);
                --border-color: rgba(255,255,255,0.3);
            }
        }

        /* تأثيرات الطباعة المتقدمة */
        @media print {
            .particle,
            .mouse-trail,
            .light-cursor,
            .energy-pulse::before,
            .hologram-effect {
                display: none !important;
            }

            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* تأثيرات إضافية للتحسينات الاحترافية */

        /* تأثير الموجة للأزرار */
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* تأثير الظهور التدريجي */
        .animate-in {
            animation: fadeInUp 0.6s ease-out;
        }

        /* تأثير التحميل للأزرار */
        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn.loading i {
            animation: spin 1s linear infinite;
        }

        /* تحسينات الصور */
        img.lazy {
            opacity: 0;
            transition: opacity 0.3s;
        }

        img.lazy.loaded {
            opacity: 1;
        }

        /* تأثيرات الجوال */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                font-size: 16px;
            }

            .form-control {
                min-height: 44px;
                font-size: 16px;
            }

            .modal-content {
                margin: 10px;
                max-height: 90vh;
            }

            .stat-card {
                padding: 15px;
            }

            .nav-link {
                padding: 12px 15px;
            }
        }

        /* تأثيرات الفوكس المتقدمة */
        .form-control:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .btn:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* تحسينات الطباعة */
        @media print {
            .sidebar,
            .quick-ideas,
            .btn,
            .modal {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            .section {
                background: white !important;
                color: black !important;
                box-shadow: none !important;
            }
        }

        /* تأثيرات الحركة المتقدمة */
        .section {
            transition: all 0.3s ease;
        }

        .section.active {
            transform: translateX(0);
        }

        .section:not(.active) {
            transform: translateX(-20px);
            opacity: 0;
        }

        /* تحسينات الأداء */
        * {
            will-change: auto;
        }

        .btn,
        .nav-link,
        .stat-card,
        .form-control {
            will-change: transform, box-shadow;
        }

        /* تأثيرات الألوان الديناميكية */
        .dynamic-color {
            transition: all 0.3s ease;
        }

        .success-glow {
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
        }

        .error-glow {
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.5);
        }

        .warning-glow {
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
        }

        .info-glow {
            box-shadow: 0 0 20px rgba(23, 162, 184, 0.5);
        }

        /* التنبيهات */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.3);
            color: #d4edda;
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.3);
            color: #f8d7da;
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.3);
            color: #fff3cd;
        }

        .alert-info {
            background: rgba(23, 162, 184, 0.2);
            border-color: rgba(23, 162, 184, 0.3);
            color: #d1ecf1;
        }

        /* إشعارات Toast */
        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-right: 4px solid;
            animation: toastSlideIn 0.3s ease;
            position: relative;
            overflow: hidden;
            color: #333;
        }

        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes toastSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }
        .toast.info { border-color: var(--info); }

        .toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-message {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        /* أحجام الخطوط */
        .font-size-small { font-size: 12px; }
        .font-size-small .stat-number { font-size: 2em; }
        .font-size-small .content-header h2 { font-size: 1.5em; }

        .font-size-medium { font-size: 14px; }
        .font-size-medium .stat-number { font-size: 2.5em; }
        .font-size-medium .content-header h2 { font-size: 2em; }

        .font-size-large { font-size: 16px; }
        .font-size-large .stat-number { font-size: 3em; }
        .font-size-large .content-header h2 { font-size: 2.5em; }

        /* الثيم الداكن */
        .theme-dark {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
        }
        .theme-dark .sidebar {
            background: rgba(0,0,0,0.4) !important;
        }
        .theme-dark .section {
            background: rgba(0,0,0,0.3) !important;
        }
        .theme-dark .stat-card {
            background: rgba(0,0,0,0.2) !important;
        }
        .theme-dark .form-control {
            background: rgba(0,0,0,0.2) !important;
            border-color: rgba(255,255,255,0.2) !important;
        }

        /* الثيم التجاري */
        .theme-business {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        .theme-business .sidebar {
            background: rgba(30,60,114,0.3) !important;
        }
        .theme-business .section {
            background: rgba(30,60,114,0.2) !important;
        }

        /* الوضع المضغوط */
        .compact-mode .stat-card {
            padding: 15px !important;
        }
        .compact-mode .section {
            padding: 20px !important;
        }
        .compact-mode .form-group {
            margin-bottom: 15px !important;
        }
        .compact-mode .content-header {
            margin-bottom: 20px !important;
        }
        .compact-mode .stats-grid {
            gap: 15px !important;
        }

        /* ملء الشاشة */
        .fullscreen-mode .sidebar {
            width: 200px !important;
        }
        .fullscreen-mode .main-content {
            margin-right: 200px !important;
        }
        .fullscreen-mode .app-container {
            max-width: 100% !important;
        }

        /* النوافذ المنبثقة (Modals) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            animation: modalFadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: var(--text-primary);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.3s ease;
            border: 1px solid var(--border-color);
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            margin: -30px -30px 20px -30px;
            padding: 20px 30px 15px 30px;
            border-radius: 20px 20px 0 0;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.3), rgba(52, 73, 94, 0.3));
            margin: 20px -30px -30px -30px;
            padding: 15px 30px 20px 30px;
            border-radius: 0 0 20px 20px;
        }

        /* أفكار سريعة */
        .quick-ideas {
            position: fixed;
            bottom: 20px;
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.95) 0%, rgba(74, 144, 226, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(74, 144, 226, 0.3);
            color: #ffffff;
            max-width: 300px;
            z-index: 1500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        /* موضع للغة العربية */
        [dir="rtl"] .quick-ideas,
        body:not([dir="ltr"]) .quick-ideas {
            left: 20px;
        }

        /* موضع للغة الإنجليزية */
        [dir="ltr"] .quick-ideas {
            right: 20px;
            left: auto;
        }

        .quick-ideas.collapsed {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            max-width: 60px;
            padding: 0;
        }

        .quick-ideas-toggle {
            position: absolute;
            top: 10px;
            background: rgba(102, 126, 234, 0.9);
            border: 2px solid rgba(102, 126, 234, 1);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .quick-ideas-manage {
            position: absolute;
            top: 10px;
            background: rgba(40, 167, 69, 0.9);
            border: 2px solid rgba(40, 167, 69, 1);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        /* مواضع الأزرار للغة العربية */
        [dir="rtl"] .quick-ideas-toggle,
        body:not([dir="ltr"]) .quick-ideas-toggle {
            right: 10px;
        }

        [dir="rtl"] .quick-ideas-manage,
        body:not([dir="ltr"]) .quick-ideas-manage {
            left: 10px;
        }

        /* مواضع الأزرار للغة الإنجليزية */
        [dir="ltr"] .quick-ideas-toggle {
            left: 10px;
            right: auto;
        }

        [dir="ltr"] .quick-ideas-manage {
            right: 10px;
            left: auto;
        }

        .quick-ideas-toggle:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .quick-ideas-manage:hover {
            background: rgba(40, 167, 69, 1);
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .quick-ideas-content {
            padding: 20px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .quick-ideas.collapsed .quick-ideas-content {
            opacity: 0;
            pointer-events: none;
        }

        .quick-ideas.collapsed .quick-ideas-toggle {
            position: absolute;
            top: 50%;
            left: 50%;
            right: auto;
            transform: translate(-50%, -50%);
        }

        .quick-ideas.collapsed .quick-ideas-manage {
            display: none;
        }

        .quick-ideas h4 {
            margin-bottom: 15px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .idea-item {
            padding: 12px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.1));
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid #ffd700;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .idea-item:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.2));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left-color: #ffeb3b;
            border-color: rgba(255,255,255,0.4);
        }

        .idea-item strong {
            color: #ffffff;
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .idea-item small {
            color: rgba(255,255,255,0.8);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .idea-item:last-child {
            margin-bottom: 0;
        }

        /* تأثير النبضة للوضع المطوي */
        .quick-ideas.collapsed::before {
            content: '💡';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.4; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
        }

        /* مواضع الأفكار السريعة */
        .quick-ideas.position-bottom-left {
            bottom: 20px;
            left: 20px;
            top: auto;
            right: auto;
        }

        .quick-ideas.position-bottom-right {
            bottom: 20px;
            right: 20px;
            top: auto;
            left: auto;
        }

        .quick-ideas.position-top-left {
            top: 80px;
            left: 20px;
            bottom: auto;
            right: auto;
        }

        .quick-ideas.position-top-right {
            top: 80px;
            right: 20px;
            bottom: auto;
            left: auto;
        }

        /* أحجام الأفكار السريعة */
        .quick-ideas.size-small {
            max-width: 220px;
            font-size: 13px;
        }

        .quick-ideas.size-small .quick-ideas-toggle,
        .quick-ideas.size-small .quick-ideas-manage {
            width: 30px;
            height: 30px;
            font-size: 12px;
        }

        .quick-ideas.size-medium {
            max-width: 300px;
            font-size: 14px;
        }

        .quick-ideas.size-large {
            max-width: 380px;
            font-size: 15px;
        }

        .quick-ideas.size-large .quick-ideas-toggle,
        .quick-ideas.size-large .quick-ideas-manage {
            width: 45px;
            height: 45px;
            font-size: 16px;
        }

        /* زر إدارة الأفكار السريعة الخارجي */
        .quick-ideas-external-manager {
            position: fixed;
            bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1600;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
            font-size: 24px;
        }

        /* موضع للغة العربية */
        [dir="rtl"] .quick-ideas-external-manager,
        body:not([dir="ltr"]) .quick-ideas-external-manager {
            left: 20px;
        }

        /* موضع للغة الإنجليزية */
        [dir="ltr"] .quick-ideas-external-manager {
            right: 20px;
            left: auto;
        }

        .quick-ideas-external-manager:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(0,0,0,0.4);
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .quick-ideas-external-manager:active {
            transform: scale(0.95);
        }

        /* إخفاء الزر الخارجي عند تفعيل الأفكار السريعة */
        .quick-ideas-external-manager.hidden {
            display: none;
        }

        /* تحسينات الاستجابة */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }

            .main-content {
                margin-right: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .theme-toggle-btn {
                top: 10px !important;
                left: 10px !important;
                width: 40px !important;
                height: 40px !important;
                font-size: 16px !important;
            }

            .theme-selector {
                top: 10px !important;
                left: 10px !important;
                min-width: 250px !important;
            }

            .quick-ideas {
                bottom: 10px;
                left: 10px;
                max-width: 250px;
                padding: 15px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        /* أنماط الإشعارات المحسنة */
        .notification {
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }

        .notification-content {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .notification-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .notification-error {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            color: white;
        }

        .notification-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
        }

        .notification-info {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            color: white;
        }

        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: auto;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* تحسينات إضافية للواجهة */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        /* أنماط المخططات البيانية */
        #chartsContainer {
            transition: all 0.3s ease;
        }

        #chartsContainer.hidden {
            display: none !important;
        }

        /* تأثير النبض للبيانات اللحظية */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .live-indicator {
            animation: pulse 2s infinite;
        }

        /* تحسينات البحث السريع */
        #quickSearchResults {
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .search-result-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: var(--primary-color);
        }

        .search-result-type {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .search-result-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .search-result-description {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* تحسينات مركز التنبيهات */
        .alert-item {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .alert-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .alert-item.critical {
            background: rgba(220,53,69,0.2);
            border-left-color: #dc3545;
        }

        .alert-item.warning {
            background: rgba(255,193,7,0.2);
            border-left-color: #ffc107;
        }

        .alert-item.info {
            background: rgba(23,162,184,0.2);
            border-left-color: #17a2b8;
        }

        .alert-item.success {
            background: rgba(40,167,69,0.2);
            border-left-color: #28a745;
        }

        /* تحسينات اختصارات الوصول السريع */
        .btn-outline-light:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* تحسينات المخططات */
        canvas {
            max-width: 100%;
            height: auto !important;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        #chartsContainer canvas {
            width: 100% !important;
            height: 250px !important;
        }

        /* تأثيرات الحركة للبطاقات */
        .stat-card, .alert-item, .search-result-item {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تحسينات الوضع الداكن */
        .dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
        }

        .dark-mode .main-content {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .dark-mode .sidebar {
            background: var(--bg-secondary);
        }

        /* تحسينات متجاوبة للمخططات */
        @media (max-width: 768px) {
            #chartsContainer {
                grid-template-columns: 1fr !important;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(40,167,69,0.2);
            color: #28a745;
        }

        .status-inactive {
            background: rgba(220,53,69,0.2);
            color: #dc3545;
        }

        .status-pending {
            background: rgba(255,193,7,0.2);
            color: #ffc107;
        }

        .membership-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .membership-bronze {
            background: #cd7f32;
            color: white;
        }

        .membership-silver {
            background: #c0c0c0;
            color: #333;
        }

        .membership-gold {
            background: #ffd700;
            color: #333;
        }

        .membership-platinum {
            background: #e5e4e2;
            color: #333;
        }

        /* تحسينات للجداول */
        .table-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* تحسينات للنماذج */
        .form-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-section h4 {
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }

        .required-field::after {
            content: " *";
            color: #dc3545;
        }

        .field-help {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        /* تحسينات للإحصائيات */
        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--info));
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- أزرار التحكم السريع -->
    <div style="position: fixed; top: 20px; left: 20px; z-index: 2001; display: flex; flex-direction: column; gap: 10px;">
        <!-- زر التخصيص -->
        <button class="theme-toggle-btn" onclick="toggleThemeSelector()" title="تخصيص الواجهة" style="
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        ">
            <i class="fas fa-palette"></i>
        </button>

        <!-- زر الوضع الداكن -->
        <button onclick="toggleDarkMode()" title="تبديل الوضع الداكن" style="
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        ">
            <i class="fas fa-moon" id="darkModeIcon"></i>
        </button>

        <!-- زر تعدد اللغات -->
        <button onclick="toggleLanguage()" title="تغيير اللغة" style="
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        ">
            <i class="fas fa-language"></i>
        </button>

        <!-- زر الملء الكامل -->
        <button onclick="toggleFullscreen()" title="ملء الشاشة" style="
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        ">
            <i class="fas fa-expand" id="fullscreenIcon"></i>
        </button>
    </div>

    <!-- لوحة التخصيص -->
    <div class="theme-selector" id="themeSelector" style="
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 2000;
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border: 1px solid rgba(255,255,255,0.2);
        display: none;
        color: #333;
        min-width: 280px;
    ">
        <h4 style="margin-bottom: 15px; color: #333;">🎨 تخصيص الواجهة</h4>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">نمط التنقل:</label>
            <select id="navigationStyle" onchange="changeNavigationStyle()" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                <option value="sidebar">شريط جانبي (افتراضي)</option>
                <option value="top">شريط علوي</option>
            </select>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">حجم الخط:</label>
            <select id="fontSize" onchange="changeFontSize()" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                <option value="small">صغير</option>
                <option value="medium" selected>متوسط</option>
                <option value="large">كبير</option>
            </select>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">الثيم:</label>
            <select id="themeMode" onchange="changeTheme()" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                <option value="default" selected>افتراضي</option>
                <option value="dark">داكن</option>
                <option value="business">تجاري</option>
            </select>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="compactMode" onchange="toggleCompactMode()">
                <span>وضع مضغوط</span>
            </label>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="fullscreenMode" onchange="toggleFullscreenMode()">
                <span>ملء الشاشة</span>
            </label>
        </div>

        <button onclick="resetUIToDefaults()" style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
            إعادة تعيين
        </button>
    </div>

    <!-- التنقل العلوي الاختياري -->
    <nav class="top-navigation" id="topNavigation" style="
        display: none;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 999;
    ">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;">
            <div style="font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-store"></i>
                <span>نظام إدارة المتجر</span>
            </div>

            <div style="display: flex; gap: 5px; overflow-x: auto;">
                <button class="top-nav-tab active" onclick="showSection('dashboard')" data-section="dashboard" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.25);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-home"></i>
                    <span>لوحة التحكم</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('products')" data-section="products" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-box"></i>
                    <span>المشتريات</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('pos')" data-section="pos" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-cash-register"></i>
                    <span>المبيعات</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('invoice-inquiry')" data-section="invoice-inquiry" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-search"></i>
                    <span>استعلام</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('suppliers')" data-section="suppliers" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-industry"></i>
                    <span>الموردين</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('customers')" data-section="customers" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-users"></i>
                    <span>العملاء</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('expenses')" data-section="expenses" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>المصروفات</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('backup')" data-section="backup" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>النسخ الاحتياطي</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('settings')" data-section="settings" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </button>
                <button class="top-nav-tab" onclick="showSection('advanced')" data-section="advanced" style="
                    display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.1);
                    border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s ease;
                    white-space: nowrap; text-decoration: none; font-size: 14px; font-weight: 500;
                ">
                    <i class="fas fa-plus-circle"></i>
                    <span>خيارات أخرى</span>
                </button>
            </div>

            <div style="display: flex; align-items: center; gap: 15px;">
                <button onclick="toggleNotifications()" title="الإشعارات" style="
                    position: relative; background: rgba(255,255,255,0.1); border: none; border-radius: 50%;
                    width: 40px; height: 40px; color: white; cursor: pointer; display: flex;
                    align-items: center; justify-content: center; transition: all 0.3s ease;
                ">
                    <i class="fas fa-bell"></i>
                    <span style="
                        position: absolute; top: -5px; right: -5px; background: var(--danger); color: white;
                        border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex;
                        align-items: center; justify-content: center; font-weight: bold;
                    " id="notificationCount">3</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- حاوي الإشعارات -->
    <div id="toastContainer" style="
        position: fixed; bottom: 20px; right: 20px; z-index: 3000;
        display: flex; flex-direction: column; gap: 10px; max-width: 350px;
    "></div>

    <!-- زر إدارة الأفكار السريعة الخارجي -->
    <div class="quick-ideas-external-manager" id="quickIdeasExternalManager" onclick="showQuickIdeasManager()" title="إدارة الأفكار السريعة">
        <i class="fas fa-lightbulb"></i>
    </div>

    <!-- الأفكار السريعة المحسنة -->
    <div class="quick-ideas" id="quickIdeas" style="display: none;">
        <button class="quick-ideas-toggle" onclick="toggleQuickIdeas()" title="إخفاء الأفكار السريعة">
            <i class="fas fa-times" id="quickIdeasToggleIcon"></i>
        </button>
        <div class="quick-ideas-content">
            <h4><i class="fas fa-lightbulb"></i> أفكار سريعة</h4>
            <div id="quickIdeasList">
                <div class="idea-item" onclick="showAddProductModal()">
                    <strong>إضافة منتج جديد</strong><br>
                    <small>أضف منتجات جديدة لمتجرك</small>
                </div>
                <div class="idea-item" onclick="showQuickSaleModal()">
                    <strong>بيع سريع</strong><br>
                    <small>ابدأ عملية بيع فورية</small>
                </div>
                <div class="idea-item" onclick="showSection('dashboard')">
                    <strong>لوحة التحكم</strong><br>
                    <small>اطلع على أداء اليوم</small>
                </div>
                <div class="idea-item" onclick="showSection('pos')">
                    <strong>نقطة البيع</strong><br>
                    <small>ابدأ عملية بيع جديدة</small>
                </div>
                <div class="idea-item" onclick="showSection('products')">
                    <strong>إدارة المنتجات</strong><br>
                    <small>عرض وتعديل المنتجات</small>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة منتج محسنة احترافياً -->
    <div class="modal" id="addProductModal">
        <div class="modal-content" style="max-width: 900px; margin: 1% auto; border-radius: 24px; overflow: hidden; box-shadow: 0 30px 100px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 35px 40px; border: none; position: relative;">
                <h3 class="modal-title" style="margin: 0; display: flex; align-items: center; gap: 18px; font-size: 28px; font-weight: 800; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 18px; border-radius: 50%; box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);">
                        <i class="fas fa-plus-circle" style="font-size: 32px;"></i>
                    </div>
                    إضافة منتج جديد
                    <span style="font-size: 14px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 25px; font-weight: 500; backdrop-filter: blur(10px);">سريع ومحسن</span>
                </h3>
                <button class="modal-close" onclick="closeModal('addProductModal')" style="position: absolute; top: 25px; left: 25px; background: rgba(255,255,255,0.15); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 24px;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 40px; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); position: relative;">
                <!-- مؤشر التقدم -->
                <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; color: #667eea;">معلومات المنتج</span>
                        <span style="font-size: 12px; color: #666;">الحقول المطلوبة *</span>
                    </div>
                    <div style="height: 4px; background: #e0e6ff; border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease;" id="progressBar"></div>
                    </div>
                </div>

                <!-- الصف الأول -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                    <div class="form-group">
                        <label style="font-weight: 700; color: #2c3e50; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-size: 15px;">
                            <div style="background: linear-gradient(135deg, #3498db, #2980b9); padding: 8px; border-radius: 8px; color: white;">
                                <i class="fas fa-barcode" style="font-size: 14px;"></i>
                            </div>
                            كود المنتج *
                        </label>
                        <input type="text" id="productCode" class="form-control" placeholder="مثال: P001" required
                               oninput="updateProgress()" style="font-weight: 500;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 700; color: #2c3e50; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-size: 15px;">
                            <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 8px; border-radius: 8px; color: white;">
                                <i class="fas fa-tag" style="font-size: 14px;"></i>
                            </div>
                            اسم المنتج *
                        </label>
                        <input type="text" id="productName" class="form-control" placeholder="أدخل اسم المنتج" required
                               oninput="updateProgress()" style="font-weight: 500;">
                    </div>
                </div>

                <!-- الصف الثاني -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-list" style="color: #9b59b6;"></i>
                            فئة المنتج
                        </label>
                        <select id="productCategory" class="form-control"
                                style="border: 2px solid #bdc3c7; border-radius: 12px; padding: 14px; font-size: 14px; background: white; transition: all 0.3s ease;">
                            <option value="" disabled selected style="color: #95a5a6;">اختر فئة المنتج</option>
                            <option value="إلكترونيات">📱 إلكترونيات</option>
                            <option value="أسلاك">🔌 أسلاك وكابلات</option>
                            <option value="لمبات">💡 لمبات وإضاءة</option>
                            <option value="أدوات">🔧 أدوات ومعدات</option>
                            <option value="ملابس">👕 ملابس</option>
                            <option value="طعام">🍔 طعام ومشروبات</option>
                            <option value="أدوات منزلية">🏠 أدوات منزلية</option>
                            <option value="أخرى">📦 أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-boxes" style="color: #f39c12;"></i>
                            الكمية المتوفرة *
                        </label>
                        <input type="number" id="productQuantity" class="form-control" placeholder="0" min="0" required
                               style="border: 2px solid #bdc3c7; border-radius: 12px; padding: 14px; font-size: 14px; transition: all 0.3s ease; background: white;">
                    </div>
                </div>

                <!-- الصف الثالث -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-dollar-sign" style="color: #27ae60;"></i>
                            سعر التكلفة *
                        </label>
                        <input type="number" id="productCostPrice" class="form-control" step="0.01" placeholder="0.00" min="0" required
                               style="border: 2px solid #bdc3c7; border-radius: 12px; padding: 14px; font-size: 14px; transition: all 0.3s ease; background: white;"
                               oninput="calculateProfit()">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-money-bill-wave" style="color: #2ecc71;"></i>
                            سعر البيع *
                        </label>
                        <input type="number" id="productSellPrice" class="form-control" step="0.01" placeholder="0.00" min="0" required
                               style="border: 2px solid #bdc3c7; border-radius: 12px; padding: 14px; font-size: 14px; transition: all 0.3s ease; background: white;"
                               oninput="calculateProfit()">
                    </div>
                </div>

                <!-- حساب الربح -->
                <div style="background: linear-gradient(135deg, #d5f4e6 0%, #ffeaa7 100%); padding: 18px; border-radius: 15px; margin-bottom: 20px; border-right: 5px solid #00b894;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #2d3436; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chart-line" style="color: #00b894;"></i>
                            الربح المتوقع:
                        </span>
                        <span id="expectedProfit" style="font-weight: bold; color: #00b894; font-size: 18px;">0.00 ريال</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #636e72;">نسبة الربح:</span>
                        <span id="profitMargin" style="font-weight: bold; color: #00b894; font-size: 16px;">0%</span>
                    </div>
                </div>

                <!-- الوصف -->
                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-align-left" style="color: #6c5ce7;"></i>
                        وصف المنتج (اختياري)
                    </label>
                    <textarea id="productDescription" class="form-control" rows="3" placeholder="أدخل وصف تفصيلي للمنتج..."
                              style="border: 2px solid #bdc3c7; border-radius: 12px; padding: 14px; font-size: 14px; resize: vertical; transition: all 0.3s ease; background: white;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="padding: 25px 30px; background: #ecf0f1; border: none; display: flex; gap: 15px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('addProductModal')"
                        style="padding: 14px 28px; border-radius: 10px; border: none; font-weight: 600; font-size: 14px; transition: all 0.3s ease;">
                    <i class="fas fa-times" style="margin-left: 8px;"></i>
                    إلغاء
                </button>
                <button class="btn btn-success" onclick="saveProduct()"
                        style="padding: 14px 28px; border-radius: 10px; border: none; font-weight: 600; font-size: 14px; background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); transition: all 0.3s ease;">
                    <i class="fas fa-save" style="margin-left: 8px;"></i>
                    حفظ المنتج
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة البيع السريع -->
    <div class="modal" id="quickSaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-shopping-cart"></i> بيع سريع</h3>
                <button class="modal-close" onclick="closeModal('quickSaleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>البحث عن منتج</label>
                    <input type="text" id="quickSaleSearch" class="form-control" placeholder="ابحث بالاسم أو الكود..." onkeyup="searchProductsForSale()">
                </div>
                <div id="quickSaleResults" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                    <!-- نتائج البحث -->
                </div>
                <div class="form-group">
                    <label>المنتج المحدد</label>
                    <input type="text" id="selectedProduct" class="form-control" readonly placeholder="لم يتم اختيار منتج">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>الكمية</label>
                        <input type="number" id="saleQuantity" class="form-control" placeholder="1" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>السعر</label>
                        <input type="number" id="salePrice" class="form-control" placeholder="0.00" step="0.01" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>الإجمالي</label>
                    <input type="text" id="saleTotal" class="form-control" readonly placeholder="0.00">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('quickSaleModal')">إلغاء</button>
                <button class="btn btn-success" onclick="completeQuickSale()">
                    <i class="fas fa-check"></i> إتمام البيع
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة جرد المخزون -->
    <div class="modal" id="inventoryCheckModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-clipboard-list"></i> جرد المخزون</h3>
                <button class="modal-close" onclick="closeModal('inventoryCheckModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="inventoryReport">
                    <!-- تقرير المخزون -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="exportInventoryReport()">
                    <i class="fas fa-download"></i> تصدير التقرير
                </button>
                <button class="btn btn-secondary" onclick="closeModal('inventoryCheckModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- نافذة التقرير اليومي -->
    <div class="modal" id="dailyReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-chart-line"></i> التقرير اليومي</h3>
                <button class="modal-close" onclick="closeModal('dailyReportModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dailyReportContent">
                    <!-- محتوى التقرير اليومي -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="printDailyReport()">
                    <i class="fas fa-print"></i> طباعة
                </button>
                <button class="btn btn-secondary" onclick="closeModal('dailyReportModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة مورد -->
    <div class="modal" id="addSupplierModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-industry"></i> إضافة مورد جديد</h3>
                <button class="modal-close" onclick="closeModal('addSupplierModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>كود المورد</label>
                        <input type="text" id="supplierCode" class="form-control" placeholder="مثال: SUP001">
                    </div>
                    <div class="form-group">
                        <label>اسم المورد</label>
                        <input type="text" id="supplierName" class="form-control" placeholder="اسم المورد">
                    </div>
                </div>
                <div class="form-group">
                    <label>اسم الشركة</label>
                    <input type="text" id="supplierCompany" class="form-control" placeholder="اسم الشركة">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="tel" id="supplierPhone" class="form-control" placeholder="+966xxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="supplierEmail" class="form-control" placeholder="supplier@company.com">
                    </div>
                </div>
                <div class="form-group">
                    <label>العنوان</label>
                    <textarea id="supplierAddress" class="form-control" rows="2" placeholder="عنوان المورد..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>التقييم (من 5)</label>
                        <select id="supplierRating" class="form-control">
                            <option value="5">ممتاز (5 نجوم)</option>
                            <option value="4">جيد جداً (4 نجوم)</option>
                            <option value="3" selected>جيد (3 نجوم)</option>
                            <option value="2">مقبول (نجمتان)</option>
                            <option value="1">ضعيف (نجمة واحدة)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>طريقة الدفع المفضلة</label>
                        <select id="supplierPaymentMethod" class="form-control">
                            <option value="cash">نقدي</option>
                            <option value="bank">تحويل بنكي</option>
                            <option value="check">شيك</option>
                            <option value="credit">آجل</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea id="supplierNotes" class="form-control" rows="3" placeholder="ملاحظات إضافية عن المورد..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addSupplierModal')">إلغاء</button>
                <button class="btn btn-success" onclick="saveSupplier()">
                    <i class="fas fa-save"></i> حفظ المورد
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة عميل -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-plus"></i> إضافة عميل جديد</h3>
                <button class="modal-close" onclick="closeModal('addCustomerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>كود العميل</label>
                        <input type="text" id="customerCode" class="form-control" placeholder="مثال: CUS001">
                    </div>
                    <div class="form-group">
                        <label>اسم العميل</label>
                        <input type="text" id="customerName" class="form-control" placeholder="اسم العميل">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="tel" id="customerPhone" class="form-control" placeholder="+966xxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="customerEmail" class="form-control" placeholder="customer@email.com">
                    </div>
                </div>
                <div class="form-group">
                    <label>العنوان</label>
                    <textarea id="customerAddress" class="form-control" rows="2" placeholder="عنوان العميل..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>نوع العميل</label>
                        <select id="customerType" class="form-control">
                            <option value="normal" selected>عادي</option>
                            <option value="wholesale">جملة</option>
                            <option value="trader">تاجر</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>حد الائتمان</label>
                        <input type="number" id="customerCreditLimit" class="form-control" placeholder="0" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>مدة السداد (أيام)</label>
                        <input type="number" id="customerPaymentDays" class="form-control" placeholder="30" min="1" value="30">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>وقت الاتصال المفضل</label>
                        <select id="customerPreferredTime" class="form-control">
                            <option value="morning">صباحاً (8-12)</option>
                            <option value="afternoon" selected>بعد الظهر (12-6)</option>
                            <option value="evening">مساءً (6-10)</option>
                            <option value="anytime">أي وقت</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="customerVIP">
                            <span>عميل VIP</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea id="customerNotes" class="form-control" rows="3" placeholder="ملاحظات إضافية عن العميل..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCustomerModal')">إلغاء</button>
                <button class="btn btn-success" onclick="saveCustomer()">
                    <i class="fas fa-save"></i> حفظ العميل
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة مصروف -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> إضافة مصروف جديد</h3>
                <button class="modal-close" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>نوع المصروف</label>
                        <select id="expenseType" class="form-control">
                            <option value="operational">تشغيلي</option>
                            <option value="maintenance">صيانة</option>
                            <option value="marketing">تسويق</option>
                            <option value="utilities">مرافق (كهرباء، ماء، إنترنت)</option>
                            <option value="rent">إيجار</option>
                            <option value="salaries">رواتب</option>
                            <option value="transportation">مواصلات</option>
                            <option value="office">مكتبية</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>المبلغ</label>
                        <input type="number" id="expenseAmount" class="form-control" placeholder="0.00" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>وصف المصروف</label>
                    <input type="text" id="expenseDescription" class="form-control" placeholder="وصف مختصر للمصروف">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>التاريخ</label>
                        <input type="date" id="expenseDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>طريقة الدفع</label>
                        <select id="expensePaymentMethod" class="form-control">
                            <option value="cash" selected>نقدي</option>
                            <option value="bank">تحويل بنكي</option>
                            <option value="card">بطاقة ائتمان</option>
                            <option value="check">شيك</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>المسؤول عن المصروف</label>
                        <input type="text" id="expenseResponsible" class="form-control" placeholder="اسم المسؤول">
                    </div>
                    <div class="form-group">
                        <label>رقم الفاتورة/الإيصال</label>
                        <input type="text" id="expenseReceiptNumber" class="form-control" placeholder="رقم الإيصال (اختياري)">
                    </div>
                </div>
                <div class="form-group">
                    <label>ملاحظات إضافية</label>
                    <textarea id="expenseNotes" class="form-control" rows="3" placeholder="ملاحظات إضافية عن المصروف..."></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="expenseRecurring">
                        <span>مصروف متكرر (شهرياً)</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addExpenseModal')">إلغاء</button>
                <button class="btn btn-success" onclick="saveExpense()">
                    <i class="fas fa-save"></i> حفظ المصروف
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- الشريط الجانبي -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <h1>🏪 نظام إدارة المتجر</h1>
                <p>النظام الاحترافي الشامل</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                        <i class="fas fa-home icon"></i>
                        <span>لوحة التحكم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('products')">
                        <i class="fas fa-box icon"></i>
                        <span>المشتريات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('pos')">
                        <i class="fas fa-cash-register icon"></i>
                        <span>المبيعات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('invoice-inquiry')">
                        <i class="fas fa-search icon"></i>
                        <span>استعلام الفواتير</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('suppliers')">
                        <i class="fas fa-industry icon"></i>
                        <span>الشركات والموردين</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('customers')">
                        <i class="fas fa-users icon"></i>
                        <span>إدارة العملاء</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('expenses')">
                        <i class="fas fa-money-bill-wave icon"></i>
                        <span>إدارة المصروفات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('backup')">
                        <i class="fas fa-cloud-upload-alt icon"></i>
                        <span>النسخ الاحتياطي</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('settings')">
                        <i class="fas fa-cog icon"></i>
                        <span>الإعدادات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('advanced')">
                        <i class="fas fa-plus-circle icon"></i>
                        <span>خيارات أخرى</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="main-content" id="mainContent">
            <!-- رسائل التنبيه -->
            <div id="alertContainer"></div>

            <!-- لوحة التحكم المطورة -->
            <section id="dashboard" class="section active">
                <div class="content-header">
                    <h2><i class="fas fa-tachometer-alt"></i> لوحة التحكم التفاعلية</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="updateDashboard()">
                            <i class="fas fa-sync-alt"></i>
                            تحديث البيانات
                        </button>
                        <button class="btn btn-info" onclick="showDailyReport()">
                            <i class="fas fa-chart-line"></i>
                            التقرير اليومي
                        </button>
                        <button class="btn btn-success" onclick="exportDashboardReport()">
                            <i class="fas fa-download"></i>
                            تصدير التقرير
                        </button>
                        <button class="btn btn-warning" onclick="toggleDashboardMode()">
                            <i class="fas fa-eye"></i>
                            <span id="dashboardModeText">الوضع المبسط</span>
                        </button>
                    </div>
                </div>

                <!-- شريط البحث السريع -->
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div style="flex: 1; position: relative;">
                            <input type="text" id="quickSearch" class="form-control" placeholder="🔍 البحث السريع في النظام (منتجات، عملاء، فواتير...)"
                                   style="padding-right: 40px;" onkeyup="performQuickSearch(this.value)">
                            <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #ccc;"></i>
                        </div>
                        <button class="btn btn-secondary" onclick="showAdvancedSearch()">
                            <i class="fas fa-filter"></i>
                            بحث متقدم
                        </button>
                    </div>
                    <div id="quickSearchResults" style="margin-top: 10px; display: none;"></div>
                </div>

                <!-- مركز التنبيهات والإشعارات -->
                <div id="alertsCenter" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-bell"></i>
                        مركز التنبيهات والإشعارات
                        <span id="alertsCount" class="badge" style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">0</span>
                    </h4>
                    <div id="alertsList"></div>
                </div>

                <!-- إحصائيات سريعة -->
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(40,167,69,0.2), rgba(32,201,151,0.2));">
                        <div class="stat-icon">💰</div>
                        <div class="stat-number" id="totalSales">0.00</div>
                        <div class="stat-label">إجمالي المبيعات اليوم</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));">
                        <div class="stat-icon">📈</div>
                        <div class="stat-number" id="totalProfit">0.00</div>
                        <div class="stat-label">صافي الربح اليوم</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(23,162,184,0.2), rgba(102,126,234,0.2));">
                        <div class="stat-icon">📦</div>
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">إجمالي المنتجات</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(255,193,7,0.2), rgba(253,126,20,0.2));">
                        <div class="stat-icon">⚠️</div>
                        <div class="stat-number" id="lowStockItems">0</div>
                        <div class="stat-label">منتجات منخفضة المخزون</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(220,53,69,0.2), rgba(232,62,140,0.2));">
                        <div class="stat-icon">🚫</div>
                        <div class="stat-number" id="outOfStockItems">0</div>
                        <div class="stat-label">منتجات نفد مخزونها</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(111,66,193,0.2), rgba(102,126,234,0.2));">
                        <div class="stat-icon">💳</div>
                        <div class="stat-number" id="cashBalance">0.00</div>
                        <div class="stat-label">رصيد الخزنة</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(32,201,151,0.2), rgba(23,162,184,0.2));">
                        <div class="stat-icon">👥</div>
                        <div class="stat-number" id="totalCustomers">0</div>
                        <div class="stat-label">إجمالي العملاء</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(253,126,20,0.2), rgba(255,193,7,0.2));">
                        <div class="stat-icon">🏭</div>
                        <div class="stat-number" id="totalSuppliers">0</div>
                        <div class="stat-label">إجمالي الموردين</div>
                    </div>
                </div>

                <!-- تقارير سريعة -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-line"></i>
                            تقرير المبيعات السريع
                        </h3>
                        <div id="quickSalesReport">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>مبيعات اليوم:</span>
                                <span id="todaySales">0.00 ريال</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>مبيعات الأسبوع:</span>
                                <span id="weekSales">0.00 ريال</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>مبيعات الشهر:</span>
                                <span id="monthSales">0.00 ريال</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                                <span>إجمالي المبيعات:</span>
                                <span id="totalAllSales">0.00 ريال</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            تنبيهات المخزون
                        </h3>
                        <div id="stockAlerts">
                            <div style="text-align: center; color: #ccc; padding: 20px;">
                                <i class="fas fa-check-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <p>جميع المنتجات متوفرة</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- أكثر المنتجات مبيعاً -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-trophy"></i>
                        أكثر المنتجات مبيعاً هذا الشهر
                    </h3>
                    <div id="topSellingProducts">
                        <div style="text-align: center; color: #ccc; padding: 20px;">
                            <i class="fas fa-chart-bar" style="font-size: 2em; margin-bottom: 10px;"></i>
                            <p>لا توجد مبيعات بعد</p>
                        </div>
                    </div>
                </div>

                <!-- قسم المخططات البيانية التفاعلية -->
                <div id="chartsSection" style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-pie"></i>
                        المخططات البيانية التفاعلية
                        <button class="btn btn-sm btn-outline-light" onclick="toggleChartsVisibility()" style="margin-right: auto;">
                            <i class="fas fa-eye" id="chartsToggleIcon"></i>
                            <span id="chartsToggleText">إخفاء</span>
                        </button>
                    </h3>

                    <div id="chartsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- مخطط المبيعات الخطي -->
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-chart-line"></i>
                                تطور المبيعات (آخر 7 أيام)
                            </h4>
                            <div class="chart-container">
                                <canvas id="salesLineChart"></canvas>
                            </div>
                        </div>

                        <!-- مخطط توزيع المنتجات الدائري -->
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-chart-pie"></i>
                                توزيع المنتجات حسب الفئة
                            </h4>
                            <div class="chart-container">
                                <canvas id="productsPieChart"></canvas>
                            </div>
                        </div>

                        <!-- مخطط أكثر المنتجات مبيعاً -->
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-chart-bar"></i>
                                أكثر المنتجات مبيعاً
                            </h4>
                            <div class="chart-container">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>

                        <!-- مخطط الأرباح الشهرية -->
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-chart-area"></i>
                                الأرباح الشهرية
                            </h4>
                            <div class="chart-container">
                                <canvas id="profitsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- البيانات اللحظية -->
                <div id="realTimeData" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-broadcast-tower"></i>
                        البيانات اللحظية
                        <span class="live-indicator" style="background: #28a745; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite;"></span>
                    </h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: rgba(40,167,69,0.2); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px;">⏰</div>
                            <div style="font-size: 1.2em; font-weight: bold;" id="currentTime">--:--</div>
                            <div style="font-size: 0.9em; opacity: 0.8;">الوقت الحالي</div>
                        </div>

                        <div style="text-align: center; padding: 15px; background: rgba(23,162,184,0.2); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px;">👥</div>
                            <div style="font-size: 1.2em; font-weight: bold;" id="activeUsers">1</div>
                            <div style="font-size: 0.9em; opacity: 0.8;">المستخدمين النشطين</div>
                        </div>

                        <div style="text-align: center; padding: 15px; background: rgba(102,126,234,0.2); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px;">🛒</div>
                            <div style="font-size: 1.2em; font-weight: bold;" id="todayOrders">0</div>
                            <div style="font-size: 0.9em; opacity: 0.8;">طلبات اليوم</div>
                        </div>

                        <div style="text-align: center; padding: 15px; background: rgba(255,193,7,0.2); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px;">📊</div>
                            <div style="font-size: 1.2em; font-weight: bold;" id="systemLoad">منخفض</div>
                            <div style="font-size: 0.9em; opacity: 0.8;">حمولة النظام</div>
                        </div>
                    </div>
                </div>

                <!-- اختصارات الوصول السريع -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-rocket"></i>
                        اختصارات الوصول السريع
                    </h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <button class="btn btn-outline-light" onclick="showSection('pos')" style="padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <i class="fas fa-cash-register" style="font-size: 1.5em;"></i>
                            <span>نقطة البيع</span>
                        </button>

                        <button class="btn btn-outline-light" onclick="showAddProductModal()" style="padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <i class="fas fa-plus-circle" style="font-size: 1.5em;"></i>
                            <span>إضافة منتج</span>
                        </button>

                        <button class="btn btn-outline-light" onclick="showSection('customers')" style="padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <i class="fas fa-users" style="font-size: 1.5em;"></i>
                            <span>إدارة العملاء</span>
                        </button>

                        <button class="btn btn-outline-light" onclick="showSection('invoice-inquiry')" style="padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <i class="fas fa-search" style="font-size: 1.5em;"></i>
                            <span>استعلام الفواتير</span>
                        </button>

                        <button class="btn btn-outline-light" onclick="showSection('backup')" style="padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 1.5em;"></i>
                            <span>النسخ الاحتياطي</span>
                        </button>

                        <button class="btn btn-outline-light" onclick="showSection('settings')" style="padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <i class="fas fa-cog" style="font-size: 1.5em;"></i>
                            <span>الإعدادات</span>
                        </button>
                    </div>
                </div>

                <!-- نظرة عامة سريعة -->
                <div class="quick-overview">
                    <h3>مرحباً بك في نظام إدارة المتجر الاحترافي المتكامل! 🎉</h3>
                    <p>هذا النظام يوفر لك جميع الأدوات اللازمة لإدارة متجرك بكفاءة عالية مع إمكانيات تخصيص متقدمة.</p>
                    <p>يمكنك الآن:</p>
                    <ul style="margin: 15px 0; padding-right: 20px;">
                        <li>📊 مراقبة الأداء بالمخططات البيانية التفاعلية</li>
                        <li>🔍 البحث السريع في جميع أنحاء النظام</li>
                        <li>🔔 تلقي التنبيهات والإشعارات الذكية</li>
                        <li>⚡ الوصول السريع للوظائف الأكثر استخداماً</li>
                        <li>📱 الاستمتاع بتصميم متجاوب يعمل على جميع الأجهزة</li>
                        <li>💾 حفظ تلقائي لجميع إعداداتك المفضلة</li>
                    </ul>
                    <p>استخدم الشريط الجانبي أو العلوي للتنقل بين الأقسام المختلفة للنظام.</p>
                </div>
            </section>

            <!-- قسم المشتريات -->
            <section id="products" class="section">
                <div class="content-header">
                    <h2>إدارة المشتريات</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i>
                            إضافة منتج جديد
                        </button>
                    </div>
                </div>

                <!-- البحث والتصفية -->
                <div class="search-section" style="margin-bottom: 30px;">
                    <div class="form-group">
                        <input type="text" id="searchProducts" class="form-control" placeholder="البحث في المنتجات (الاسم، الكود، الفئة)..." onkeyup="updateProductsTable()">
                    </div>
                </div>

                <!-- جدول المنتجات -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>اسم المنتج</th>
                                <th>الفئة</th>
                                <th>سعر التكلفة</th>
                                <th>سعر البيع</th>
                                <th>الكمية</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #ccc;">
                                    <i class="fas fa-box" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                    لا توجد منتجات حالياً<br>
                                    <small>انقر على "إضافة منتج جديد" لبدء إضافة المنتجات</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- قسم المبيعات -->
            <section id="pos" class="section">
                <div class="content-header">
                    <h2>نقطة البيع</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="newPOSTransaction()">
                            <i class="fas fa-plus"></i>
                            معاملة جديدة
                        </button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px;">
                    <!-- منطقة المنتجات -->
                    <div>
                        <div class="form-group">
                            <input type="text" id="posSearch" class="form-control" placeholder="البحث عن منتج...">
                        </div>
                        <div id="posProductsGrid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                            gap: 15px;
                            max-height: 500px;
                            overflow-y: auto;
                            padding: 20px;
                            background: rgba(255,255,255,0.05);
                            border-radius: 15px;
                            text-align: center;
                            color: #ccc;
                        ">
                            <div style="grid-column: 1 / -1; padding: 40px;">
                                <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                لا توجد منتجات متاحة للبيع<br>
                                <small>أضف منتجات أولاً من قسم المشتريات</small>
                            </div>
                        </div>
                    </div>

                    <!-- سلة المشتريات -->
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                        <h3>سلة المشتريات</h3>
                        <div id="posCartItems" style="min-height: 200px; margin: 20px 0;">
                            <div style="text-align: center; padding: 40px; color: #ccc;">
                                <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                السلة فارغة
                            </div>
                        </div>
                        <div style="border-top: 2px solid rgba(255,255,255,0.2); padding-top: 15px;">
                            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
                                <span>الإجمالي:</span>
                                <span id="posTotal">0.00 ريال</span>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="completePOSTransaction()" style="width: 100%; margin-top: 15px;">
                            <i class="fas fa-check"></i>
                            إتمام البيع
                        </button>
                    </div>
                </div>
            </section>

            <!-- قسم استعلام الفواتير -->
            <section id="invoice-inquiry" class="section">
                <div class="content-header">
                    <h2><i class="fas fa-search"></i> استعلام الفواتير</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="showCreateDummyInvoiceModal()">
                            <i class="fas fa-file-invoice"></i>
                            فاتورة وهمية
                        </button>
                        <button class="btn btn-success" onclick="exportInvoicesReport()">
                            <i class="fas fa-download"></i>
                            تصدير التقرير
                        </button>
                    </div>
                </div>

                <!-- البحث المتقدم -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">🔍 البحث المتقدم في الفواتير</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>رقم الفاتورة</label>
                            <input type="text" id="searchInvoiceNumber" class="form-control" placeholder="رقم الفاتورة">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>اسم العميل</label>
                            <input type="text" id="searchCustomerName" class="form-control" placeholder="اسم العميل">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>اسم المنتج</label>
                            <input type="text" id="searchProductName" class="form-control" placeholder="اسم المنتج">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>من تاريخ</label>
                            <input type="date" id="searchFromDate" class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>إلى تاريخ</label>
                            <input type="date" id="searchToDate" class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>نوع الفاتورة</label>
                            <select id="searchInvoiceType" class="form-control">
                                <option value="">جميع الأنواع</option>
                                <option value="sale">مبيعات</option>
                                <option value="purchase">مشتريات</option>
                                <option value="dummy">وهمية</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="searchInvoices()">
                            <i class="fas fa-search"></i>
                            بحث
                        </button>
                        <button class="btn btn-secondary" onclick="clearInvoiceSearch()">
                            <i class="fas fa-times"></i>
                            مسح
                        </button>
                    </div>
                </div>

                <!-- نتائج البحث -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>النوع</th>
                                <th>العميل/المورد</th>
                                <th>التاريخ</th>
                                <th>الإجمالي</th>
                                <th>الخصم</th>
                                <th>المبلغ النهائي</th>
                                <th>طريقة الدفع</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 40px; color: #ccc;">
                                    <i class="fas fa-file-invoice" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                    لا توجد فواتير حالياً<br>
                                    <small>ابدأ بإجراء مبيعات أو مشتريات لظهور الفواتير هنا</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- باقي الأقسام -->
            <section id="suppliers" class="section">
                <div class="content-header">
                    <h2><i class="fas fa-industry"></i> الشركات والموردين</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="showSuppliersReport()">
                            <i class="fas fa-chart-bar"></i>
                            تقرير الموردين
                        </button>
                        <button class="btn btn-success" onclick="showAddSupplierModal()">
                            <i class="fas fa-plus"></i>
                            إضافة مورد جديد
                        </button>
                    </div>
                </div>

                <!-- البحث في الموردين -->
                <div class="search-section" style="margin-bottom: 30px;">
                    <div class="form-group">
                        <input type="text" id="searchSuppliers" class="form-control" placeholder="البحث في الموردين (الاسم، الشركة، الهاتف)..." onkeyup="updateSuppliersTable()">
                    </div>
                </div>

                <!-- جدول الموردين -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>اسم المورد</th>
                                <th>اسم الشركة</th>
                                <th>رقم الهاتف</th>
                                <th>العنوان</th>
                                <th>إجمالي المشتريات</th>
                                <th>المبلغ المستحق</th>
                                <th>التقييم</th>
                                <th>آخر تعامل</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 40px; color: #ccc;">
                                    <i class="fas fa-industry" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                    لا توجد موردين حالياً<br>
                                    <small>انقر على "إضافة مورد جديد" لبدء إضافة الموردين</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- إحصائيات الموردين -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-handshake" style="font-size: 2.5em; margin-bottom: 10px; color: var(--success);"></i>
                        <h3 id="activeSuppliersCount">0</h3>
                        <p>موردين نشطين</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-dollar-sign" style="font-size: 2.5em; margin-bottom: 10px; color: var(--warning);"></i>
                        <h3 id="totalSupplierDebt">0.00</h3>
                        <p>إجمالي المستحقات</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-star" style="font-size: 2.5em; margin-bottom: 10px; color: var(--info);"></i>
                        <h3 id="averageSupplierRating">0.0</h3>
                        <p>متوسط التقييم</p>
                    </div>
                </div>
            </section>

            <section id="customers" class="section">
                <div class="content-header">
                    <h2><i class="fas fa-users"></i> إدارة العملاء</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="showCustomersReport()">
                            <i class="fas fa-chart-pie"></i>
                            تقرير العملاء
                        </button>
                        <button class="btn btn-warning" onclick="showDebtorsReport()">
                            <i class="fas fa-exclamation-triangle"></i>
                            المدينين
                        </button>
                        <button class="btn btn-success" onclick="showAddCustomerModal()">
                            <i class="fas fa-plus"></i>
                            إضافة عميل جديد
                        </button>
                    </div>
                </div>

                <!-- البحث والفلترة -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>البحث في العملاء</label>
                            <input type="text" id="searchCustomers" class="form-control" placeholder="البحث (الاسم، الهاتف، العنوان)..." onkeyup="updateCustomersTable()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>نوع العميل</label>
                            <select id="filterCustomerType" class="form-control" onchange="updateCustomersTable()">
                                <option value="">جميع الأنواع</option>
                                <option value="normal">عادي</option>
                                <option value="wholesale">جملة</option>
                                <option value="trader">تاجر</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>حالة الدين</label>
                            <select id="filterDebtStatus" class="form-control" onchange="updateCustomersTable()">
                                <option value="">جميع الحالات</option>
                                <option value="no-debt">لا يوجد دين</option>
                                <option value="has-debt">يوجد دين</option>
                                <option value="overdue">متأخر السداد</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <button class="btn btn-secondary" onclick="clearCustomersFilter()" title="مسح الفلاتر">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- جدول العملاء -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>اسم العميل</th>
                                <th>رقم الهاتف</th>
                                <th>العنوان</th>
                                <th>نوع العميل</th>
                                <th>إجمالي المشتريات</th>
                                <th>الرصيد الآجل</th>
                                <th>آخر شراء</th>
                                <th>نقاط الولاء</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 40px; color: #ccc;">
                                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                    لا توجد عملاء حالياً<br>
                                    <small>انقر على "إضافة عميل جديد" لبدء إضافة العملاء</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- إحصائيات العملاء -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div style="background: rgba(40,167,69,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-user-check" style="font-size: 2.5em; margin-bottom: 10px; color: var(--success);"></i>
                        <h3 id="activeCustomersCount">0</h3>
                        <p>عملاء نشطين</p>
                    </div>
                    <div style="background: rgba(255,193,7,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-money-bill-wave" style="font-size: 2.5em; margin-bottom: 10px; color: var(--warning);"></i>
                        <h3 id="totalCustomerDebt">0.00</h3>
                        <p>إجمالي الديون</p>
                    </div>
                    <div style="background: rgba(220,53,69,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2.5em; margin-bottom: 10px; color: var(--danger);"></i>
                        <h3 id="overdueCustomersCount">0</h3>
                        <p>متأخرين السداد</p>
                    </div>
                    <div style="background: rgba(23,162,184,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-star" style="font-size: 2.5em; margin-bottom: 10px; color: var(--info);"></i>
                        <h3 id="vipCustomersCount">0</h3>
                        <p>عملاء VIP</p>
                    </div>
                    <div style="background: rgba(111,66,193,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-gift" style="font-size: 2.5em; margin-bottom: 10px; color: var(--purple);"></i>
                        <h3 id="totalLoyaltyPoints">0</h3>
                        <p>إجمالي نقاط الولاء</p>
                    </div>
                </div>
            </section>

            <!-- قسم إدارة المصروفات -->
            <section id="expenses" class="section">
                <div class="content-header">
                    <h2><i class="fas fa-money-bill-wave"></i> إدارة المصروفات</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="showExpensesReport()">
                            <i class="fas fa-chart-line"></i>
                            تقرير المصروفات
                        </button>
                        <button class="btn btn-warning" onclick="setBudgetLimit()">
                            <i class="fas fa-piggy-bank"></i>
                            تحديد الميزانية
                        </button>
                        <button class="btn btn-success" onclick="showAddExpenseModal()">
                            <i class="fas fa-plus"></i>
                            إضافة مصروف
                        </button>
                    </div>
                </div>

                <!-- إحصائيات المصروفات -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(220,53,69,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-calendar-day" style="font-size: 2.5em; margin-bottom: 10px; color: var(--danger);"></i>
                        <h3 id="todayExpenses">0.00</h3>
                        <p>مصروفات اليوم</p>
                    </div>
                    <div style="background: rgba(255,193,7,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-calendar-week" style="font-size: 2.5em; margin-bottom: 10px; color: var(--warning);"></i>
                        <h3 id="weekExpenses">0.00</h3>
                        <p>مصروفات الأسبوع</p>
                    </div>
                    <div style="background: rgba(23,162,184,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-calendar-alt" style="font-size: 2.5em; margin-bottom: 10px; color: var(--info);"></i>
                        <h3 id="monthExpenses">0.00</h3>
                        <p>مصروفات الشهر</p>
                    </div>
                    <div style="background: rgba(111,66,193,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-chart-line" style="font-size: 2.5em; margin-bottom: 10px; color: var(--purple);"></i>
                        <h3 id="totalExpenses">0.00</h3>
                        <p>إجمالي المصروفات</p>
                    </div>
                </div>

                <!-- الميزانية والتنبيهات -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">💰 حالة الميزانية</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>الميزانية الشهرية:</span>
                                <span id="monthlyBudget">غير محددة</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>المصروف حتى الآن:</span>
                                <span id="currentMonthExpenses">0.00 ريال</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>المتبقي:</span>
                                <span id="remainingBudget">0.00 ريال</span>
                            </div>
                        </div>
                        <div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>نسبة الاستهلاك:</span>
                                    <span id="budgetUsagePercentage">0%</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); height: 10px; border-radius: 5px; overflow: hidden;">
                                    <div id="budgetUsageBar" style="height: 100%; background: var(--success); width: 0%; transition: all 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- البحث والفلترة -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>البحث في المصروفات</label>
                            <input type="text" id="searchExpenses" class="form-control" placeholder="البحث (الوصف، الملاحظات)..." onkeyup="updateExpensesTable()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>نوع المصروف</label>
                            <select id="filterExpenseType" class="form-control" onchange="updateExpensesTable()">
                                <option value="">جميع الأنواع</option>
                                <option value="operational">تشغيلي</option>
                                <option value="maintenance">صيانة</option>
                                <option value="marketing">تسويق</option>
                                <option value="utilities">مرافق</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>من تاريخ</label>
                            <input type="date" id="filterExpenseFromDate" class="form-control" onchange="updateExpensesTable()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>إلى تاريخ</label>
                            <input type="date" id="filterExpenseToDate" class="form-control" onchange="updateExpensesTable()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <button class="btn btn-secondary" onclick="clearExpensesFilter()" title="مسح الفلاتر">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- جدول المصروفات -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>نوع المصروف</th>
                                <th>الوصف</th>
                                <th>المبلغ</th>
                                <th>طريقة الدفع</th>
                                <th>الملاحظات</th>
                                <th>المسؤول</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #ccc;">
                                    <i class="fas fa-money-bill-wave" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                    لا توجد مصروفات مسجلة<br>
                                    <small>انقر على "إضافة مصروف" لبدء تسجيل المصروفات</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- قسم النسخ الاحتياطي والمزامنة -->
            <section id="backup" class="section">
                <div class="content-header">
                    <h2><i class="fas fa-cloud-upload-alt"></i> النسخ الاحتياطي والمزامنة</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="checkBackupStatus()">
                            <i class="fas fa-sync-alt"></i>
                            تحديث الحالة
                        </button>
                        <button class="btn btn-success" onclick="createManualBackup()">
                            <i class="fas fa-save"></i>
                            نسخة احتياطية يدوية
                        </button>
                    </div>
                </div>

                <!-- حالة النسخ الاحتياطي -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(40,167,69,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-clock" style="font-size: 2.5em; margin-bottom: 10px; color: var(--success);"></i>
                        <h3 id="lastBackupTime">لم يتم إنشاء نسخة</h3>
                        <p>آخر نسخة احتياطية</p>
                    </div>
                    <div style="background: rgba(23,162,184,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-database" style="font-size: 2.5em; margin-bottom: 10px; color: var(--info);"></i>
                        <h3 id="backupSize">0 KB</h3>
                        <p>حجم البيانات</p>
                    </div>
                    <div style="background: rgba(111,66,193,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-cloud" style="font-size: 2.5em; margin-bottom: 10px; color: var(--purple);"></i>
                        <h3 id="cloudSyncStatus">غير متصل</h3>
                        <p>حالة المزامنة السحابية</p>
                    </div>
                    <div style="background: rgba(255,193,7,0.2); padding: 20px; border-radius: 15px; text-align: center;">
                        <i class="fas fa-shield-alt" style="font-size: 2.5em; margin-bottom: 10px; color: var(--warning);"></i>
                        <h3 id="backupCount">0</h3>
                        <p>عدد النسخ المحفوظة</p>
                    </div>
                </div>

                <!-- إعدادات النسخ الاحتياطي -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">⚙️ إعدادات النسخ الاحتياطي</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4 style="margin-bottom: 15px;">النسخ التلقائي</h4>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="autoBackupEnabled" onchange="toggleAutoBackup()">
                                    <span>تفعيل النسخ التلقائي</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label>تكرار النسخ</label>
                                <select id="backupFrequency" class="form-control" onchange="updateBackupSettings()">
                                    <option value="6">كل 6 ساعات</option>
                                    <option value="12" selected>كل 12 ساعة</option>
                                    <option value="24">يومياً</option>
                                    <option value="168">أسبوعياً</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>عدد النسخ المحفوظة</label>
                                <input type="number" id="maxBackupCount" class="form-control" value="10" min="1" max="50" onchange="updateBackupSettings()">
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px;">المزامنة السحابية</h4>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="cloudSyncEnabled" onchange="toggleCloudSync()">
                                    <span>تفعيل المزامنة السحابية</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label>خدمة التخزين السحابي</label>
                                <select id="cloudProvider" class="form-control" onchange="updateCloudSettings()">
                                    <option value="google">Google Drive</option>
                                    <option value="firebase">Firebase</option>
                                    <option value="dropbox">Dropbox</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="emailBackupEnabled" onchange="toggleEmailBackup()">
                                    <span>إرسال نسخة للبريد الإلكتروني</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label>البريد الإلكتروني</label>
                                <input type="email" id="backupEmail" class="form-control" placeholder="your@email.com" onchange="updateBackupSettings()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- إدارة النسخ الاحتياطية -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">📁 إدارة النسخ الاحتياطية</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="btn btn-primary" onclick="exportDataAsJSON()">
                            <i class="fas fa-download"></i>
                            تصدير البيانات (JSON)
                        </button>
                        <button class="btn btn-info" onclick="exportDataAsExcel()">
                            <i class="fas fa-file-excel"></i>
                            تصدير إلى Excel
                        </button>
                        <button class="btn btn-warning" onclick="showImportDataModal()">
                            <i class="fas fa-upload"></i>
                            استيراد البيانات
                        </button>
                        <button class="btn btn-success" onclick="syncWithCloud()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            مزامنة مع السحابة
                        </button>
                        <button class="btn btn-secondary" onclick="showRestoreModal()">
                            <i class="fas fa-undo"></i>
                            استعادة نسخة
                        </button>
                        <button class="btn btn-danger" onclick="cleanupOldBackups()">
                            <i class="fas fa-trash-alt"></i>
                            تنظيف النسخ القديمة
                        </button>
                    </div>
                </div>

                <!-- سجل النسخ الاحتياطية -->
                <div class="table-container">
                    <h3 style="margin-bottom: 15px;">📋 سجل النسخ الاحتياطية</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ والوقت</th>
                                <th>النوع</th>
                                <th>الحجم</th>
                                <th>الحالة</th>
                                <th>الموقع</th>
                                <th>الملاحظات</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="backupLogTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #ccc;">
                                    <i class="fas fa-history" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                    لا توجد نسخ احتياطية<br>
                                    <small>انقر على "نسخة احتياطية يدوية" لإنشاء أول نسخة</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="settings" class="section">
                <div class="content-header">
                    <h2><i class="fas fa-cog"></i> إعدادات النظام</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="resetToDefaults()">
                            <i class="fas fa-undo"></i>
                            إعادة تعيين
                        </button>
                        <button class="btn btn-success" onclick="saveSettings()">
                            <i class="fas fa-save"></i>
                            حفظ الإعدادات
                        </button>
                    </div>
                </div>

                <!-- الإعدادات العامة -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">🏪 الإعدادات العامة</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>اسم المتجر</label>
                            <input type="text" id="storeName" class="form-control" placeholder="اسم المتجر" value="متجري الاحترافي">
                        </div>
                        <div class="form-group">
                            <label>عملة النظام</label>
                            <select id="currency" class="form-control">
                                <option value="ريال" selected>ريال سعودي</option>
                                <option value="درهم">درهم إماراتي</option>
                                <option value="دينار">دينار كويتي</option>
                                <option value="جنيه">جنيه مصري</option>
                                <option value="دولار">دولار أمريكي</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>حد المخزون المنخفض</label>
                            <input type="number" id="lowStockThreshold" class="form-control" placeholder="10" value="10" min="1">
                        </div>
                        <div class="form-group">
                            <label>نسبة الضريبة (%)</label>
                            <input type="number" id="taxRate" class="form-control" placeholder="0" value="0" min="0" max="100" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- إعدادات الأفكار السريعة -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">💡 إعدادات الأفكار السريعة</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; opacity: 0.6;">
                                    <input type="checkbox" id="enableQuickIdeas" onchange="toggleQuickIdeasFromSettings()" disabled>
                                    <span>تفعيل الأفكار السريعة (مخفية دائماً)</span>
                                </label>
                                <small style="color: rgba(255,255,255,0.7);">الأفكار السريعة مخفية دائماً. استخدم الزر الخارجي للوصول إليها</small>
                            </div>

                            <div class="form-group">
                                <label>موضع الأفكار السريعة:</label>
                                <select id="quickIdeasPosition" onchange="updateQuickIdeasPosition()" class="form-control">
                                    <option value="bottom-left">أسفل اليسار</option>
                                    <option value="bottom-right">أسفل اليمين</option>
                                    <option value="top-left">أعلى اليسار</option>
                                    <option value="top-right">أعلى اليمين</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>حجم الأفكار السريعة:</label>
                                <select id="quickIdeasSize" onchange="updateQuickIdeasSize()" class="form-control">
                                    <option value="small">صغير</option>
                                    <option value="medium">متوسط</option>
                                    <option value="large">كبير</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>شفافية الأفكار السريعة: <span id="quickIdeasOpacityValue">0.95</span></label>
                                <input type="range" id="quickIdeasOpacity" min="0.3" max="1" step="0.1" value="0.95" onchange="updateQuickIdeasOpacity()" class="form-control">
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="quickIdeasAutoCollapse" onchange="toggleQuickIdeasAutoCollapse()">
                                    <span>طي تلقائي عند بدء التشغيل</span>
                                </label>
                                <small style="color: rgba(255,255,255,0.7);">طي نافذة الأفكار السريعة تلقائياً عند تحميل الصفحة</small>
                            </div>

                            <div class="form-group">
                                <button onclick="showQuickIdeasManager()" class="btn btn-primary" style="width: 100%;">
                                    <i class="fas fa-cog"></i> إدارة الأفكار السريعة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- إعدادات التأثيرات والحركة -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">🎭 إعدادات التأثيرات والحركة</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableAnimations" onchange="toggleAnimations()">
                                    <span>تفعيل التأثيرات الحركية</span>
                                </label>
                                <small style="color: #ccc;">تشغيل/إيقاف جميع التأثيرات المتحركة</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableParticles" onchange="toggleParticles()">
                                    <span>تفعيل نظام الجسيمات</span>
                                </label>
                                <small style="color: #ccc;">الجسيمات المتحركة في الخلفية</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableMouseEffects" onchange="toggleMouseEffects()">
                                    <span>تفعيل تأثيرات الماوس</span>
                                </label>
                                <small style="color: #ccc;">تتبع الماوس والتأثيرات الضوئية</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableSoundEffects" onchange="toggleSoundEffects()">
                                    <span>تفعيل التأثيرات الصوتية</span>
                                </label>
                                <small style="color: #ccc;">أصوات النقر والإشعارات</small>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableGlowEffects" onchange="toggleGlowEffects()">
                                    <span>تفعيل تأثيرات التوهج</span>
                                </label>
                                <small style="color: #ccc;">الظلال المضيئة والتوهج</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableHologramEffects" onchange="toggleHologramEffects()">
                                    <span>تفعيل تأثيرات الهولوجرام</span>
                                </label>
                                <small style="color: #ccc;">التأثيرات الهولوجرامية للبطاقات</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableDynamicColors" onchange="toggleDynamicColors()">
                                    <span>تفعيل الألوان الديناميكية</span>
                                </label>
                                <small style="color: #ccc;">تغيير الألوان التلقائي</small>
                            </div>
                            <div class="form-group">
                                <label>سرعة التأثيرات</label>
                                <select id="animationSpeed" class="form-control" onchange="changeAnimationSpeed()">
                                    <option value="slow">بطيء</option>
                                    <option value="normal" selected>عادي</option>
                                    <option value="fast">سريع</option>
                                </select>
                                <small style="color: #ccc;">اضبط سرعة التأثيرات الحركية</small>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button onclick="resetEffectsToDefault()" class="btn btn-warning" style="margin-left: 10px;">
                            <i class="fas fa-undo"></i> استعادة الافتراضي
                        </button>
                        <button onclick="disableAllEffects()" class="btn btn-danger" style="margin-left: 10px;">
                            <i class="fas fa-ban"></i> إيقاف جميع التأثيرات
                        </button>
                        <button onclick="enableAllEffects()" class="btn btn-success">
                            <i class="fas fa-magic"></i> تفعيل جميع التأثيرات
                        </button>
                    </div>
                </div>

                <!-- إعدادات العملاء والخصومات -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">👥 إعدادات العملاء والخصومات</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>خصم العميل العادي (%)</label>
                            <input type="number" id="normalCustomerDiscount" class="form-control" placeholder="0" value="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>خصم عميل الجملة (%)</label>
                            <input type="number" id="wholesaleCustomerDiscount" class="form-control" placeholder="5" value="5" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>خصم العميل التاجر (%)</label>
                            <input type="number" id="traderCustomerDiscount" class="form-control" placeholder="10" value="10" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>نقاط الولاء لكل ريال</label>
                            <input type="number" id="loyaltyPointsPerRiyal" class="form-control" placeholder="1" value="1" min="0" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- إعدادات الفواتير -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">📄 إعدادات الفواتير</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableWhatsAppSend" checked>
                                    <span>تفعيل إرسال الفواتير عبر واتساب</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableAutoPrint" checked>
                                    <span>طباعة تلقائية للفواتير</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableInvoiceNumbers" checked>
                                    <span>ترقيم تلقائي للفواتير</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>رسالة واتساب مع الفاتورة</label>
                                <textarea id="whatsappMessage" class="form-control" rows="3" placeholder="شكراً لتعاملكم معنا...">شكراً لتعاملكم معنا. إليكم فاتورة مشترياتكم.</textarea>
                            </div>
                            <div class="form-group">
                                <label>بادئة رقم الفاتورة</label>
                                <input type="text" id="invoicePrefix" class="form-control" placeholder="INV" value="INV">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- إعدادات الأفكار السريعة -->
                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="margin-bottom: 20px; color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">💡 إعدادات الأفكار السريعة</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableQuickIdeas" checked onchange="toggleQuickIdeasVisibility()">
                                    <span>تفعيل الأفكار السريعة</span>
                                </label>
                                <small style="color: rgba(255,255,255,0.8);">إظهار/إخفاء أداة الأفكار السريعة نهائياً</small>
                            </div>
                            <div class="form-group">
                                <label>موضع الأداة</label>
                                <select id="quickIdeasPosition" class="form-control" onchange="changeQuickIdeasPosition()">
                                    <option value="bottom-left">أسفل اليسار</option>
                                    <option value="bottom-right">أسفل اليمين</option>
                                    <option value="top-left">أعلى اليسار</option>
                                    <option value="top-right">أعلى اليمين</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="autoCollapseQuickIdeas" onchange="saveQuickIdeasSettings()">
                                    <span>طي تلقائي عند بدء التشغيل</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>حجم الأداة</label>
                                <select id="quickIdeasSize" class="form-control" onchange="changeQuickIdeasSize()">
                                    <option value="small">صغير</option>
                                    <option value="medium" selected>متوسط</option>
                                    <option value="large">كبير</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>شفافية الأداة</label>
                                <input type="range" id="quickIdeasOpacity" class="form-control" min="0.3" max="1" step="0.1" value="0.95" onchange="changeQuickIdeasOpacity()">
                                <small style="color: rgba(255,255,255,0.8);">اضبط شفافية خلفية الأداة</small>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-info" onclick="showQuickIdeasManager()" style="width: 100%;">
                                    <i class="fas fa-cog"></i>
                                    إدارة الأفكار المخصصة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- إعدادات المنتجات -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">📦 إعدادات المنتجات</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group">
                                <label>الوحدة الافتراضية</label>
                                <select id="defaultUnit" class="form-control">
                                    <option value="قطعة" selected>قطعة</option>
                                    <option value="متر">متر</option>
                                    <option value="كرتونة">كرتونة</option>
                                    <option value="كيلو">كيلو</option>
                                    <option value="لتر">لتر</option>
                                    <option value="عبوة">عبوة</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableBarcodeGeneration">
                                    <span>إنشاء باركود تلقائي</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableStockAlerts" checked>
                                    <span>تنبيهات المخزون</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>أقسام المنتجات (مفصولة بفاصلة)</label>
                                <textarea id="productCategories" class="form-control" rows="3" placeholder="إلكترونيات، أسلاك، لمبات...">إلكترونيات، أسلاك، لمبات، أدوات، أخرى</textarea>
                            </div>
                            <div class="form-group">
                                <label>وحدات القياس (مفصولة بفاصلة)</label>
                                <textarea id="measurementUnits" class="form-control" rows="2" placeholder="قطعة، متر، كرتونة...">قطعة، متر، كرتونة، كيلو، لتر، عبوة</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- إعدادات التخزين المحلي -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">💾 إعدادات التخزين المحلي</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="btn btn-info" onclick="analyzeLocalStorage()">
                            <i class="fas fa-chart-pie"></i>
                            تحليل البيانات
                        </button>
                        <button class="btn btn-warning" onclick="repairLocalStorage()">
                            <i class="fas fa-wrench"></i>
                            إصلاح البيانات
                        </button>
                        <button class="btn btn-secondary" onclick="cleanupLocalStorage()">
                            <i class="fas fa-broom"></i>
                            تنظيف البيانات
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            <i class="fas fa-trash-alt"></i>
                            حذف جميع البيانات
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>حجم البيانات المستخدم:</span>
                            <span id="storageUsed">0 KB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>عدد المنتجات:</span>
                            <span id="productsCount">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>عدد الفواتير:</span>
                            <span id="invoicesCount">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>آخر تحديث:</span>
                            <span id="lastDataUpdate">غير محدد</span>
                        </div>
                    </div>
                </div>

                <!-- إعدادات التخصيص -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                    <h3 style="margin-bottom: 20px; color: #fff;">🎨 إعدادات التخصيص</h3>
                    <p style="color: #ccc; margin-bottom: 20px;">
                        استخدم زر التخصيص (أيقونة الألوان) في الزاوية العلوية اليسرى للوصول إلى جميع خيارات التخصيص المتقدمة.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-palette" style="font-size: 2em; margin-bottom: 10px; color: var(--primary);"></i>
                            <h4>الثيمات</h4>
                            <p style="font-size: 0.9em; opacity: 0.8;">3 ثيمات مختلفة</p>
                        </div>
                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-text-height" style="font-size: 2em; margin-bottom: 10px; color: var(--success);"></i>
                            <h4>أحجام الخط</h4>
                            <p style="font-size: 0.9em; opacity: 0.8;">صغير، متوسط، كبير</p>
                        </div>
                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-bars" style="font-size: 2em; margin-bottom: 10px; color: var(--warning);"></i>
                            <h4>أنماط التنقل</h4>
                            <p style="font-size: 0.9em; opacity: 0.8;">جانبي أو علوي</p>
                        </div>
                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-expand" style="font-size: 2em; margin-bottom: 10px; color: var(--info);"></i>
                            <h4>أوضاع العرض</h4>
                            <p style="font-size: 0.9em; opacity: 0.8;">مضغوط وملء الشاشة</p>
                        </div>
                    </div>
                </div>
            </section>
            <!-- قسم الخيارات الأخرى (الميزات المتقدمة) -->
            <section id="advanced" class="section">
                <div class="content-header">
                    <h2><i class="fas fa-plus-circle"></i> خيارات أخرى - الميزات المتقدمة</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="showSystemInfo()">
                            <i class="fas fa-info-circle"></i>
                            معلومات النظام
                        </button>
                    </div>
                </div>

                <!-- نظام صلاحيات المستخدمين -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">👤 نظام صلاحيات المستخدمين</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showAddUserModal()">
                            <i class="fas fa-user-plus"></i>
                            إضافة مستخدم جديد
                        </button>
                        <button class="btn btn-info" onclick="showUsersManagement()">
                            <i class="fas fa-users-cog"></i>
                            إدارة المستخدمين
                        </button>
                        <button class="btn btn-warning" onclick="showPermissionsMatrix()">
                            <i class="fas fa-key"></i>
                            مصفوفة الصلاحيات
                        </button>
                        <button class="btn btn-secondary" onclick="showActivityLog()">
                            <i class="fas fa-history"></i>
                            سجل النشاطات
                        </button>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px;">أنواع المستخدمين:</h4>
                        <ul style="margin: 0; padding-right: 20px;">
                            <li><strong>مدير:</strong> صلاحيات كاملة على جميع الأقسام</li>
                            <li><strong>كاشير:</strong> المبيعات والاستعلامات فقط</li>
                            <li><strong>محاسب:</strong> التقارير والمالية فقط</li>
                            <li><strong>مخزني:</strong> المشتريات والمخزون فقط</li>
                        </ul>
                    </div>
                </div>

                <!-- تحليل الأداء الذكي -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">🧠 تحليل الأداء الذكي</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="generateSmartRecommendations()">
                            <i class="fas fa-lightbulb"></i>
                            توصيات ذكية
                        </button>
                        <button class="btn btn-info" onclick="analyzeSalesTrends()">
                            <i class="fas fa-chart-line"></i>
                            تحليل اتجاهات المبيعات
                        </button>
                        <button class="btn btn-warning" onclick="predictStockNeeds()">
                            <i class="fas fa-crystal-ball"></i>
                            توقع احتياجات المخزون
                        </button>
                        <button class="btn btn-success" onclick="findProfitableProducts()">
                            <i class="fas fa-dollar-sign"></i>
                            المنتجات الأكثر ربحية
                        </button>
                        <button class="btn btn-info" onclick="analyzeKeywords()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            <i class="fas fa-search"></i>
                            تحليل الكلمات المفتاحية
                        </button>
                        <button class="btn btn-warning" onclick="analyzeCustomerBehavior()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;">
                            <i class="fas fa-users"></i>
                            تحليل سلوك العملاء
                        </button>
                        <button class="btn btn-success" onclick="showTextAnalyzer()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none;">
                            <i class="fas fa-spell-check"></i>
                            محلل النصوص الذكي
                        </button>
                    </div>
                    <div id="smartAnalysisResults" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <p style="text-align: center; color: #ccc;">انقر على أي من الأزرار أعلاه لبدء التحليل الذكي</p>
                    </div>
                </div>

                <!-- نظام نقاط الولاء -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">🎁 نظام نقاط الولاء</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-bottom: 15px;">إعدادات النقاط</h4>
                            <div class="form-group">
                                <label>نقاط لكل ريال مُنفق</label>
                                <input type="number" id="pointsPerRiyal" class="form-control" value="1" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>قيمة النقطة الواحدة (ريال)</label>
                                <input type="number" id="pointValue" class="form-control" value="0.1" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>الحد الأدنى للاستبدال</label>
                                <input type="number" id="minRedemptionPoints" class="form-control" value="100" min="1">
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px;">مستويات العضوية</h4>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <div style="margin-bottom: 10px;">
                                    <strong>برونزي:</strong> 0 - 999 نقطة (خصم 2%)
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>فضي:</strong> 1000 - 4999 نقطة (خصم 5%)
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>ذهبي:</strong> 5000 - 9999 نقطة (خصم 8%)
                                </div>
                                <div>
                                    <strong>بلاتيني:</strong> 10000+ نقطة (خصم 12%)
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-success" onclick="saveLoyaltySettings()">
                            <i class="fas fa-save"></i>
                            حفظ إعدادات الولاء
                        </button>
                    </div>
                </div>

                <!-- تقارير مخصصة -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">📊 تقارير مخصصة</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="createCustomReport()">
                            <i class="fas fa-plus"></i>
                            إنشاء تقرير مخصص
                        </button>
                        <button class="btn btn-info" onclick="showSavedReports()">
                            <i class="fas fa-folder-open"></i>
                            التقارير المحفوظة
                        </button>
                        <button class="btn btn-success" onclick="exportReportToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            تصدير PDF
                        </button>
                        <button class="btn btn-warning" onclick="exportReportToExcel()">
                            <i class="fas fa-file-excel"></i>
                            تصدير Excel
                        </button>
                        <button class="btn btn-secondary" onclick="scheduleReport()">
                            <i class="fas fa-clock"></i>
                            جدولة التقرير
                        </button>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px;">أنواع التقارير المتاحة:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div>• تقرير المبيعات حسب الفترة</div>
                            <div>• تقرير أداء المنتجات</div>
                            <div>• تقرير العملاء الأكثر شراءً</div>
                            <div>• تقرير الموردين</div>
                            <div>• تقرير الأرباح والخسائر</div>
                            <div>• تقرير حركة المخزون</div>
                        </div>
                    </div>
                </div>

                <!-- التنبيهات الذكية -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">🔔 التنبيهات الذكية</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-bottom: 15px;">إعدادات التنبيهات</h4>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableStockAlerts" checked>
                                    <span>تنبيهات المخزون المنخفض</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableCashAlerts" checked>
                                    <span>تنبيهات انخفاض رصيد الخزنة</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableDebtAlerts" checked>
                                    <span>تنبيهات تأخر السداد</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableExpenseAlerts">
                                    <span>تنبيهات تجاوز الميزانية</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px;">طرق الإرسال</h4>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableAppNotifications" checked>
                                    <span>إشعارات داخل التطبيق</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableWhatsAppAlerts">
                                    <span>إرسال عبر واتساب</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableEmailAlerts">
                                    <span>إرسال عبر البريد الإلكتروني</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label>رقم واتساب للتنبيهات</label>
                                <input type="tel" id="alertsWhatsAppNumber" class="form-control" placeholder="+966xxxxxxxxx">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- أرشفة الفواتير -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">📁 أرشفة الفواتير</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-info" onclick="showArchiveSettings()">
                            <i class="fas fa-cog"></i>
                            إعدادات الأرشفة
                        </button>
                        <button class="btn btn-warning" onclick="archiveOldInvoices()">
                            <i class="fas fa-archive"></i>
                            أرشفة الفواتير القديمة
                        </button>
                        <button class="btn btn-secondary" onclick="viewArchivedInvoices()">
                            <i class="fas fa-folder-open"></i>
                            عرض المؤرشف
                        </button>
                        <button class="btn btn-success" onclick="restoreFromArchive()">
                            <i class="fas fa-undo"></i>
                            استعادة من الأرشيف
                        </button>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>الفواتير النشطة:</span>
                            <span id="activeInvoicesCount">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>الفواتير المؤرشفة:</span>
                            <span id="archivedInvoicesCount">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>توفير في المساحة:</span>
                            <span id="spaceSaved">0 KB</span>
                        </div>
                    </div>
                </div>

                <!-- اختبار النظام -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">🧪 اختبار النظام</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="runSystemTests()">
                            <i class="fas fa-play-circle"></i>
                            اختبار شامل للنظام
                        </button>
                        <button class="btn btn-info" onclick="IntegrationTester.testFullSaleScenario()">
                            <i class="fas fa-shopping-cart"></i>
                            اختبار سيناريو البيع
                        </button>
                        <button class="btn btn-warning" onclick="IntegrationTester.testExpenseScenario()">
                            <i class="fas fa-money-bill-wave"></i>
                            اختبار المصروفات
                        </button>
                        <button class="btn btn-success" onclick="validateSystemIntegrity()">
                            <i class="fas fa-shield-alt"></i>
                            فحص سلامة البيانات
                        </button>
                        <button class="btn btn-secondary" onclick="SystemIntegrityChecker.performFullSystemCheck()">
                            <i class="fas fa-search"></i>
                            فحص شامل للنظام
                        </button>
                        <button class="btn btn-info" onclick="PerformanceMonitor.showPerformanceReport()">
                            <i class="fas fa-tachometer-alt"></i>
                            تقرير الأداء
                        </button>
                        <button class="btn btn-primary" onclick="SectionConnectivityChecker.checkSectionConnectivity()">
                            <i class="fas fa-link"></i>
                            فحص الاتصال بين الأقسام
                        </button>
                        <button class="btn btn-secondary" onclick="ActivityLogger.showActivityLog()">
                            <i class="fas fa-list-alt"></i>
                            سجل الأنشطة
                        </button>
                        <button class="btn btn-danger" onclick="ErrorHandler.showErrorReport()">
                            <i class="fas fa-exclamation-triangle"></i>
                            تقرير الأخطاء
                        </button>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px;">معلومات الاختبار:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <div>✅ اختبار التكامل بين الأقسام</div>
                                <div>✅ اختبار صحة البيانات</div>
                                <div>✅ اختبار العمليات المالية</div>
                            </div>
                            <div>
                                <div>✅ اختبار الخصومات والحسابات</div>
                                <div>✅ اختبار إدارة المخزون</div>
                                <div>✅ اختبار الإشعارات والتنبيهات</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- دعم مدمج -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                    <h3 style="margin-bottom: 20px;">🆘 الدعم المدمج</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="contactSupport()">
                            <i class="fas fa-headset"></i>
                            اتصل بالدعم
                        </button>
                        <button class="btn btn-info" onclick="showUserGuide()">
                            <i class="fas fa-book"></i>
                            دليل المستخدم
                        </button>
                        <button class="btn btn-warning" onclick="reportBug()">
                            <i class="fas fa-bug"></i>
                            بلاغ عن خطأ
                        </button>
                        <button class="btn btn-success" onclick="requestFeature()">
                            <i class="fas fa-lightbulb"></i>
                            طلب ميزة جديدة
                        </button>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px;">معلومات النظام:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <div>الإصدار: 2.0.0</div>
                                <div>تاريخ الإصدار: 2024-01-15</div>
                                <div>المطور: فريق التطوير</div>
                            </div>
                            <div>
                                <div>آخر تحديث: منذ 3 أيام</div>
                                <div>حالة الترخيص: مفعل</div>
                                <div>الدعم: متاح 24/7</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- نافذة إدارة الأفكار السريعة -->
    <div class="modal" id="quickIdeasManagerModal">
        <div class="modal-content" style="max-width: 600px; margin: 3% auto; background: linear-gradient(135deg, #1a237e 0%, #3f51b5 100%); border-radius: 20px; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <h3 class="modal-title" style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-cog"></i>
                    إدارة الأفكار السريعة
                </h3>
                <button class="modal-close" onclick="closeModal('quickIdeasManagerModal')" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px; background: linear-gradient(135deg, #1a237e 0%, #3f51b5 100%); color: white;">
                <!-- قائمة الأفكار الحالية -->
                <div style="margin-bottom: 25px;">
                    <h5 style="color: #ffffff; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                        <i class="fas fa-list"></i>
                        الأفكار الحالية
                    </h5>
                    <div id="currentIdeasList" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 10px; background: rgba(255,255,255,0.1);">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>

                <!-- إضافة فكرة جديدة -->
                <div style="background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.1)); padding: 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3);">
                    <h5 style="color: #ffffff; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                        <i class="fas fa-plus"></i>
                        إضافة فكرة جديدة
                    </h5>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #ffffff; margin-bottom: 5px; display: block; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">العنوان</label>
                        <input type="text" id="newIdeaTitle" class="form-control" placeholder="مثال: إضافة عميل جديد"
                               style="border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 10px; background: rgba(255,255,255,0.9); color: #333;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #ffffff; margin-bottom: 5px; display: block; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">الوصف</label>
                        <input type="text" id="newIdeaDescription" class="form-control" placeholder="مثال: إضافة عميل جديد للنظام"
                               style="border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 10px; background: rgba(255,255,255,0.9); color: #333;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #ffffff; margin-bottom: 5px; display: block; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">الإجراء</label>
                        <select id="newIdeaAction" class="form-control" onchange="updateFunctionField()"
                                style="border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 10px; background: rgba(255,255,255,0.9); color: #333;">
                            <option value="">اختر الإجراء</option>

                            <!-- الأقسام الرئيسية -->
                            <optgroup label="الأقسام الرئيسية">
                                <option value="showSection('dashboard')">📊 لوحة التحكم</option>
                                <option value="showSection('pos')">🛒 نقطة البيع</option>
                                <option value="showSection('products')">📦 إدارة المنتجات</option>
                                <option value="showSection('customers')">👥 إدارة العملاء</option>
                                <option value="showSection('suppliers')">🏪 إدارة الموردين</option>
                                <option value="showSection('expenses')">💰 إدارة المصروفات</option>
                                <option value="showSection('reports')">📈 التقارير</option>
                                <option value="showSection('settings')">⚙️ الإعدادات</option>
                            </optgroup>

                            <!-- إضافة عناصر جديدة -->
                            <optgroup label="إضافة جديد">
                                <option value="showAddProductModal()">➕ إضافة منتج جديد</option>
                                <option value="showAddCustomerModal()">👤 إضافة عميل جديد</option>
                                <option value="showAddSupplierModal()">🏢 إضافة مورد جديد</option>
                                <option value="showAddExpenseModal()">💸 إضافة مصروف جديد</option>
                                <option value="showAddCategoryModal()">📂 إضافة فئة جديدة</option>
                            </optgroup>

                            <!-- عمليات سريعة -->
                            <optgroup label="عمليات سريعة">
                                <option value="showQuickSaleModal()">⚡ بيع سريع</option>
                                <option value="showQuickPurchaseModal()">🛍️ شراء سريع</option>
                                <option value="showInventoryCheckModal()">📋 جرد سريع</option>
                                <option value="showDailyReportModal()">📊 تقرير يومي</option>
                                <option value="showCashCountModal()">💵 عد النقدية</option>
                            </optgroup>

                            <!-- البيانات والتقارير -->
                            <optgroup label="البيانات والتقارير">
                                <option value="exportData()">📤 تصدير البيانات</option>
                                <option value="importData()">📥 استيراد البيانات</option>
                                <option value="generateSalesReport()">📈 تقرير المبيعات</option>
                                <option value="generateInventoryReport()">📦 تقرير المخزون</option>
                                <option value="generateProfitReport()">💰 تقرير الأرباح</option>
                                <option value="backupData()">💾 نسخ احتياطي</option>
                            </optgroup>

                            <!-- أدوات مساعدة -->
                            <optgroup label="أدوات مساعدة">
                                <option value="showCalculatorModal()">🧮 آلة حاسبة</option>
                                <option value="showNotesModal()">📝 ملاحظات سريعة</option>
                                <option value="showHelpModal()">❓ المساعدة</option>
                                <option value="showShortcutsModal()">⌨️ اختصارات لوحة المفاتيح</option>
                                <option value="toggleFullscreen()">🖥️ ملء الشاشة</option>
                            </optgroup>

                            <!-- إجراءات النظام -->
                            <optgroup label="إجراءات النظام">
                                <option value="clearCache()">🗑️ مسح التخزين المؤقت</option>
                                <option value="resetSettings()">🔄 إعادة تعيين الإعدادات</option>
                                <option value="showSystemInfo()">ℹ️ معلومات النظام</option>
                                <option value="checkForUpdates()">🔄 فحص التحديثات</option>
                            </optgroup>

                            <option value="custom">🛠️ إجراء مخصص</option>
                        </select>
                    </div>
                    <div id="customFunctionDiv" style="margin-bottom: 15px; display: none;">
                        <label style="font-weight: 600; color: #ffffff; margin-bottom: 5px; display: block; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">الوظيفة المخصصة</label>
                        <input type="text" id="newIdeaFunction" class="form-control" placeholder="مثال: alert('مرحبا')"
                               style="border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 10px; background: rgba(255,255,255,0.9); color: #333;">
                        <small style="color: rgba(255,255,255,0.8);">للمطورين فقط - أدخل كود JavaScript</small>
                    </div>
                    <button onclick="addNewQuickIdea()" class="btn btn-success"
                            style="padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; width: 100%;">
                        <i class="fas fa-plus"></i> إضافة الفكرة
                    </button>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px; background: linear-gradient(135deg, #283593 0%, #3949ab 100%); display: flex; justify-content: flex-end; gap: 10px; border: none;">
                <button onclick="resetQuickIdeasToDefault()" class="btn btn-warning"
                        style="padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                    <i class="fas fa-undo"></i> استعادة الافتراضي
                </button>
                <button onclick="closeModal('quickIdeasManagerModal')" class="btn btn-secondary"
                        style="padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); color: white;">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>

    <script>
        // متغيرات النظام
        let products = [];
        let sales = [];
        let settings = {
            storeName: 'متجري الاحترافي',
            currency: 'ريال',
            lowStockThreshold: 10
        };

        // نظام التخصيص والثيمات
        let uiSettings = {
            navigationStyle: 'sidebar',
            fontSize: 'medium',
            theme: 'default',
            compactMode: false,
            fullscreenMode: false
        };

        // تحميل إعدادات الواجهة
        function loadUISettings() {
            const saved = localStorage.getItem('uiSettings');
            if (saved) {
                uiSettings = { ...uiSettings, ...JSON.parse(saved) };
            }
            applyUISettings();
        }

        // حفظ إعدادات الواجهة
        function saveUISettings() {
            localStorage.setItem('uiSettings', JSON.stringify(uiSettings));
        }

        // تطبيق إعدادات الواجهة
        function applyUISettings() {
            // تطبيق نمط التنقل
            if (uiSettings.navigationStyle === 'top') {
                document.getElementById('topNavigation').style.display = 'block';
                document.getElementById('sidebar').style.display = 'none';
                document.querySelector('.main-content').style.marginRight = '0';
            } else {
                document.getElementById('topNavigation').style.display = 'none';
                document.getElementById('sidebar').style.display = 'block';
                document.querySelector('.main-content').style.marginRight = '280px';
            }

            // تطبيق حجم الخط
            document.body.className = document.body.className.replace(/font-size-\w+/g, '');
            document.body.classList.add(`font-size-${uiSettings.fontSize}`);

            // تطبيق الثيم
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            document.body.classList.add(`theme-${uiSettings.theme}`);

            // تطبيق الوضع المضغوط
            if (uiSettings.compactMode) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }

            // تطبيق ملء الشاشة
            if (uiSettings.fullscreenMode) {
                document.body.classList.add('fullscreen-mode');
            } else {
                document.body.classList.remove('fullscreen-mode');
            }

            // تحديث عناصر التحكم
            if (document.getElementById('navigationStyle')) {
                document.getElementById('navigationStyle').value = uiSettings.navigationStyle;
                document.getElementById('fontSize').value = uiSettings.fontSize;
                document.getElementById('themeMode').value = uiSettings.theme;
                document.getElementById('compactMode').checked = uiSettings.compactMode;
                document.getElementById('fullscreenMode').checked = uiSettings.fullscreenMode;
            }
        }

        // تبديل لوحة التخصيص
        function toggleThemeSelector() {
            const selector = document.getElementById('themeSelector');
            if (selector.style.display === 'none' || !selector.style.display) {
                selector.style.display = 'block';
            } else {
                selector.style.display = 'none';
            }
        }

        // تغيير نمط التنقل
        function changeNavigationStyle() {
            uiSettings.navigationStyle = document.getElementById('navigationStyle').value;
            applyUISettings();
            saveUISettings();
            showToast('تم تغيير نمط التنقل بنجاح! 🎉', 'success');
        }

        // تغيير حجم الخط
        function changeFontSize() {
            uiSettings.fontSize = document.getElementById('fontSize').value;
            applyUISettings();
            saveUISettings();
            showToast('تم تغيير حجم الخط بنجاح! 📏', 'success');
        }

        // تغيير الثيم
        function changeTheme() {
            uiSettings.theme = document.getElementById('themeMode').value;
            applyUISettings();
            saveUISettings();
            showToast('تم تغيير الثيم بنجاح! 🎨', 'success');
        }

        // تبديل الوضع المضغوط
        function toggleCompactMode() {
            uiSettings.compactMode = document.getElementById('compactMode').checked;
            applyUISettings();
            saveUISettings();
            showToast(uiSettings.compactMode ? 'تم تفعيل الوضع المضغوط! 📦' : 'تم إلغاء الوضع المضغوط! 📦', 'info');
        }

        // تبديل ملء الشاشة
        function toggleFullscreenMode() {
            uiSettings.fullscreenMode = document.getElementById('fullscreenMode').checked;
            applyUISettings();
            saveUISettings();
            showToast(uiSettings.fullscreenMode ? 'تم تفعيل ملء الشاشة! 🖥️' : 'تم إلغاء ملء الشاشة! 🖥️', 'info');
        }

        // إعادة تعيين الإعدادات
        function resetUIToDefaults() {
            uiSettings = {
                navigationStyle: 'sidebar',
                fontSize: 'medium',
                theme: 'default',
                compactMode: false,
                fullscreenMode: false
            };
            applyUISettings();
            saveUISettings();
            showToast('تم إعادة تعيين جميع الإعدادات! 🔄', 'info');
        }

        // نظام الإشعارات المحسن
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const toastId = Date.now();
            toast.innerHTML = `
                <div class="toast-header">
                    <span class="toast-title">${getToastTitle(type)}</span>
                    <button class="toast-close" onclick="removeToast(${toastId})">&times;</button>
                </div>
                <div class="toast-message">${message}</div>
            `;

            toast.setAttribute('data-toast-id', toastId);
            container.appendChild(toast);

            // إزالة تلقائية
            setTimeout(() => {
                removeToast(toastId);
            }, duration);
        }

        function getToastTitle(type) {
            const titles = {
                success: '✅ نجح',
                error: '❌ خطأ',
                warning: '⚠️ تحذير',
                info: 'ℹ️ معلومات'
            };
            return titles[type] || 'إشعار';
        }

        function removeToast(toastId) {
            const toast = document.querySelector(`[data-toast-id="${toastId}"]`);
            if (toast) {
                toast.style.animation = 'toastSlideOut 0.3s ease forwards';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }

        // ===== نظام التنقل المحسن والمتكامل =====

        function showSection(sectionId) {
            try {
                console.log(`🔄 التنقل إلى قسم: ${sectionId}`);

                // إخفاء جميع الأقسام
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });

                // إظهار القسم المحدد
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                } else {
                    console.warn(`⚠️ القسم غير موجود: ${sectionId}`);
                    NotificationUtils.showWarning(`القسم "${sectionId}" غير موجود`);
                    return;
                }

                // تحديث التنقل الجانبي
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                const sidebarLink = document.querySelector(`.nav-link[onclick="showSection('${sectionId}')"]`);
                if (sidebarLink) {
                    sidebarLink.classList.add('active');
                }

                // تحديث التنقل العلوي
                document.querySelectorAll('.top-nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.style.background = 'rgba(255,255,255,0.1)';
                    tab.style.boxShadow = 'none';
                });
                const topTab = document.querySelector(`.top-nav-tab[data-section="${sectionId}"]`);
                if (topTab) {
                    topTab.classList.add('active');
                    topTab.style.background = 'rgba(255,255,255,0.25)';
                    topTab.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
                }

                // إغلاق لوحة التخصيص
                const themeSelector = document.getElementById('themeSelector');
                if (themeSelector) {
                    themeSelector.style.display = 'none';
                }

                // حفظ القسم الحالي
                localStorage.setItem('currentSection', sectionId);

                // تحديث عنوان الصفحة
                updatePageTitle(sectionId);

                // تحديث البيانات
                updateSectionData(sectionId);

                console.log(`✅ تم التنقل بنجاح إلى: ${sectionId}`);

            } catch (error) {
                console.error(`❌ خطأ في التنقل إلى ${sectionId}:`, error);
                NotificationUtils.showError(`خطأ في التنقل: ${error.message}`);
            }
        }

        // تحديث عنوان الصفحة
        function updatePageTitle(sectionId) {
            const sectionTitles = {
                'dashboard': 'لوحة التحكم',
                'products': 'المشتريات',
                'pos': 'المبيعات',
                'invoice-inquiry': 'استعلام الفواتير',
                'suppliers': 'الموردين',
                'customers': 'العملاء',
                'expenses': 'المصروفات',
                'backup': 'النسخ الاحتياطي',
                'settings': 'الإعدادات',
                'advanced': 'خيارات أخرى'
            };

            const title = sectionTitles[sectionId] || 'نظام إدارة المتجر';
            document.title = `${title} - نظام إدارة المتجر`;
        }

        // تحديث بيانات الأقسام - مطور ومحسن
        function updateSectionData(sectionId) {
            try {
                console.log(`🔄 تحديث بيانات القسم: ${sectionId}`);

                switch(sectionId) {
                    case 'dashboard':
                        updateDashboardSpecific();
                        break;
                    case 'products':
                        updateProductsSpecific();
                        break;
                    case 'pos':
                        updatePOSSpecific();
                        break;
                    case 'invoice-inquiry':
                        updateInvoiceInquirySpecific();
                        break;
                    case 'suppliers':
                        updateSuppliersSpecific();
                        break;
                    case 'customers':
                        updateCustomersSpecific();
                        break;
                    case 'expenses':
                        updateExpensesSpecific();
                        break;
                    case 'backup':
                        updateBackupSpecific();
                        break;
                    case 'settings':
                        updateSettingsSpecific();
                        break;
                    case 'advanced':
                        updateAdvancedSpecific();
                        break;
                    default:
                        console.warn(`⚠️ قسم غير معروف: ${sectionId}`);
                }

                console.log(`✅ تم تحديث بيانات القسم: ${sectionId}`);

            } catch (error) {
                console.error(`❌ خطأ في تحديث بيانات القسم ${sectionId}:`, error);
                NotificationUtils.showError(`خطأ في تحديث القسم: ${error.message}`);
            }
        }

        // ===== وظائف التحديث المخصصة لكل قسم =====

        function updateDashboardSpecific() {
            updateDashboard();
            updateQuickReports();
            updateStockAlerts();
            updateTopSellingProducts();
            updateCashboxDisplay();

            // تحديث المخططات البيانية
            if (typeof ChartsManager !== 'undefined') {
                setTimeout(() => {
                    if (document.getElementById('dashboard') && document.getElementById('dashboard').classList.contains('active')) {
                        ChartsManager.updateAllCharts();
                    }
                }, 500);
            }

            // تحديث التنبيهات
            if (typeof AlertsManager !== 'undefined') {
                AlertsManager.checkStockAlerts();
                AlertsManager.checkSystemAlerts();
                AlertsManager.updateAlertsDisplay();
            }
        }

        function updateProductsSpecific() {
            updateProductsTable();
            updatePOSProducts();
        }

        function updatePOSSpecific() {
            updatePOSProducts();
            // تحديث قائمة العملاء في نقطة البيع
            updatePOSCustomers();
        }

        function updateInvoiceInquirySpecific() {
            updateInvoicesTable();
            // تحديث إحصائيات الفواتير
            updateInvoiceStats();
        }

        function updateSuppliersSpecific() {
            updateSuppliersTable();
            updateSuppliersStats();
        }

        function updateCustomersSpecific() {
            updateCustomersTable();
            updateCustomersStats();
        }

        function updateExpensesSpecific() {
            updateExpensesTable();
            updateExpensesStats();
            updateBudgetDisplay();
        }

        function updateBackupSpecific() {
            updateBackupStatus();
            analyzeLocalStorage();
        }

        function updateSettingsSpecific() {
            loadSettingsValues();
            analyzeLocalStorage();
        }

        function updateAdvancedSpecific() {
            // تحديث معلومات النظام المتقدمة
            updateSystemInfo();
        }

        // ===== وظائف مساعدة إضافية =====

        function updatePOSProducts() {
            const container = document.getElementById('posProductsContainer');
            if (!container) return;

            try {
                container.innerHTML = '';
                const productsArray = Array.isArray(products) ? products : [];

                if (productsArray.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ccc;">
                            <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            لا توجد منتجات متاحة<br>
                            <small>انقر على "إضافة منتج جديد" لبدء إضافة المنتجات</small>
                        </div>
                    `;
                    return;
                }

                productsArray.forEach(product => {
                    if (product && typeof product === 'object') {
                        const productCard = document.createElement('div');
                        productCard.className = 'pos-product-card';
                        const quantity = parseInt(product.quantity) || 0;
                        const price = parseFloat(product.sellPrice) || 0;

                        productCard.innerHTML = `
                            <h4>${product.name || 'منتج غير محدد'}</h4>
                            <p>السعر: ${price.toFixed(2)} ${settings.currency || 'ريال'}</p>
                            <p>المتوفر: ${quantity}</p>
                            <button class="btn btn-primary" onclick="addToPOSCart(${product.id})" ${quantity <= 0 ? 'disabled' : ''}>
                                ${quantity <= 0 ? 'نفد المخزون' : 'إضافة للسلة'}
                            </button>
                        `;
                        container.appendChild(productCard);
                    }
                });
            } catch (error) {
                console.error('خطأ في تحديث منتجات نقطة البيع:', error);
                container.innerHTML = '<div style="text-align: center; color: #f00;">خطأ في تحميل المنتجات</div>';
                ErrorHandler.logError(error, 'updatePOSProducts', 'medium');
            }
        }

        function updatePOSCustomers() {
            // تحديث قائمة العملاء في نقطة البيع
            const customerSelect = document.getElementById('posCustomer');
            if (customerSelect) {
                try {
                    customerSelect.innerHTML = '<option value="">عميل نقدي</option>';
                    const customersArray = Array.isArray(customers) ? customers : [];
                    customersArray.forEach(customer => {
                        if (customer && typeof customer === 'object') {
                            const option = document.createElement('option');
                            option.value = customer.id;
                            option.textContent = `${customer.name || 'عميل غير محدد'} (${customer.code || 'بدون كود'})`;
                            customerSelect.appendChild(option);
                        }
                    });
                } catch (error) {
                    console.error('خطأ في تحديث عملاء نقطة البيع:', error);
                    ErrorHandler.logError(error, 'updatePOSCustomers', 'low');
                }
            }
        }

        function updateInvoiceStats() {
            // تحديث إحصائيات الفواتير
            const totalInvoices = sales.length;
            const totalAmount = sales.reduce((sum, sale) => sum + sale.total, 0);
            const avgInvoiceAmount = totalInvoices > 0 ? totalAmount / totalInvoices : 0;

            console.log(`📊 إحصائيات الفواتير: ${totalInvoices} فاتورة، إجمالي: ${totalAmount.toFixed(2)}`);
        }

        function loadSettingsValues() {
            // تحميل قيم الإعدادات في النماذج
            try {
                if (document.getElementById('storeName')) {
                    document.getElementById('storeName').value = settings.storeName || 'متجري الاحترافي';
                }
                if (document.getElementById('currency')) {
                    document.getElementById('currency').value = settings.currency || 'ريال';
                }
                if (document.getElementById('lowStockThreshold')) {
                    document.getElementById('lowStockThreshold').value = settings.lowStockThreshold || 10;
                }
                if (document.getElementById('taxRate')) {
                    document.getElementById('taxRate').value = settings.taxRate || 0;
                }

                // تحميل إعدادات العملاء
                if (document.getElementById('normalCustomerDiscount')) {
                    document.getElementById('normalCustomerDiscount').value = settings.normalCustomerDiscount || 0;
                }
                if (document.getElementById('wholesaleCustomerDiscount')) {
                    document.getElementById('wholesaleCustomerDiscount').value = settings.wholesaleCustomerDiscount || 5;
                }
                if (document.getElementById('traderCustomerDiscount')) {
                    document.getElementById('traderCustomerDiscount').value = settings.traderCustomerDiscount || 10;
                }

                console.log('✅ تم تحميل قيم الإعدادات');
            } catch (error) {
                console.error('❌ خطأ في تحميل قيم الإعدادات:', error);
            }
        }

        function updateSystemInfo() {
            // تحديث معلومات النظام
            const systemInfo = {
                version: '2.0.0',
                lastUpdate: new Date().toLocaleDateString('ar-SA'),
                dataSize: new Blob([JSON.stringify({products, sales, suppliers, customers, expenses, settings})]).size,
                totalRecords: products.length + sales.length + suppliers.length + customers.length + expenses.length
            };

            console.log('🖥️ معلومات النظام:', systemInfo);
        }

        // تحديث لوحة التحكم المحسن
        function updateDashboard() {
            // حساب المبيعات اليومية
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
            const todayRevenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);

            // حساب التكلفة والربح
            const todayCost = todaySales.reduce((sum, sale) => {
                const product = products.find(p => p.id === sale.productId);
                return sum + (product ? product.costPrice * sale.quantity : 0);
            }, 0);
            const todayProfit = todayRevenue - todayCost;

            // حساب المخزون المنخفض
            const lowStockCount = products.filter(p => p.quantity <= settings.lowStockThreshold).length;
            const outOfStockCount = products.filter(p => p.quantity === 0).length;

            // حساب رصيد الخزنة
            const totalExpensesToday = expenses.filter(e => new Date(e.date).toDateString() === today)
                .reduce((sum, expense) => sum + (expense.paymentMethod === 'cash' ? expense.amount : 0), 0);
            const cashBalance = todayRevenue - totalExpensesToday;

            // تحديث الإحصائيات
            document.getElementById('totalSales').textContent = todayRevenue.toFixed(2);
            document.getElementById('totalProfit').textContent = todayProfit.toFixed(2);
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('lowStockItems').textContent = lowStockCount;
            document.getElementById('outOfStockItems').textContent = outOfStockCount;
            document.getElementById('cashBalance').textContent = cashBalance.toFixed(2);
            document.getElementById('totalCustomers').textContent = customers.length;
            document.getElementById('totalSuppliers').textContent = suppliers.length;

            // تحديث متوازي للتقارير
            setTimeout(() => updateQuickReports(), 0);
            setTimeout(() => updateStockAlerts(), 0);
            setTimeout(() => updateTopSellingProducts(), 0);
        }

        function updateQuickReports() {
            const today = new Date();
            const weekStart = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            // مبيعات اليوم
            const todaySales = sales.filter(sale =>
                new Date(sale.date).toDateString() === today.toDateString()
            ).reduce((sum, sale) => sum + sale.total, 0);

            // مبيعات الأسبوع
            const weekSales = sales.filter(sale =>
                new Date(sale.date) >= weekStart
            ).reduce((sum, sale) => sum + sale.total, 0);

            // مبيعات الشهر
            const monthSales = sales.filter(sale =>
                new Date(sale.date) >= monthStart
            ).reduce((sum, sale) => sum + sale.total, 0);

            // إجمالي المبيعات
            const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);

            // تحديث العناصر
            if (document.getElementById('todaySales')) {
                document.getElementById('todaySales').textContent = `${todaySales.toFixed(2)} ${settings.currency}`;
                document.getElementById('weekSales').textContent = `${weekSales.toFixed(2)} ${settings.currency}`;
                document.getElementById('monthSales').textContent = `${monthSales.toFixed(2)} ${settings.currency}`;
                document.getElementById('totalAllSales').textContent = `${totalSales.toFixed(2)} ${settings.currency}`;
            }
        }

        function updateStockAlerts() {
            const alertsContainer = document.getElementById('stockAlerts');
            if (!alertsContainer) return;

            const lowStockItems = products.filter(p => p.quantity <= settings.lowStockThreshold && p.quantity > 0);
            const outOfStockItems = products.filter(p => p.quantity === 0);

            if (lowStockItems.length === 0 && outOfStockItems.length === 0) {
                alertsContainer.innerHTML = `
                    <div style="text-align: center; color: #28a745; padding: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <p>جميع المنتجات متوفرة ✅</p>
                    </div>
                `;
                return;
            }

            let alertsHTML = '';

            if (outOfStockItems.length > 0) {
                alertsHTML += `
                    <div style="background: rgba(220,53,69,0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <h4 style="color: #dc3545; margin-bottom: 8px;">❌ منتجات نفد مخزونها (${outOfStockItems.length})</h4>
                        ${outOfStockItems.slice(0, 3).map(item => `
                            <div style="font-size: 0.9em; margin-bottom: 4px;">• ${item.name}</div>
                        `).join('')}
                        ${outOfStockItems.length > 3 ? `<div style="font-size: 0.8em; opacity: 0.8;">و ${outOfStockItems.length - 3} منتجات أخرى...</div>` : ''}
                    </div>
                `;
            }

            if (lowStockItems.length > 0) {
                alertsHTML += `
                    <div style="background: rgba(255,193,7,0.2); padding: 10px; border-radius: 8px;">
                        <h4 style="color: #ffc107; margin-bottom: 8px;">⚠️ منتجات منخفضة المخزون (${lowStockItems.length})</h4>
                        ${lowStockItems.slice(0, 3).map(item => `
                            <div style="font-size: 0.9em; margin-bottom: 4px;">• ${item.name} (${item.quantity} متبقي)</div>
                        `).join('')}
                        ${lowStockItems.length > 3 ? `<div style="font-size: 0.8em; opacity: 0.8;">و ${lowStockItems.length - 3} منتجات أخرى...</div>` : ''}
                    </div>
                `;
            }

            alertsContainer.innerHTML = alertsHTML;
        }

        function updateTopSellingProducts() {
            const container = document.getElementById('topSellingProducts');
            if (!container) return;

            // حساب أكثر المنتجات مبيعاً هذا الشهر
            const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const monthSales = sales.filter(sale => new Date(sale.date) >= monthStart);

            if (monthSales.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #ccc; padding: 20px;">
                        <i class="fas fa-chart-bar" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <p>لا توجد مبيعات هذا الشهر</p>
                    </div>
                `;
                return;
            }

            const productSales = {};
            monthSales.forEach(sale => {
                if (productSales[sale.productId]) {
                    productSales[sale.productId].quantity += sale.quantity;
                    productSales[sale.productId].total += sale.total;
                } else {
                    productSales[sale.productId] = {
                        productName: sale.productName,
                        quantity: sale.quantity,
                        total: sale.total
                    };
                }
            });

            const topProducts = Object.values(productSales)
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);

            container.innerHTML = topProducts.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="background: ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : 'rgba(255,255,255,0.2)'}; color: ${index < 3 ? '#000' : '#fff'}; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">
                            ${index + 1}
                        </span>
                        <strong>${item.productName}</strong>
                    </div>
                    <div style="text-align: left;">
                        <div>الكمية: ${item.quantity}</div>
                        <div style="color: #28a745; font-weight: bold;">${item.total.toFixed(2)} ${settings.currency}</div>
                    </div>
                </div>
            `).join('');
        }

        // تحديث جدول المنتجات
        function updateProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            const searchTerm = document.getElementById('searchProducts')?.value.toLowerCase() || '';

            if (!tbody) return;

            let filteredProducts = products;

            if (searchTerm) {
                filteredProducts = products.filter(product => {
                    if (!product || typeof product !== 'object') return false;
                    const name = (product.name || '').toLowerCase();
                    const code = (product.code || '').toLowerCase();
                    const category = (product.category || '').toLowerCase();
                    return name.includes(searchTerm) || code.includes(searchTerm) || category.includes(searchTerm);
                });
            }

            if (filteredProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #ccc;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            ${searchTerm ? 'لا توجد منتجات تطابق البحث' : 'لا توجد منتجات حالياً'}<br>
                            <small>${searchTerm ? 'جرب كلمات بحث أخرى' : 'انقر على "إضافة منتج جديد" لبدء إضافة المنتجات'}</small>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredProducts.map(product => `
                <tr>
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${product.category || 'غير محدد'}</td>
                    <td>${(parseFloat(product.costPrice) || 0).toFixed(2)} ${settings.currency}</td>
                    <td>${(parseFloat(product.sellPrice) || 0).toFixed(2)} ${settings.currency}</td>
                    <td>${product.quantity}</td>
                    <td>
                        <span style="color: ${product.quantity > settings.lowStockThreshold ? '#28a745' : '#dc3545'}">
                            ${product.quantity > settings.lowStockThreshold ? '✅ متوفر' : '⚠️ منخفض'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editProduct(${product.id})" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // وظائف النوافذ المنبثقة محسنة
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';

                // التركيز السريع على أول حقل
                const firstInput = modal.querySelector('input, select, textarea');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 50);
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                clearModalForm(modalId);
            }
        }

        function clearModalForm(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const inputs = modal.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }

        // إضافة منتج جديد
        function showAddProductModal() {
            try {
                clearProductForm();
                showModal('addProductModal');
                ActivityLogger.log('showAddProductModal');
            } catch (error) {
                ErrorHandler.logError(error, 'showAddProductModal', 'low');
                NotificationUtils.showError('خطأ في فتح نموذج إضافة المنتج');
            }
        }

        function saveProduct() {
            const startTime = performance.now();
            try {
                // جمع البيانات بسرعة مع تحسين الأداء
                const elements = {
                    code: document.getElementById('productCode'),
                    name: document.getElementById('productName'),
                    category: document.getElementById('productCategory'),
                    costPrice: document.getElementById('productCostPrice'),
                    sellPrice: document.getElementById('productSellPrice'),
                    quantity: document.getElementById('productQuantity'),
                    description: document.getElementById('productDescription')
                };

                const formData = {
                    code: elements.code.value.trim(),
                    name: elements.name.value.trim(),
                    category: elements.category.value,
                    costPrice: parseFloat(elements.costPrice.value) || 0,
                    sellPrice: parseFloat(elements.sellPrice.value) || 0,
                    quantity: parseInt(elements.quantity.value) || 0,
                    description: elements.description.value.trim()
                };

                // التحقق السريع مع رسائل مختصرة
                if (!formData.code || !formData.name) {
                    NotificationUtils.showWarning('الكود والاسم مطلوبان! ⚠️');
                    return;
                }

                if (formData.sellPrice <= 0) {
                    NotificationUtils.showWarning('سعر البيع مطلوب! ⚠️');
                    return;
                }

                // فحص التكرار المحسن
                const existingProduct = products.find(p => p.code === formData.code);
                if (existingProduct) {
                    NotificationUtils.showError('الكود موجود! 🔄');
                    elements.code.focus();
                    return;
                }

                // إنشاء المنتج
                const newProduct = {
                    id: Date.now(),
                    ...formData,
                    category: formData.category || 'غير محدد',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };

                // حفظ فوري
                products.push(newProduct);

                // تحديث متوازي للأداء
                const updatePromises = [
                    new Promise(resolve => { saveData(); resolve(); }),
                    new Promise(resolve => { setTimeout(() => { updateProductsTable(); resolve(); }, 0); }),
                    new Promise(resolve => { setTimeout(() => { updatePOSProducts(); resolve(); }, 0); })
                ];

                Promise.all(updatePromises).then(() => {
                    updateDashboard();
                    StateManager.updateSection('products', newProduct);
                });

                // إغلاق سريع
                closeModal('addProductModal');
                clearProductForm();

                // إشعار مختصر
                NotificationUtils.showSuccess(`حُفظ "${formData.name}" ✅`);
                ActivityLogger.log('saveProduct', { productName: formData.name, productId: newProduct.id });
                PerformanceMonitor.endOperation(operationId, true);

            } catch (error) {
                console.error('خطأ في حفظ المنتج:', error);
                NotificationUtils.showError('خطأ في الحفظ! ❌');
                PerformanceMonitor.endOperation(operationId, false);
                ErrorHandler.logError(error, 'saveProduct', 'medium');
            }
        }

        function clearProductForm() {
            try {
                const fields = ['productCode', 'productName', 'productCategory', 'productCostPrice', 'productSellPrice', 'productQuantity', 'productDescription'];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });

                // إعادة تعيين حساب الربح
                const profitElement = document.getElementById('expectedProfit');
                const marginElement = document.getElementById('profitMargin');
                if (profitElement) profitElement.textContent = '0.00 ريال';
                if (marginElement) marginElement.textContent = '0%';

                // إعادة تعيين شريط التقدم
                updateProgress();

            } catch (error) {
                console.error('خطأ في مسح نموذج المنتج:', error);
            }
        }

        // وظيفة تحديث شريط التقدم
        function updateProgress() {
            try {
                const fields = [
                    'productCode',
                    'productName',
                    'productSellPrice',
                    'productQuantity'
                ];

                let filledFields = 0;
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value.trim()) {
                        filledFields++;
                    }
                });

                const progress = (filledFields / fields.length) * 100;
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
            } catch (error) {
                console.error('خطأ في تحديث شريط التقدم:', error);
            }
        }

        // حساب الربح التلقائي
        function calculateProfit() {
            try {
                const costPrice = parseFloat(document.getElementById('productCostPrice').value) || 0;
                const sellPrice = parseFloat(document.getElementById('productSellPrice').value) || 0;

                const profit = sellPrice - costPrice;
                const margin = costPrice > 0 ? ((profit / costPrice) * 100) : 0;

                const profitElement = document.getElementById('expectedProfit');
                const marginElement = document.getElementById('profitMargin');

                if (profitElement) {
                    profitElement.textContent = `${profit.toFixed(2)} ريال`;
                    profitElement.style.color = profit >= 0 ? '#00b894' : '#e17055';
                }

                if (marginElement) {
                    marginElement.textContent = `${margin.toFixed(1)}%`;
                    marginElement.style.color = profit >= 0 ? '#00b894' : '#e17055';
                }

            } catch (error) {
                console.error('خطأ في حساب الربح:', error);
            }
        }

        // البيع السريع
        function showQuickSaleModal() {
            if (products.length === 0) {
                showToast('لا توجد منتجات متاحة للبيع! أضف منتجات أولاً 📦', 'warning');
                return;
            }
            showModal('quickSaleModal');
            searchProductsForSale();
        }

        let selectedProductForSale = null;

        function searchProductsForSale() {
            const searchTerm = document.getElementById('quickSaleSearch').value.toLowerCase();
            const resultsContainer = document.getElementById('quickSaleResults');

            if (!searchTerm) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">ابدأ بكتابة اسم أو كود المنتج...</p>';
                return;
            }

            const filteredProducts = products.filter(product =>
                product.quantity > 0 && (
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.code.toLowerCase().includes(searchTerm)
                )
            );

            if (filteredProducts.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">لا توجد منتجات تطابق البحث</p>';
                return;
            }

            resultsContainer.innerHTML = filteredProducts.map(product => `
                <div style="
                    padding: 10px;
                    margin-bottom: 8px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onclick="selectProductForSale(${product.id})" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                    <strong>${product.name}</strong> (${product.code})<br>
                    <small>السعر: ${product.sellPrice.toFixed(2)} ${settings.currency} | المتوفر: ${product.quantity}</small>
                </div>
            `).join('');
        }

        function selectProductForSale(productId) {
            selectedProductForSale = products.find(p => p.id === productId);
            if (selectedProductForSale) {
                document.getElementById('selectedProduct').value = `${selectedProductForSale.name} (${selectedProductForSale.code})`;
                document.getElementById('salePrice').value = selectedProductForSale.sellPrice.toFixed(2);
                document.getElementById('saleQuantity').value = '1';
                calculateSaleTotal();

                // إضافة مستمع لتغيير الكمية
                document.getElementById('saleQuantity').onchange = calculateSaleTotal;
            }
        }

        function calculateSaleTotal() {
            if (selectedProductForSale) {
                const quantity = parseInt(document.getElementById('saleQuantity').value) || 1;
                const price = parseFloat(document.getElementById('salePrice').value) || 0;
                const total = quantity * price;
                document.getElementById('saleTotal').value = `${total.toFixed(2)} ${settings.currency}`;
            }
        }

        function completeQuickSale() {
            if (!selectedProductForSale) {
                showToast('يرجى اختيار منتج أولاً! ⚠️', 'warning');
                return;
            }

            const quantity = parseInt(document.getElementById('saleQuantity').value) || 1;

            if (quantity > selectedProductForSale.quantity) {
                showToast('الكمية المطلوبة أكبر من المتوفر! ⚠️', 'warning');
                return;
            }

            // تحديث كمية المنتج
            selectedProductForSale.quantity -= quantity;

            // إضافة عملية البيع
            const sale = {
                id: Date.now(),
                productId: selectedProductForSale.id,
                productName: selectedProductForSale.name,
                quantity: quantity,
                price: selectedProductForSale.sellPrice,
                total: quantity * selectedProductForSale.sellPrice,
                date: new Date().toISOString()
            };

            sales.push(sale);
            saveData();
            updateProductsTable();
            updateDashboard();
            closeModal('quickSaleModal');

            showToast(`تم بيع ${quantity} من "${selectedProductForSale.name}" بنجاح! 💰`, 'success');
            selectedProductForSale = null;
        }

        // جرد المخزون
        function showInventoryCheckModal() {
            showModal('inventoryCheckModal');
            generateInventoryReport();
        }

        function generateInventoryReport() {
            const reportContainer = document.getElementById('inventoryReport');

            if (products.length === 0) {
                reportContainer.innerHTML = '<p style="text-align: center; color: #ccc; padding: 40px;">لا توجد منتجات في المخزون</p>';
                return;
            }

            const totalProducts = products.length;
            const totalValue = products.reduce((sum, product) => sum + (product.quantity * product.costPrice), 0);
            const lowStockItems = products.filter(product => product.quantity <= settings.lowStockThreshold);
            const outOfStockItems = products.filter(product => product.quantity === 0);

            reportContainer.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px;">${totalProducts}</div>
                            <div>إجمالي المنتجات</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 1.5em; margin-bottom: 5px;">${totalValue.toFixed(2)}</div>
                            <div>قيمة المخزون</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255,193,7,0.2); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px; color: #ffc107;">${lowStockItems.length}</div>
                            <div>مخزون منخفض</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(220,53,69,0.2); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px; color: #dc3545;">${outOfStockItems.length}</div>
                            <div>نفد المخزون</div>
                        </div>
                    </div>
                </div>

                ${lowStockItems.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #ffc107; margin-bottom: 10px;">⚠️ منتجات بمخزون منخفض:</h4>
                        ${lowStockItems.map(product => `
                            <div style="padding: 8px; margin-bottom: 5px; background: rgba(255,193,7,0.1); border-radius: 5px;">
                                <strong>${product.name}</strong> - الكمية: ${product.quantity}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${outOfStockItems.length > 0 ? `
                    <div>
                        <h4 style="color: #dc3545; margin-bottom: 10px;">❌ منتجات نفد مخزونها:</h4>
                        ${outOfStockItems.map(product => `
                            <div style="padding: 8px; margin-bottom: 5px; background: rgba(220,53,69,0.1); border-radius: 5px;">
                                <strong>${product.name}</strong> - نفد المخزون
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        }

        function exportInventoryReport() {
            showToast('سيتم إضافة وظيفة تصدير التقرير قريباً! 📊', 'info');
        }

        // التقرير اليومي
        function showDailyReportModal() {
            showModal('dailyReportModal');
            generateDailyReport();
        }

        function generateDailyReport() {
            const reportContainer = document.getElementById('dailyReportContent');
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);

            const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const totalTransactions = todaySales.length;
            const topProducts = getTopSellingProducts(todaySales);

            reportContainer.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">📅 تقرير يوم ${new Date().toLocaleDateString('ar-SA')}</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: rgba(40,167,69,0.2); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px; color: #28a745;">${totalSales.toFixed(2)}</div>
                            <div>إجمالي المبيعات</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(23,162,184,0.2); border-radius: 10px;">
                            <div style="font-size: 2em; margin-bottom: 5px; color: #17a2b8;">${totalTransactions}</div>
                            <div>عدد المعاملات</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(102,126,234,0.2); border-radius: 10px;">
                            <div style="font-size: 1.5em; margin-bottom: 5px; color: var(--primary);">${totalTransactions > 0 ? (totalSales / totalTransactions).toFixed(2) : '0.00'}</div>
                            <div>متوسط المعاملة</div>
                        </div>
                    </div>

                    ${topProducts.length > 0 ? `
                        <div>
                            <h4 style="margin-bottom: 10px;">🏆 أكثر المنتجات مبيعاً اليوم:</h4>
                            ${topProducts.map((item, index) => `
                                <div style="padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                    <strong>#${index + 1} ${item.productName}</strong><br>
                                    <small>الكمية: ${item.quantity} | الإجمالي: ${item.total.toFixed(2)} ${settings.currency}</small>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="text-align: center; color: #ccc; padding: 20px;">لا توجد مبيعات اليوم</p>'}
                </div>
            `;
        }

        function getTopSellingProducts(salesData) {
            const productSales = {};

            salesData.forEach(sale => {
                if (productSales[sale.productId]) {
                    productSales[sale.productId].quantity += sale.quantity;
                    productSales[sale.productId].total += sale.total;
                } else {
                    productSales[sale.productId] = {
                        productName: sale.productName,
                        quantity: sale.quantity,
                        total: sale.total
                    };
                }
            });

            return Object.values(productSales)
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
        }

        function printDailyReport() {
            showToast('سيتم إضافة وظيفة الطباعة قريباً! 🖨️', 'info');
        }

        // ===== نظام إدارة العلاقات والتبعيات =====

        // متغيرات البيانات المنظمة
        let suppliers = [];
        let customers = [];
        let expenses = [];
        let invoices = [];
        let cashbox = {
            balance: 0,
            transactions: []
        };

        // خريطة العلاقات بين الأقسام
        const SECTION_DEPENDENCIES = {
            dashboard: ['products', 'pos', 'customers', 'suppliers', 'expenses'],
            products: ['suppliers'],
            pos: ['products', 'customers'],
            'invoice-inquiry': ['pos', 'products'],
            suppliers: [],
            customers: [],
            expenses: [],
            backup: ['products', 'pos', 'customers', 'suppliers', 'expenses'],
            settings: [],
            advanced: ['dashboard', 'backup', 'settings']
        };

        // أنواع العمليات المالية
        const TRANSACTION_TYPES = {
            SALE: 'sale',
            PURCHASE: 'purchase',
            EXPENSE: 'expense',
            REFUND: 'refund',
            ADJUSTMENT: 'adjustment'
        };

        // حالات الفواتير
        const INVOICE_STATUS = {
            PENDING: 'pending',
            COMPLETED: 'completed',
            CANCELLED: 'cancelled',
            REFUNDED: 'refunded'
        };

        // أنواع العملاء
        const CUSTOMER_TYPES = {
            NORMAL: { key: 'normal', label: 'عادي', discount: 0 },
            WHOLESALE: { key: 'wholesale', label: 'جملة', discount: 5 },
            TRADER: { key: 'trader', label: 'تاجر', discount: 10 }
        };

        // ===== الوظائف المساعدة المشتركة (Utils) =====

        // وحدة إدارة الخصومات
        const DiscountUtils = {
            calculateDiscount(price, percentage) {
                if (percentage < 0 || percentage > 100) {
                    throw new Error('نسبة الخصم يجب أن تكون بين 0 و 100');
                }
                return (price * percentage) / 100;
            },

            getCustomerDiscount(customerType) {
                const type = CUSTOMER_TYPES[customerType.toUpperCase()];
                return type ? type.discount : 0;
            },

            applyDiscount(price, percentage) {
                const discountAmount = this.calculateDiscount(price, percentage);
                return {
                    originalPrice: price,
                    discountAmount: discountAmount,
                    finalPrice: price - discountAmount,
                    discountPercentage: percentage
                };
            }
        };

        // وحدة إدارة الخزنة
        const CashboxUtils = {
            updateBalance(amount, type, description = '') {
                const transaction = {
                    id: Date.now(),
                    amount: amount,
                    type: type,
                    description: description,
                    timestamp: new Date().toISOString(),
                    balanceBefore: cashbox.balance,
                    balanceAfter: 0
                };

                // تحديث الرصيد حسب نوع العملية
                switch(type) {
                    case TRANSACTION_TYPES.SALE:
                        cashbox.balance += amount;
                        break;
                    case TRANSACTION_TYPES.PURCHASE:
                    case TRANSACTION_TYPES.EXPENSE:
                        if (cashbox.balance < amount) {
                            throw new Error('رصيد الخزنة غير كافي');
                        }
                        cashbox.balance -= amount;
                        break;
                    case TRANSACTION_TYPES.REFUND:
                        cashbox.balance -= amount;
                        break;
                    case TRANSACTION_TYPES.ADJUSTMENT:
                        cashbox.balance = amount;
                        break;
                }

                transaction.balanceAfter = cashbox.balance;
                cashbox.transactions.push(transaction);

                this.validateBalance();
                return transaction;
            },

            validateBalance() {
                if (cashbox.balance < 0) {
                    NotificationUtils.showWarning('تحذير: رصيد الخزنة أصبح بالسالب!');
                }
                if (cashbox.balance > 100000) {
                    NotificationUtils.showInfo('تنبيه: رصيد الخزنة مرتفع، يُنصح بإيداع جزء منه');
                }
            },

            getBalance() {
                return cashbox.balance;
            },

            getTransactionHistory(limit = 50) {
                return cashbox.transactions
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, limit);
            }
        };

        // وحدة تنسيق العملة والأرقام
        const CurrencyUtils = {
            format(value, currency = null) {
                const curr = currency || settings.currency || 'ريال';
                return `${parseFloat(value).toFixed(2)} ${curr}`;
            },

            parse(value) {
                return parseFloat(value) || 0;
            },

            formatNumber(value, decimals = 2) {
                return parseFloat(value).toFixed(decimals);
            }
        };

        // وحدة إدارة الإشعارات المحسنة
        const NotificationUtils = {
            show(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${this.getIcon(type)}"></i>
                        <span>${message}</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                    </div>
                `;

                // إضافة الإشعار للحاوية
                let container = document.getElementById('notificationContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'notificationContainer';
                    container.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        max-width: 400px;
                    `;
                    document.body.appendChild(container);
                }

                container.appendChild(notification);

                // إزالة تلقائية
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);

                return notification;
            },

            showSuccess(message, duration = 3000) {
                return this.show(message, 'success', duration);
            },

            showError(message, duration = 7000) {
                return this.show(message, 'error', duration);
            },

            showWarning(message, duration = 5000) {
                return this.show(message, 'warning', duration);
            },

            showInfo(message, duration = 4000) {
                return this.show(message, 'info', duration);
            },

            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }
        };

        // ===== وحدة التحقق من الأخطاء والحماية =====

        const ValidationUtils = {
            // التحقق من صحة بيانات المنتج
            validateProduct(product) {
                const errors = [];

                if (!product.name || product.name.trim() === '') {
                    errors.push('اسم المنتج مطلوب');
                }

                if (!product.price || product.price <= 0) {
                    errors.push('سعر المنتج يجب أن يكون أكبر من صفر');
                }

                if (product.quantity < 0) {
                    errors.push('كمية المنتج لا يمكن أن تكون سالبة');
                }

                if (product.costPrice && product.costPrice > product.price) {
                    errors.push('سعر التكلفة لا يمكن أن يكون أكبر من سعر البيع');
                }

                return {
                    isValid: errors.length === 0,
                    errors: errors
                };
            },

            // التحقق من صحة بيانات العميل
            validateCustomer(customer) {
                const errors = [];

                if (!customer.name || customer.name.trim() === '') {
                    errors.push('اسم العميل مطلوب');
                }

                if (customer.phone && !this.isValidPhone(customer.phone)) {
                    errors.push('رقم الهاتف غير صحيح');
                }

                if (customer.email && !this.isValidEmail(customer.email)) {
                    errors.push('البريد الإلكتروني غير صحيح');
                }

                if (customer.creditLimit < 0) {
                    errors.push('حد الائتمان لا يمكن أن يكون سالباً');
                }

                return {
                    isValid: errors.length === 0,
                    errors: errors
                };
            },

            // التحقق من صحة عملية البيع
            validateSale(saleData) {
                const errors = [];

                if (!saleData.productId) {
                    errors.push('يجب اختيار منتج');
                }

                if (!saleData.quantity || saleData.quantity <= 0) {
                    errors.push('الكمية يجب أن تكون أكبر من صفر');
                }

                // التحقق من توفر المخزون
                const product = products.find(p => p.id === saleData.productId);
                if (product && product.quantity < saleData.quantity) {
                    errors.push(`المخزون غير كافي. المتوفر: ${product.quantity}`);
                }

                // التحقق من الخصم
                if (saleData.discount && (saleData.discount < 0 || saleData.discount > 100)) {
                    errors.push('نسبة الخصم يجب أن تكون بين 0 و 100');
                }

                return {
                    isValid: errors.length === 0,
                    errors: errors
                };
            },

            // التحقق من صحة المصروف
            validateExpense(expense) {
                const errors = [];

                if (!expense.description || expense.description.trim() === '') {
                    errors.push('وصف المصروف مطلوب');
                }

                if (!expense.amount || expense.amount <= 0) {
                    errors.push('مبلغ المصروف يجب أن يكون أكبر من صفر');
                }

                if (expense.paymentMethod === 'cash' && cashbox.balance < expense.amount) {
                    errors.push('رصيد الخزنة غير كافي لهذا المصروف');
                }

                return {
                    isValid: errors.length === 0,
                    errors: errors
                };
            },

            // التحقق من صحة رقم الهاتف
            isValidPhone(phone) {
                const phoneRegex = /^(\+966|966|0)?[5][0-9]{8}$/;
                return phoneRegex.test(phone.replace(/\s/g, ''));
            },

            // التحقق من صحة البريد الإلكتروني
            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },

            // التحقق من إمكانية حذف منتج
            canDeleteProduct(productId) {
                const usedInSales = sales.some(sale => sale.productId === productId);
                return !usedInSales;
            },

            // التحقق من إمكانية حذف عميل
            canDeleteCustomer(customerId) {
                const hasOutstandingDebt = customers.find(c => c.id === customerId)?.outstandingDebt > 0;
                const hasRecentSales = sales.some(sale =>
                    sale.customerId === customerId &&
                    new Date(sale.date) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) // آخر 30 يوم
                );
                return !hasOutstandingDebt && !hasRecentSales;
            }
        };

        // ===== وحدة إدارة الحالة والتزامن =====

        const StateManager = {
            // تحديث حالة قسم معين
            updateSection(sectionName, data) {
                try {
                    // التحقق من التبعيات
                    const dependencies = SECTION_DEPENDENCIES[sectionName] || [];

                    // تحديث البيانات
                    this.updateSectionData(sectionName, data);

                    // تحديث الأقسام المرتبطة
                    dependencies.forEach(dep => {
                        if (dep !== 'all') {
                            this.refreshSection(dep);
                        }
                    });

                    // حفظ البيانات
                    saveData();

                    return { success: true };
                } catch (error) {
                    NotificationUtils.showError(`خطأ في تحديث ${sectionName}: ${error.message}`);
                    return { success: false, error: error.message };
                }
            },

            updateSectionData(sectionName, data) {
                switch(sectionName) {
                    case 'products':
                        this.updateProductsData(data);
                        break;
                    case 'sales':
                        this.updateSalesData(data);
                        break;
                    case 'customers':
                        this.updateCustomersData(data);
                        break;
                    case 'suppliers':
                        this.updateSuppliersData(data);
                        break;
                    case 'expenses':
                        this.updateExpensesData(data);
                        break;
                }
            },

            refreshSection(sectionName) {
                try {
                    console.log(`🔄 تحديث القسم: ${sectionName}`);

                    switch(sectionName) {
                        case 'dashboard':
                            updateDashboard();
                            updateQuickReports();
                            updateStockAlerts();
                            updateTopSellingProducts();
                            break;
                        case 'products':
                            updateProductsTable();
                            updatePOSProducts();
                            break;
                        case 'pos':
                        case 'sales':
                            updatePOSProducts();
                            updatePOSCustomers();
                            break;
                        case 'invoice-inquiry':
                            updateInvoicesTable();
                            updateInvoiceStats();
                            break;
                        case 'customers':
                            updateCustomersTable();
                            updateCustomersStats();
                            break;
                        case 'suppliers':
                            updateSuppliersTable();
                            updateSuppliersStats();
                            break;
                        case 'expenses':
                            updateExpensesTable();
                            updateExpensesStats();
                            updateBudgetDisplay();
                            break;
                        case 'backup':
                            updateBackupStatus();
                            analyzeLocalStorage();
                            break;
                        case 'settings':
                            loadSettingsValues();
                            analyzeLocalStorage();
                            break;
                        case 'advanced':
                            updateSystemInfo();
                            break;
                        case 'cashbox':
                            updateCashboxDisplay();
                            break;
                        default:
                            console.warn(`⚠️ قسم غير معروف للتحديث: ${sectionName}`);
                    }

                    console.log(`✅ تم تحديث القسم: ${sectionName}`);

                } catch (error) {
                    console.error(`❌ خطأ في تحديث القسم ${sectionName}:`, error);
                    NotificationUtils.showError(`خطأ في تحديث القسم: ${error.message}`);
                }
            },

            updateProductsData(data) {
                if (data.action === 'add') {
                    products.push(data.product);
                } else if (data.action === 'update') {
                    const index = products.findIndex(p => p.id === data.product.id);
                    if (index !== -1) {
                        products[index] = { ...products[index], ...data.product };
                    }
                } else if (data.action === 'delete') {
                    if (ValidationUtils.canDeleteProduct(data.productId)) {
                        products = products.filter(p => p.id !== data.productId);
                    } else {
                        throw new Error('لا يمكن حذف منتج مستخدم في فواتير سابقة');
                    }
                }
            },

            updateSalesData(data) {
                if (data.action === 'add') {
                    // تحديث المخزون
                    const product = products.find(p => p.id === data.sale.productId);
                    if (product) {
                        product.quantity -= data.sale.quantity;
                    }

                    // تحديث الخزنة
                    if (data.sale.paymentMethod === 'cash') {
                        CashboxUtils.updateBalance(
                            data.sale.total,
                            TRANSACTION_TYPES.SALE,
                            `بيع ${data.sale.productName}`
                        );
                    }

                    // إضافة البيع
                    sales.push(data.sale);
                }
            },

            updateCustomersData(data) {
                if (data.action === 'add') {
                    customers.push(data.customer);
                } else if (data.action === 'update') {
                    const index = customers.findIndex(c => c.id === data.customer.id);
                    if (index !== -1) {
                        customers[index] = { ...customers[index], ...data.customer };
                    }
                }
            },

            updateSuppliersData(data) {
                if (data.action === 'add') {
                    suppliers.push(data.supplier);
                } else if (data.action === 'update') {
                    const index = suppliers.findIndex(s => s.id === data.supplier.id);
                    if (index !== -1) {
                        suppliers[index] = { ...suppliers[index], ...data.supplier };
                    }
                }
            },

            updateExpensesData(data) {
                if (data.action === 'add') {
                    // تحديث الخزنة
                    if (data.expense.paymentMethod === 'cash') {
                        CashboxUtils.updateBalance(
                            data.expense.amount,
                            TRANSACTION_TYPES.EXPENSE,
                            data.expense.description
                        );
                    }

                    expenses.push(data.expense);
                }
            }
        };

        // وظائف الموردين
        function showAddSupplierModal() {
            showModal('addSupplierModal');
            // تعيين كود تلقائي
            document.getElementById('supplierCode').value = generateSupplierCode();
        }

        function generateSupplierCode() {
            const count = suppliers.length + 1;
            return `SUP${count.toString().padStart(3, '0')}`;
        }

        function saveSupplier() {
            const operationId = PerformanceMonitor.logOperation('saveSupplier');
            try {
                // جمع البيانات
                const supplierData = {
                    code: document.getElementById('supplierCode').value.trim(),
                    name: document.getElementById('supplierName').value.trim(),
                    company: document.getElementById('supplierCompany').value.trim(),
                    phone: document.getElementById('supplierPhone').value.trim(),
                    email: document.getElementById('supplierEmail').value.trim(),
                    address: document.getElementById('supplierAddress').value.trim(),
                    rating: parseInt(document.getElementById('supplierRating').value),
                    paymentMethod: document.getElementById('supplierPaymentMethod').value,
                    notes: document.getElementById('supplierNotes').value.trim()
                };

                // التحقق من صحة البيانات الأساسية
                if (!supplierData.code || !supplierData.name) {
                    NotificationUtils.showWarning('يرجى إدخال كود المورد والاسم!');
                    return;
                }

                // التحقق من عدم تكرار الكود
                if (suppliers.find(s => s.code === supplierData.code)) {
                    NotificationUtils.showWarning('كود المورد موجود مسبقاً!');
                    return;
                }

                // التحقق من صحة البريد الإلكتروني والهاتف
                if (supplierData.email && !ValidationUtils.isValidEmail(supplierData.email)) {
                    NotificationUtils.showWarning('البريد الإلكتروني غير صحيح!');
                    return;
                }

                if (supplierData.phone && !ValidationUtils.isValidPhone(supplierData.phone)) {
                    NotificationUtils.showWarning('رقم الهاتف غير صحيح!');
                    return;
                }

                // إنشاء المورد الجديد
                const newSupplier = {
                    id: Date.now(),
                    ...supplierData,
                    totalPurchases: 0,
                    outstandingAmount: 0,
                    lastDeal: null,
                    createdAt: new Date().toISOString(),
                    isActive: true
                };

                // استخدام StateManager لتحديث البيانات
                const result = StateManager.updateSection('suppliers', {
                    action: 'add',
                    supplier: newSupplier
                });

                if (result.success) {
                    closeModal('addSupplierModal');
                    clearSupplierForm();
                    NotificationUtils.showSuccess(`تم إضافة المورد "${supplierData.name}" بنجاح! 🎉`);
                    PerformanceMonitor.endOperation(operationId, true);
                } else {
                    PerformanceMonitor.endOperation(operationId, false);
                }

            } catch (error) {
                PerformanceMonitor.endOperation(operationId, false);
                NotificationUtils.showError(`خطأ في حفظ المورد: ${error.message}`);
            }
        }

        function clearSupplierForm() {
            document.getElementById('supplierCode').value = generateSupplierCode();
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierCompany').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierRating').value = '3';
            document.getElementById('supplierPaymentMethod').value = 'cash';
            document.getElementById('supplierNotes').value = '';
        }

        function updateSuppliersTable() {
            const tbody = document.getElementById('suppliersTableBody');
            const searchTerm = document.getElementById('searchSuppliers')?.value.toLowerCase() || '';

            if (!tbody) return;

            let filteredSuppliers = suppliers;

            if (searchTerm) {
                filteredSuppliers = suppliers.filter(supplier =>
                    supplier.name.toLowerCase().includes(searchTerm) ||
                    supplier.company.toLowerCase().includes(searchTerm) ||
                    supplier.phone.toLowerCase().includes(searchTerm) ||
                    supplier.code.toLowerCase().includes(searchTerm)
                );
            }

            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #ccc;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            ${searchTerm ? 'لا توجد موردين تطابق البحث' : 'لا توجد موردين حالياً'}<br>
                            <small>${searchTerm ? 'جرب كلمات بحث أخرى' : 'انقر على "إضافة مورد جديد" لبدء إضافة الموردين'}</small>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredSuppliers.map(supplier => `
                <tr>
                    <td>${supplier.code}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.company || 'غير محدد'}</td>
                    <td>${supplier.phone || 'غير محدد'}</td>
                    <td>${supplier.address || 'غير محدد'}</td>
                    <td>${supplier.totalPurchases.toFixed(2)} ${settings.currency}</td>
                    <td style="color: ${supplier.outstandingAmount > 0 ? '#dc3545' : '#28a745'}">
                        ${supplier.outstandingAmount.toFixed(2)} ${settings.currency}
                    </td>
                    <td>
                        ${'⭐'.repeat(supplier.rating)}${'☆'.repeat(5 - supplier.rating)}
                    </td>
                    <td>${supplier.lastDeal ? new Date(supplier.lastDeal).toLocaleDateString('ar-SA') : 'لا يوجد'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editSupplier(${supplier.id})" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="viewSupplierDetails(${supplier.id})" title="التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSupplier(${supplier.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // تحديث الإحصائيات
            updateSuppliersStats();
        }

        function updateSuppliersStats() {
            const activeCount = suppliers.length;
            const totalDebt = suppliers.reduce((sum, supplier) => sum + supplier.outstandingAmount, 0);
            const avgRating = suppliers.length > 0 ? suppliers.reduce((sum, supplier) => sum + supplier.rating, 0) / suppliers.length : 0;

            if (document.getElementById('activeSuppliersCount')) {
                document.getElementById('activeSuppliersCount').textContent = activeCount;
                document.getElementById('totalSupplierDebt').textContent = totalDebt.toFixed(2);
                document.getElementById('averageSupplierRating').textContent = avgRating.toFixed(1);
            }
        }

        // وظائف العملاء
        function showAddCustomerModal() {
            showModal('addCustomerModal');
            // تعيين كود تلقائي
            document.getElementById('customerCode').value = generateCustomerCode();
        }

        function generateCustomerCode() {
            const count = customers.length + 1;
            return `CUS${count.toString().padStart(3, '0')}`;
        }

        function saveCustomer() {
            try {
                // جمع البيانات
                const customerData = {
                    code: document.getElementById('customerCode').value.trim(),
                    name: document.getElementById('customerName').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    address: document.getElementById('customerAddress').value.trim(),
                    type: document.getElementById('customerType').value,
                    creditLimit: parseFloat(document.getElementById('customerCreditLimit').value) || 0,
                    paymentDays: parseInt(document.getElementById('customerPaymentDays').value) || 30,
                    preferredTime: document.getElementById('customerPreferredTime').value,
                    isVIP: document.getElementById('customerVIP').checked,
                    notes: document.getElementById('customerNotes').value.trim()
                };

                // التحقق من صحة البيانات باستخدام ValidationUtils
                const validation = ValidationUtils.validateCustomer(customerData);
                if (!validation.isValid) {
                    NotificationUtils.showWarning(validation.errors.join('<br>'));
                    return;
                }

                // التحقق من عدم تكرار الكود
                if (customers.find(c => c.code === customerData.code)) {
                    NotificationUtils.showWarning('كود العميل موجود مسبقاً!');
                    return;
                }

                // إنشاء العميل الجديد
                const newCustomer = {
                    id: Date.now(),
                    ...customerData,
                    totalPurchases: 0,
                    outstandingDebt: 0,
                    loyaltyPoints: 0,
                    lastPurchase: null,
                    createdAt: new Date().toISOString(),
                    isActive: true,
                    membershipLevel: 'bronze' // برونزي، فضي، ذهبي، بلاتيني
                };

                // استخدام StateManager لتحديث البيانات
                const result = StateManager.updateSection('customers', {
                    action: 'add',
                    customer: newCustomer
                });

                if (result.success) {
                    closeModal('addCustomerModal');
                    clearCustomerForm();
                    NotificationUtils.showSuccess(`تم إضافة العميل "${customerData.name}" بنجاح! 🎉`);
                }

            } catch (error) {
                NotificationUtils.showError(`خطأ في حفظ العميل: ${error.message}`);
            }
        }

        function clearCustomerForm() {
            document.getElementById('customerCode').value = generateCustomerCode();
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerType').value = 'normal';
            document.getElementById('customerCreditLimit').value = '0';
            document.getElementById('customerPaymentDays').value = '30';
            document.getElementById('customerPreferredTime').value = 'afternoon';
            document.getElementById('customerVIP').checked = false;
            document.getElementById('customerNotes').value = '';
        }

        // وظيفة محسنة لحساب خصم العميل
        function calculateCustomerDiscount(customerId, amount) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return 0;

            let discountPercentage = DiscountUtils.getCustomerDiscount(customer.type);

            // خصم إضافي للعملاء VIP
            if (customer.isVIP) {
                discountPercentage += 2;
            }

            // خصم حسب مستوى العضوية
            const membershipDiscounts = {
                bronze: 0,
                silver: 1,
                gold: 3,
                platinum: 5
            };

            discountPercentage += membershipDiscounts[customer.membershipLevel] || 0;

            return DiscountUtils.calculateDiscount(amount, discountPercentage);
        }

        // تحديث مستوى عضوية العميل حسب نقاط الولاء
        function updateCustomerMembershipLevel(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const points = customer.loyaltyPoints;
            let newLevel = 'bronze';

            if (points >= 10000) {
                newLevel = 'platinum';
            } else if (points >= 5000) {
                newLevel = 'gold';
            } else if (points >= 1000) {
                newLevel = 'silver';
            }

            if (customer.membershipLevel !== newLevel) {
                customer.membershipLevel = newLevel;
                NotificationUtils.showSuccess(`تم ترقية العميل ${customer.name} إلى مستوى ${newLevel}! 🎉`);
            }
        }

        function updateCustomersTable() {
            const tbody = document.getElementById('customersTableBody');
            const searchTerm = document.getElementById('searchCustomers')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('filterCustomerType')?.value || '';
            const debtFilter = document.getElementById('filterDebtStatus')?.value || '';

            if (!tbody) return;

            let filteredCustomers = customers;

            // تطبيق الفلاتر
            if (searchTerm) {
                filteredCustomers = filteredCustomers.filter(customer =>
                    customer.name.toLowerCase().includes(searchTerm) ||
                    customer.phone.toLowerCase().includes(searchTerm) ||
                    customer.address.toLowerCase().includes(searchTerm) ||
                    customer.code.toLowerCase().includes(searchTerm)
                );
            }

            if (typeFilter) {
                filteredCustomers = filteredCustomers.filter(customer => customer.type === typeFilter);
            }

            if (debtFilter) {
                filteredCustomers = filteredCustomers.filter(customer => {
                    switch(debtFilter) {
                        case 'no-debt': return customer.outstandingDebt === 0;
                        case 'has-debt': return customer.outstandingDebt > 0;
                        case 'overdue': return customer.outstandingDebt > 0 && isOverdue(customer);
                        default: return true;
                    }
                });
            }

            if (filteredCustomers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #ccc;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            ${searchTerm || typeFilter || debtFilter ? 'لا توجد عملاء تطابق الفلاتر' : 'لا توجد عملاء حالياً'}<br>
                            <small>${searchTerm || typeFilter || debtFilter ? 'جرب فلاتر أخرى' : 'انقر على "إضافة عميل جديد" لبدء إضافة العملاء'}</small>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredCustomers.map(customer => `
                <tr>
                    <td>${customer.code}</td>
                    <td>
                        ${customer.name}
                        ${customer.isVIP ? '<span style="color: gold; margin-right: 5px;">👑</span>' : ''}
                    </td>
                    <td>${customer.phone || 'غير محدد'}</td>
                    <td>${customer.address || 'غير محدد'}</td>
                    <td>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${getCustomerTypeColor(customer.type)};">
                            ${getCustomerTypeLabel(customer.type)}
                        </span>
                    </td>
                    <td>${customer.totalPurchases.toFixed(2)} ${settings.currency}</td>
                    <td style="color: ${customer.outstandingDebt > 0 ? '#dc3545' : '#28a745'}">
                        ${customer.outstandingDebt.toFixed(2)} ${settings.currency}
                        ${isOverdue(customer) ? '<span style="color: #dc3545;">⚠️</span>' : ''}
                    </td>
                    <td>${customer.lastPurchase ? new Date(customer.lastPurchase).toLocaleDateString('ar-SA') : 'لا يوجد'}</td>
                    <td>
                        <span style="color: #ffc107;">⭐</span> ${customer.loyaltyPoints}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editCustomer(${customer.id})" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="viewCustomerDetails(${customer.id})" title="التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="sendWhatsAppToCustomer(${customer.id})" title="واتساب">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // تحديث الإحصائيات
            updateCustomersStats();
        }

        function getCustomerTypeColor(type) {
            const colors = {
                normal: 'rgba(23,162,184,0.2)',
                wholesale: 'rgba(255,193,7,0.2)',
                trader: 'rgba(40,167,69,0.2)'
            };
            return colors[type] || colors.normal;
        }

        function getCustomerTypeLabel(type) {
            const labels = {
                normal: 'عادي',
                wholesale: 'جملة',
                trader: 'تاجر'
            };
            return labels[type] || 'عادي';
        }

        function isOverdue(customer) {
            if (customer.outstandingDebt === 0 || !customer.lastPurchase) return false;
            const daysSinceLastPurchase = (Date.now() - new Date(customer.lastPurchase).getTime()) / (1000 * 60 * 60 * 24);
            return daysSinceLastPurchase > customer.paymentDays;
        }

        function updateCustomersStats() {
            const activeCount = customers.filter(c => c.totalPurchases > 0).length;
            const totalDebt = customers.reduce((sum, customer) => sum + customer.outstandingDebt, 0);
            const overdueCount = customers.filter(isOverdue).length;
            const vipCount = customers.filter(c => c.isVIP).length;
            const totalLoyaltyPoints = customers.reduce((sum, customer) => sum + customer.loyaltyPoints, 0);

            if (document.getElementById('activeCustomersCount')) {
                document.getElementById('activeCustomersCount').textContent = activeCount;
                document.getElementById('totalCustomerDebt').textContent = totalDebt.toFixed(2);
                document.getElementById('overdueCustomersCount').textContent = overdueCount;
                document.getElementById('vipCustomersCount').textContent = vipCount;
                document.getElementById('totalLoyaltyPoints').textContent = totalLoyaltyPoints;
            }
        }

        function clearCustomersFilter() {
            document.getElementById('searchCustomers').value = '';
            document.getElementById('filterCustomerType').value = '';
            document.getElementById('filterDebtStatus').value = '';
            updateCustomersTable();
        }

        // وظائف المصروفات
        function showAddExpenseModal() {
            showModal('addExpenseModal');
            // تعيين التاريخ الحالي
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        function saveExpense() {
            try {
                // جمع البيانات
                const expenseData = {
                    type: document.getElementById('expenseType').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    description: document.getElementById('expenseDescription').value.trim(),
                    date: document.getElementById('expenseDate').value,
                    paymentMethod: document.getElementById('expensePaymentMethod').value,
                    responsible: document.getElementById('expenseResponsible').value.trim() || 'غير محدد',
                    receiptNumber: document.getElementById('expenseReceiptNumber').value.trim(),
                    notes: document.getElementById('expenseNotes').value.trim(),
                    isRecurring: document.getElementById('expenseRecurring').checked
                };

                // التحقق من صحة البيانات باستخدام ValidationUtils
                const validation = ValidationUtils.validateExpense(expenseData);
                if (!validation.isValid) {
                    NotificationUtils.showWarning(validation.errors.join('<br>'));
                    return;
                }

                // التحقق من الميزانية
                if (settings.monthlyBudget) {
                    const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                    const currentMonthExpenses = expenses
                        .filter(e => new Date(e.date) >= monthStart)
                        .reduce((sum, e) => sum + e.amount, 0);

                    const newTotal = currentMonthExpenses + expenseData.amount;
                    const budgetUsage = (newTotal / settings.monthlyBudget) * 100;

                    if (budgetUsage > 100) {
                        const confirm = window.confirm(
                            `تحذير: هذا المصروف سيتجاوز الميزانية الشهرية بنسبة ${budgetUsage.toFixed(1)}%\n\nهل تريد المتابعة؟`
                        );
                        if (!confirm) return;
                    } else if (budgetUsage > 90) {
                        NotificationUtils.showWarning(`تنبيه: استهلكت ${budgetUsage.toFixed(1)}% من الميزانية الشهرية`);
                    }
                }

                // إنشاء المصروف الجديد
                const newExpense = {
                    id: Date.now(),
                    ...expenseData,
                    createdAt: new Date().toISOString(),
                    status: 'completed'
                };

                // استخدام StateManager لتحديث البيانات
                const result = StateManager.updateSection('expenses', {
                    action: 'add',
                    expense: newExpense
                });

                if (result.success) {
                    closeModal('addExpenseModal');
                    clearExpenseForm();
                    NotificationUtils.showSuccess(`تم إضافة المصروف "${expenseData.description}" بنجاح! 💰`);

                    // إضافة المصروف المتكرر للشهر القادم إذا كان مطلوباً
                    if (expenseData.isRecurring) {
                        scheduleRecurringExpense(newExpense);
                    }
                }

            } catch (error) {
                NotificationUtils.showError(`خطأ في حفظ المصروف: ${error.message}`);
            }
        }

        function clearExpenseForm() {
            document.getElementById('expenseType').value = 'operational';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expensePaymentMethod').value = 'cash';
            document.getElementById('expenseResponsible').value = '';
            document.getElementById('expenseReceiptNumber').value = '';
            document.getElementById('expenseNotes').value = '';
            document.getElementById('expenseRecurring').checked = false;
        }

        function scheduleRecurringExpense(expense) {
            // إضافة المصروف للشهر القادم
            const nextMonth = new Date(expense.date);
            nextMonth.setMonth(nextMonth.getMonth() + 1);

            const recurringExpense = {
                ...expense,
                id: Date.now() + 1,
                date: nextMonth.toISOString().split('T')[0],
                status: 'scheduled',
                parentExpenseId: expense.id
            };

            // حفظ في قائمة المصروفات المجدولة
            if (!window.scheduledExpenses) {
                window.scheduledExpenses = [];
            }
            window.scheduledExpenses.push(recurringExpense);

            NotificationUtils.showInfo(`تم جدولة المصروف للشهر القادم: ${nextMonth.toLocaleDateString('ar-SA')}`);
        }

        // وظيفة عرض الخزنة المحسنة
        function updateCashboxDisplay() {
            const balance = CashboxUtils.getBalance();
            const recentTransactions = CashboxUtils.getTransactionHistory(10);

            // تحديث رصيد الخزنة في لوحة التحكم
            if (document.getElementById('cashBalance')) {
                document.getElementById('cashBalance').textContent = CurrencyUtils.format(balance);

                // تغيير اللون حسب الرصيد
                const element = document.getElementById('cashBalance');
                if (balance < 0) {
                    element.style.color = '#dc3545';
                } else if (balance < 1000) {
                    element.style.color = '#ffc107';
                } else {
                    element.style.color = '#28a745';
                }
            }

            // عرض آخر المعاملات
            displayRecentTransactions(recentTransactions);
        }

        function displayRecentTransactions(transactions) {
            // يمكن إضافة عرض للمعاملات الأخيرة في قسم منفصل
            console.log('Recent transactions:', transactions);
        }

        // وظيفة تحليل المصروفات
        function analyzeExpenses() {
            const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const monthExpenses = expenses.filter(e => new Date(e.date) >= monthStart);

            // تجميع حسب النوع
            const expensesByType = {};
            monthExpenses.forEach(expense => {
                if (!expensesByType[expense.type]) {
                    expensesByType[expense.type] = 0;
                }
                expensesByType[expense.type] += expense.amount;
            });

            // العثور على أكبر مصروف
            const largestExpense = monthExpenses.reduce((max, expense) =>
                expense.amount > max.amount ? expense : max,
                { amount: 0 }
            );

            return {
                totalThisMonth: monthExpenses.reduce((sum, e) => sum + e.amount, 0),
                expensesByType: expensesByType,
                largestExpense: largestExpense,
                averageDaily: monthExpenses.reduce((sum, e) => sum + e.amount, 0) / new Date().getDate()
            };
        }

        function updateExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            const searchTerm = document.getElementById('searchExpenses')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('filterExpenseType')?.value || '';
            const fromDate = document.getElementById('filterExpenseFromDate')?.value || '';
            const toDate = document.getElementById('filterExpenseToDate')?.value || '';

            if (!tbody) return;

            let filteredExpenses = expenses;

            // تطبيق الفلاتر
            if (searchTerm) {
                filteredExpenses = filteredExpenses.filter(expense =>
                    expense.description.toLowerCase().includes(searchTerm) ||
                    expense.notes.toLowerCase().includes(searchTerm) ||
                    expense.responsible.toLowerCase().includes(searchTerm)
                );
            }

            if (typeFilter) {
                filteredExpenses = filteredExpenses.filter(expense => expense.type === typeFilter);
            }

            if (fromDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date >= fromDate);
            }

            if (toDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date <= toDate);
            }

            // ترتيب حسب التاريخ (الأحدث أولاً)
            filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredExpenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #ccc;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            ${searchTerm || typeFilter || fromDate || toDate ? 'لا توجد مصروفات تطابق الفلاتر' : 'لا توجد مصروفات مسجلة'}<br>
                            <small>${searchTerm || typeFilter || fromDate || toDate ? 'جرب فلاتر أخرى' : 'انقر على "إضافة مصروف" لبدء تسجيل المصروفات'}</small>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredExpenses.map(expense => `
                <tr>
                    <td>${new Date(expense.date).toLocaleDateString('ar-SA')}</td>
                    <td>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${getExpenseTypeColor(expense.type)};">
                            ${getExpenseTypeLabel(expense.type)}
                        </span>
                    </td>
                    <td>${expense.description}</td>
                    <td style="color: #dc3545; font-weight: bold;">${expense.amount.toFixed(2)} ${settings.currency}</td>
                    <td>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${getPaymentMethodColor(expense.paymentMethod)};">
                            ${getPaymentMethodLabel(expense.paymentMethod)}
                        </span>
                    </td>
                    <td>${expense.notes || 'لا توجد'}</td>
                    <td>${expense.responsible}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editExpense(${expense.id})" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="viewExpenseDetails(${expense.id})" title="التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteExpense(${expense.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // تحديث إحصائيات المصروفات
            updateExpensesStats();
        }

        function getExpenseTypeColor(type) {
            const colors = {
                operational: 'rgba(23,162,184,0.2)',
                maintenance: 'rgba(255,193,7,0.2)',
                marketing: 'rgba(111,66,193,0.2)',
                utilities: 'rgba(40,167,69,0.2)',
                rent: 'rgba(220,53,69,0.2)',
                salaries: 'rgba(102,126,234,0.2)',
                transportation: 'rgba(253,126,20,0.2)',
                office: 'rgba(32,201,151,0.2)',
                other: 'rgba(108,117,125,0.2)'
            };
            return colors[type] || colors.other;
        }

        function getExpenseTypeLabel(type) {
            const labels = {
                operational: 'تشغيلي',
                maintenance: 'صيانة',
                marketing: 'تسويق',
                utilities: 'مرافق',
                rent: 'إيجار',
                salaries: 'رواتب',
                transportation: 'مواصلات',
                office: 'مكتبية',
                other: 'أخرى'
            };
            return labels[type] || 'أخرى';
        }

        function getPaymentMethodColor(method) {
            const colors = {
                cash: 'rgba(40,167,69,0.2)',
                bank: 'rgba(23,162,184,0.2)',
                card: 'rgba(111,66,193,0.2)',
                check: 'rgba(255,193,7,0.2)'
            };
            return colors[method] || colors.cash;
        }

        function getPaymentMethodLabel(method) {
            const labels = {
                cash: 'نقدي',
                bank: 'تحويل بنكي',
                card: 'بطاقة ائتمان',
                check: 'شيك'
            };
            return labels[method] || 'نقدي';
        }

        function updateExpensesStats() {
            const today = new Date();
            const weekStart = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            const todayExpenses = expenses.filter(e => new Date(e.date).toDateString() === today.toDateString())
                .reduce((sum, expense) => sum + expense.amount, 0);

            const weekExpenses = expenses.filter(e => new Date(e.date) >= weekStart)
                .reduce((sum, expense) => sum + expense.amount, 0);

            const monthExpenses = expenses.filter(e => new Date(e.date) >= monthStart)
                .reduce((sum, expense) => sum + expense.amount, 0);

            const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);

            if (document.getElementById('todayExpenses')) {
                document.getElementById('todayExpenses').textContent = `${todayExpenses.toFixed(2)} ${settings.currency}`;
                document.getElementById('weekExpenses').textContent = `${weekExpenses.toFixed(2)} ${settings.currency}`;
                document.getElementById('monthExpenses').textContent = `${monthExpenses.toFixed(2)} ${settings.currency}`;
                document.getElementById('totalExpenses').textContent = `${totalExpenses.toFixed(2)} ${settings.currency}`;
            }
        }

        function clearExpensesFilter() {
            document.getElementById('searchExpenses').value = '';
            document.getElementById('filterExpenseType').value = '';
            document.getElementById('filterExpenseFromDate').value = '';
            document.getElementById('filterExpenseToDate').value = '';
            updateExpensesTable();
        }

        // وظائف استعلام الفواتير
        function searchInvoices() {
            const invoiceNumber = document.getElementById('searchInvoiceNumber').value.trim();
            const customerName = document.getElementById('searchCustomerName').value.trim().toLowerCase();
            const productName = document.getElementById('searchProductName').value.trim().toLowerCase();
            const fromDate = document.getElementById('searchFromDate').value;
            const toDate = document.getElementById('searchToDate').value;
            const invoiceType = document.getElementById('searchInvoiceType').value;

            let filteredInvoices = [...sales]; // نسخ من مصفوفة المبيعات

            // تطبيق الفلاتر
            if (invoiceNumber) {
                filteredInvoices = filteredInvoices.filter(invoice =>
                    invoice.invoiceNumber && invoice.invoiceNumber.includes(invoiceNumber)
                );
            }

            if (customerName) {
                filteredInvoices = filteredInvoices.filter(invoice =>
                    invoice.customerName && invoice.customerName.toLowerCase().includes(customerName)
                );
            }

            if (productName) {
                filteredInvoices = filteredInvoices.filter(invoice =>
                    invoice.productName && invoice.productName.toLowerCase().includes(productName)
                );
            }

            if (fromDate) {
                filteredInvoices = filteredInvoices.filter(invoice =>
                    invoice.date >= fromDate
                );
            }

            if (toDate) {
                filteredInvoices = filteredInvoices.filter(invoice =>
                    invoice.date <= toDate
                );
            }

            if (invoiceType) {
                filteredInvoices = filteredInvoices.filter(invoice =>
                    invoice.type === invoiceType
                );
            }

            updateInvoicesTable(filteredInvoices);
        }

        function updateInvoicesTable(invoicesToShow = sales) {
            const tbody = document.getElementById('invoicesTableBody');
            if (!tbody) return;

            if (invoicesToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #ccc;">
                            <i class="fas fa-file-invoice" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            لا توجد فواتير تطابق البحث<br>
                            <small>جرب معايير بحث أخرى</small>
                        </td>
                    </tr>
                `;
                return;
            }

            // ترتيب حسب التاريخ (الأحدث أولاً)
            const sortedInvoices = invoicesToShow.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = sortedInvoices.map(invoice => `
                <tr>
                    <td>${invoice.invoiceNumber || 'غير محدد'}</td>
                    <td>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: rgba(40,167,69,0.2);">
                            مبيعات
                        </span>
                    </td>
                    <td>${invoice.customerName || 'عميل نقدي'}</td>
                    <td>${new Date(invoice.date).toLocaleDateString('ar-SA')}</td>
                    <td>${(invoice.total + (invoice.discount || 0)).toFixed(2)} ${settings.currency}</td>
                    <td>${(invoice.discount || 0).toFixed(2)} ${settings.currency}</td>
                    <td style="color: #28a745; font-weight: bold;">${invoice.total.toFixed(2)} ${settings.currency}</td>
                    <td>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${getPaymentMethodColor(invoice.paymentMethod || 'cash')};">
                            ${getPaymentMethodLabel(invoice.paymentMethod || 'cash')}
                        </span>
                    </td>
                    <td>
                        <span style="color: #28a745;">✅ مكتملة</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewInvoiceDetails(${invoice.id})" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="printInvoice(${invoice.id})" title="طباعة">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="sendInvoiceWhatsApp(${invoice.id})" title="إرسال واتساب">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function clearInvoiceSearch() {
            document.getElementById('searchInvoiceNumber').value = '';
            document.getElementById('searchCustomerName').value = '';
            document.getElementById('searchProductName').value = '';
            document.getElementById('searchFromDate').value = '';
            document.getElementById('searchToDate').value = '';
            document.getElementById('searchInvoiceType').value = '';
            updateInvoicesTable();
        }

        function newPOSTransaction() {
            showQuickSaleModal();
        }

        function completePOSTransaction() {
            showQuickSaleModal();
        }

        function refreshDashboard() {
            updateDashboard();
            showToast('تم تحديث البيانات بنجاح! 🔄', 'success');
        }

        function saveSettings() {
            const storeName = document.getElementById('storeName').value;
            const currency = document.getElementById('currency').value;
            const lowStockThreshold = parseInt(document.getElementById('lowStockThreshold').value);

            settings.storeName = storeName;
            settings.currency = currency;
            settings.lowStockThreshold = lowStockThreshold;

            localStorage.setItem('storeSettings', JSON.stringify(settings));
            showToast('تم حفظ الإعدادات بنجاح! 💾', 'success');
        }

        function toggleNotifications() {
            showToast('لا توجد إشعارات جديدة حالياً! 🔔', 'info');
        }

        function editProduct(productId) {
            const operationId = PerformanceMonitor.logOperation('editProduct');
            try {
                const product = products.find(p => p.id === productId);
                if (!product) {
                    NotificationUtils.showError('المنتج غير موجود');
                    PerformanceMonitor.endOperation(operationId, false);
                    return;
                }

                // ملء النموذج بالبيانات الحالية
                document.getElementById('productCode').value = product.code || '';
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productCostPrice').value = product.costPrice || '';
                document.getElementById('productSellPrice').value = product.sellPrice || '';
                document.getElementById('productQuantity').value = product.quantity || '';
                document.getElementById('productDescription').value = product.description || '';

                // تغيير عنوان النموذج
                const modalTitle = document.querySelector('#addProductModal .modal-title');
                if (modalTitle) modalTitle.textContent = 'تعديل المنتج';

                // تغيير زر الحفظ
                const saveBtn = document.querySelector('#addProductModal .btn-primary');
                if (saveBtn) {
                    saveBtn.textContent = 'تحديث المنتج';
                    saveBtn.onclick = () => updateProduct(productId);
                }

                showModal('addProductModal');
                ActivityLogger.log('editProduct', { productName: product.name, productId: productId });
                PerformanceMonitor.endOperation(operationId, true);
            } catch (error) {
                ErrorHandler.logError(error, 'editProduct', 'medium');
                PerformanceMonitor.endOperation(operationId, false);
            }
        }

        function updateProduct(productId) {
            const operationId = PerformanceMonitor.logOperation('updateProduct');
            try {
                // جمع البيانات بسرعة
                const formData = {
                    code: document.getElementById('productCode').value.trim(),
                    name: document.getElementById('productName').value.trim(),
                    category: document.getElementById('productCategory').value,
                    costPrice: parseFloat(document.getElementById('productCostPrice').value) || 0,
                    sellPrice: parseFloat(document.getElementById('productSellPrice').value) || 0,
                    quantity: parseInt(document.getElementById('productQuantity').value) || 0,
                    description: document.getElementById('productDescription').value.trim()
                };

                // التحقق السريع
                if (!formData.code || !formData.name) {
                    NotificationUtils.showWarning('كود المنتج والاسم مطلوبان! ⚠️');
                    PerformanceMonitor.endOperation(operationId, false);
                    return;
                }

                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex === -1) {
                    NotificationUtils.showError('المنتج غير موجود');
                    PerformanceMonitor.endOperation(operationId, false);
                    return;
                }

                // تحديث سريع
                products[productIndex] = {
                    ...products[productIndex],
                    ...formData,
                    lastModified: new Date().toISOString()
                };

                // حفظ وتحديث متوازي
                saveData();
                setTimeout(() => {
                    updateProductsTable();
                    updatePOSProducts();
                    updateDashboard();
                }, 0);

                StateManager.updateSection('products', products[productIndex]);
                closeModal('addProductModal');
                resetProductModal();

                // إشعار مختصر
                NotificationUtils.showSuccess(`تم تحديث "${formData.name}" ✅`);
                ActivityLogger.log('updateProduct', { productName: formData.name, productId: productId });
                PerformanceMonitor.endOperation(operationId, true);
            } catch (error) {
                ErrorHandler.logError(error, 'updateProduct', 'medium');
                PerformanceMonitor.endOperation(operationId, false);
            }
        }

        function resetProductModal() {
            // إعادة تعيين عنوان النموذج
            const modalTitle = document.querySelector('#addProductModal .modal-title');
            if (modalTitle) modalTitle.textContent = 'إضافة منتج جديد';

            // إعادة تعيين زر الحفظ
            const saveBtn = document.querySelector('#addProductModal .btn-primary');
            if (saveBtn) {
                saveBtn.textContent = 'حفظ المنتج';
                saveBtn.onclick = saveProduct;
            }
        }

        function deleteProduct(productId) {
            const operationId = PerformanceMonitor.logOperation('deleteProduct');
            try {
                const product = products.find(p => p.id === productId);
                if (!product) {
                    NotificationUtils.showError('المنتج غير موجود');
                    PerformanceMonitor.endOperation(operationId, false);
                    return;
                }

                if (confirm(`حذف "${product.name}"؟`)) {
                    // حذف سريع
                    products = products.filter(p => p.id !== productId);
                    saveData();

                    // تحديث متوازي
                    setTimeout(() => {
                        updateProductsTable();
                        updatePOSProducts();
                        updateDashboard();
                    }, 0);

                    StateManager.updateSection('products', { deleted: productId });

                    // إشعار مختصر
                    NotificationUtils.showSuccess(`تم حذف "${product.name}" 🗑️`);
                    ActivityLogger.log('deleteProduct', { productName: product.name, productId: productId });
                    PerformanceMonitor.endOperation(operationId, true);
                } else {
                    PerformanceMonitor.endOperation(operationId, false);
                }
            } catch (error) {
                ErrorHandler.logError(error, 'deleteProduct', 'medium');
                PerformanceMonitor.endOperation(operationId, false);
            }
        }

        // ===== نظام تسجيل العمليات المحسن =====

        const ActivityLogger = {
            activities: [],

            // تسجيل نشاط
            log(action, details = {}, userId = 'system') {
                const activity = {
                    id: Date.now(),
                    action: action,
                    details: details,
                    userId: userId,
                    timestamp: new Date().toISOString(),
                    sessionId: this.getSessionId()
                };

                this.activities.push(activity);

                // الاحتفاظ بآخر 1000 نشاط فقط
                if (this.activities.length > 1000) {
                    this.activities = this.activities.slice(-1000);
                }

                console.log(`📝 تم تسجيل النشاط: ${action}`, details);

                // حفظ في التخزين المحلي
                localStorage.setItem('activityLog', JSON.stringify(this.activities.slice(-100)));
            },

            // الحصول على معرف الجلسة
            getSessionId() {
                let sessionId = localStorage.getItem('sessionId');
                if (!sessionId) {
                    sessionId = 'session_' + Date.now();
                    localStorage.setItem('sessionId', sessionId);
                }
                return sessionId;
            },

            // الحصول على الأنشطة الأخيرة
            getRecentActivities(limit = 50) {
                return this.activities.slice(-limit).reverse();
            },

            // عرض سجل الأنشطة
            showActivityLog() {
                const recent = this.getRecentActivities(20);
                console.log('📋 سجل الأنشطة الأخيرة:');
                recent.forEach(activity => {
                    console.log(`- ${new Date(activity.timestamp).toLocaleString('ar-SA')}: ${activity.action}`);
                });

                NotificationUtils.showInfo(`📋 تم عرض آخر ${recent.length} نشاط في وحدة التحكم`);
            },

            // تحميل سجل الأنشطة المحفوظ
            loadActivityLog() {
                try {
                    const saved = localStorage.getItem('activityLog');
                    if (saved) {
                        const savedActivities = JSON.parse(saved);
                        this.activities = [...this.activities, ...savedActivities];
                        console.log(`📂 تم تحميل ${savedActivities.length} نشاط محفوظ`);
                    }
                } catch (error) {
                    console.error('❌ خطأ في تحميل سجل الأنشطة:', error);
                }
            }
        };

        // ===== تحميل وحفظ البيانات المحسن =====

        function saveData() {
            try {
                // حفظ سريع ومتوازي
                const saveOperations = [
                    ['storeProducts', products],
                    ['storeSales', sales],
                    ['storeSettings', settings],
                    ['storeSuppliers', suppliers],
                    ['storeCustomers', customers],
                    ['storeExpenses', expenses],
                    ['storeCashbox', cashbox]
                ];

                saveOperations.forEach(([key, data]) => {
                    localStorage.setItem(key, JSON.stringify(data));
                });

                // حفظ معلومات إضافية
                localStorage.setItem('lastDataUpdate', new Date().toISOString());
                localStorage.setItem('dataVersion', '2.0.0');

                // حساب حجم البيانات
                const dataSize = new Blob([JSON.stringify({
                    products, sales, settings, suppliers, customers, expenses, cashbox
                })]).size;

                localStorage.setItem('dataSize', dataSize.toString());

                console.log(`✅ تم حفظ البيانات بنجاح (${(dataSize / 1024).toFixed(2)} KB)`);

                // تسجيل النشاط
                ActivityLogger.log('saveData', {
                    dataSize: dataSize,
                    timestamp: new Date().toISOString()
                });

                // إشعار نجاح (فقط في حالات معينة لتجنب الإزعاج)
                if (window.showSaveNotification) {
                    NotificationUtils.showSuccess('تم حفظ البيانات بنجاح! 💾');
                    window.showSaveNotification = false;
                }

            } catch (error) {
                console.error('❌ خطأ في حفظ البيانات:', error);
                NotificationUtils.showError(`خطأ في حفظ البيانات: ${error.message}`);
            }
        }

        function loadData() {
            try {
                console.log('📂 بدء تحميل البيانات...');

                // تحميل المنتجات
                const savedProducts = localStorage.getItem('storeProducts');
                if (savedProducts) {
                    products = JSON.parse(savedProducts);
                    console.log(`✅ تم تحميل ${products.length} منتج`);
                }

                // تحميل المبيعات
                const savedSales = localStorage.getItem('storeSales');
                if (savedSales) {
                    sales = JSON.parse(savedSales);
                    console.log(`✅ تم تحميل ${sales.length} عملية بيع`);
                }

                // تحميل الإعدادات
                const savedSettings = localStorage.getItem('storeSettings');
                if (savedSettings) {
                    settings = { ...settings, ...JSON.parse(savedSettings) };
                    console.log('✅ تم تحميل الإعدادات');

                    // تحديث الحقول
                    if (document.getElementById('storeName')) {
                        document.getElementById('storeName').value = settings.storeName;
                        document.getElementById('currency').value = settings.currency;
                        document.getElementById('lowStockThreshold').value = settings.lowStockThreshold;
                    }
                }

                // تحميل البيانات الجديدة
                const savedSuppliers = localStorage.getItem('storeSuppliers');
                const savedCustomers = localStorage.getItem('storeCustomers');
                const savedExpenses = localStorage.getItem('storeExpenses');
                const savedCashbox = localStorage.getItem('storeCashbox');

                if (savedSuppliers) {
                    suppliers = JSON.parse(savedSuppliers);
                    console.log(`✅ تم تحميل ${suppliers.length} مورد`);
                } else {
                    suppliers = [];
                }

                if (savedCustomers) {
                    customers = JSON.parse(savedCustomers);
                    console.log(`✅ تم تحميل ${customers.length} عميل`);
                } else {
                    customers = [];
                }

                if (savedExpenses) {
                    expenses = JSON.parse(savedExpenses);
                    console.log(`✅ تم تحميل ${expenses.length} مصروف`);
                } else {
                    expenses = [];
                }

                if (savedCashbox) {
                    cashbox = JSON.parse(savedCashbox);
                    console.log(`✅ تم تحميل بيانات الخزنة - الرصيد: ${cashbox.balance}`);
                } else {
                    cashbox = {
                        balance: 0,
                        transactions: []
                    };
                    console.log('🆕 تم إنشاء خزنة جديدة');
                }

                console.log('🎉 تم تحميل جميع البيانات بنجاح');

            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات:', error);
                NotificationUtils.showError(`خطأ في تحميل البيانات: ${error.message}`);

                // إعادة تعيين البيانات في حالة الخطأ
                initializeEmptyData();
            }
        }

        function initializeEmptyData() {
            console.log('🔄 إعادة تعيين البيانات...');

            // تهيئة البيانات الأساسية
            if (!Array.isArray(products)) products = [];
            if (!Array.isArray(sales)) sales = [];
            if (!Array.isArray(suppliers)) suppliers = [];
            if (!Array.isArray(customers)) customers = [];
            if (!Array.isArray(expenses)) expenses = [];

            // تهيئة الخزنة
            if (!cashbox || typeof cashbox !== 'object') {
                cashbox = { balance: 0, transactions: [] };
            }

            // تهيئة الإعدادات
            if (!settings || typeof settings !== 'object') {
                settings = {
                    storeName: 'متجري الاحترافي',
                    currency: 'ريال',
                    lowStockThreshold: 10,
                    normalCustomerDiscount: 0,
                    wholesaleCustomerDiscount: 5,
                    traderCustomerDiscount: 10,
                    taxRate: 0
                };
            }

            console.log('✅ تم إعادة تعيين البيانات');
        }

        // التأكد من سلامة البيانات عند التحميل
        function ensureDataIntegrity() {
            try {
                console.log('🔍 فحص سلامة البيانات...');

                // التأكد من وجود المتغيرات العامة
                if (typeof products === 'undefined') window.products = [];
                if (typeof sales === 'undefined') window.sales = [];
                if (typeof suppliers === 'undefined') window.suppliers = [];
                if (typeof customers === 'undefined') window.customers = [];
                if (typeof expenses === 'undefined') window.expenses = [];
                if (typeof cashbox === 'undefined') window.cashbox = { balance: 0, transactions: [] };
                if (typeof settings === 'undefined') window.settings = {};

                // التأكد من أن البيانات هي مصفوفات
                if (!Array.isArray(products)) window.products = [];
                if (!Array.isArray(sales)) window.sales = [];
                if (!Array.isArray(suppliers)) window.suppliers = [];
                if (!Array.isArray(customers)) window.customers = [];
                if (!Array.isArray(expenses)) window.expenses = [];

                // التأكد من سلامة كل عنصر في المصفوفات
                window.products = products.filter(item => item && typeof item === 'object');
                window.sales = sales.filter(item => item && typeof item === 'object');
                window.suppliers = suppliers.filter(item => item && typeof item === 'object');
                window.customers = customers.filter(item => item && typeof item === 'object');
                window.expenses = expenses.filter(item => item && typeof item === 'object');

                // التأكد من سلامة الخزنة
                if (!cashbox || typeof cashbox !== 'object') {
                    window.cashbox = { balance: 0, transactions: [] };
                }
                if (!Array.isArray(cashbox.transactions)) {
                    window.cashbox.transactions = [];
                }
                if (typeof cashbox.balance !== 'number' || isNaN(cashbox.balance)) {
                    window.cashbox.balance = 0;
                }

                // التأكد من سلامة الإعدادات
                if (!settings || typeof settings !== 'object') {
                    window.settings = {};
                }

                // تعيين القيم الافتراضية للإعدادات
                const defaultSettings = {
                    storeName: 'متجري الاحترافي',
                    currency: 'ريال',
                    lowStockThreshold: 10,
                    normalCustomerDiscount: 0,
                    wholesaleCustomerDiscount: 5,
                    traderCustomerDiscount: 10,
                    taxRate: 0
                };

                Object.keys(defaultSettings).forEach(key => {
                    if (!(key in settings)) {
                        settings[key] = defaultSettings[key];
                    }
                });

                console.log('✅ تم التأكد من سلامة البيانات');
                console.log(`📊 الإحصائيات: ${products.length} منتج، ${sales.length} مبيعة، ${customers.length} عميل، ${suppliers.length} مورد`);

            } catch (error) {
                console.error('❌ خطأ في فحص سلامة البيانات:', error);
                ErrorHandler.logError(error, 'ensureDataIntegrity', 'high');
                initializeEmptyData();
            }
        }

        // ===== نظام التحقق من الاتصال بين الأقسام =====

        const SectionConnectivityChecker = {
            // فحص الاتصال بين الأقسام
            checkSectionConnectivity() {
                console.log('🔗 فحص الاتصال بين الأقسام...');

                const connectivityResults = {};
                const sections = ['dashboard', 'products', 'pos', 'invoice-inquiry', 'suppliers', 'customers', 'expenses', 'backup', 'settings', 'advanced'];

                // فحص كل قسم
                sections.forEach(section => {
                    connectivityResults[section] = this.checkSectionDependencies(section);
                });

                this.generateConnectivityReport(connectivityResults);
                return connectivityResults;
            },

            // فحص تبعيات قسم معين
            checkSectionDependencies(sectionName) {
                const sectionDeps = {
                    dashboard: ['products', 'pos', 'customers', 'suppliers', 'expenses'],
                    products: ['suppliers'],
                    pos: ['products', 'customers'],
                    'invoice-inquiry': ['pos', 'products'],
                    suppliers: [],
                    customers: [],
                    expenses: [],
                    backup: ['products', 'pos', 'customers', 'suppliers', 'expenses'],
                    settings: [],
                    advanced: ['dashboard', 'backup', 'settings']
                };

                const dependencies = sectionDeps[sectionName] || [];
                const results = {
                    section: sectionName,
                    dependencies: dependencies,
                    connected: [],
                    disconnected: [],
                    score: 0
                };

                dependencies.forEach(dep => {
                    // فحص وجود القسم المرتبط
                    const depSection = document.getElementById(dep);
                    if (depSection) {
                        results.connected.push(dep);
                    } else {
                        results.disconnected.push(dep);
                    }
                });

                results.score = dependencies.length > 0 ?
                    (results.connected.length / dependencies.length) * 100 : 100;

                return results;
            },

            // إنشاء تقرير الاتصال
            generateConnectivityReport(results) {
                console.log('📊 تقرير الاتصال بين الأقسام:');

                let totalScore = 0;
                let sectionsCount = 0;

                Object.values(results).forEach(result => {
                    console.log(`- ${result.section}: ${result.score.toFixed(1)}% (${result.connected.length}/${result.dependencies.length})`);
                    if (result.disconnected.length > 0) {
                        console.warn(`  ⚠️ أقسام غير متصلة: ${result.disconnected.join(', ')}`);
                    }
                    totalScore += result.score;
                    sectionsCount++;
                });

                const avgScore = totalScore / sectionsCount;
                console.log(`📈 متوسط الاتصال: ${avgScore.toFixed(1)}%`);

                if (avgScore >= 95) {
                    NotificationUtils.showSuccess(`🔗 جميع الأقسام متصلة بشكل ممتاز! (${avgScore.toFixed(1)}%)`);
                } else if (avgScore >= 80) {
                    NotificationUtils.showInfo(`🔗 الأقسام متصلة بشكل جيد (${avgScore.toFixed(1)}%)`);
                } else {
                    NotificationUtils.showWarning(`⚠️ بعض الأقسام غير متصلة بشكل صحيح (${avgScore.toFixed(1)}%)`);
                }

                return avgScore;
            }
        };

        // ===== نظام إدارة الأخطاء المحسن =====

        const ErrorHandler = {
            errors: [],

            // تسجيل خطأ
            logError(error, context = '', severity = 'medium') {
                const errorRecord = {
                    id: Date.now(),
                    message: error.message || error,
                    stack: error.stack || '',
                    context: context,
                    severity: severity,
                    timestamp: new Date().toISOString(),
                    url: window.location.href,
                    userAgent: navigator.userAgent
                };

                this.errors.push(errorRecord);

                // الاحتفاظ بآخر 100 خطأ فقط
                if (this.errors.length > 100) {
                    this.errors = this.errors.slice(-100);
                }

                console.error(`❌ خطأ ${severity}:`, errorRecord);

                // تسجيل في سجل الأنشطة
                ActivityLogger.log('error', {
                    message: errorRecord.message,
                    context: context,
                    severity: severity
                });

                // عرض إشعار حسب شدة الخطأ
                this.showErrorNotification(errorRecord);

                // حفظ الأخطاء الحرجة
                if (severity === 'critical') {
                    localStorage.setItem('criticalErrors', JSON.stringify(this.errors.filter(e => e.severity === 'critical')));
                }
            },

            // عرض إشعار الخطأ
            showErrorNotification(errorRecord) {
                switch(errorRecord.severity) {
                    case 'critical':
                        NotificationUtils.showError(`خطأ حرج: ${errorRecord.message}`);
                        break;
                    case 'high':
                        NotificationUtils.showWarning(`خطأ مهم: ${errorRecord.message}`);
                        break;
                    case 'medium':
                        // لا نعرض إشعار للأخطاء المتوسطة لتجنب الإزعاج
                        break;
                    case 'low':
                        // لا نعرض إشعار للأخطاء البسيطة
                        break;
                }
            },

            // الحصول على إحصائيات الأخطاء
            getErrorStats() {
                const stats = {
                    total: this.errors.length,
                    critical: this.errors.filter(e => e.severity === 'critical').length,
                    high: this.errors.filter(e => e.severity === 'high').length,
                    medium: this.errors.filter(e => e.severity === 'medium').length,
                    low: this.errors.filter(e => e.severity === 'low').length,
                    recent: this.errors.filter(e => Date.now() - new Date(e.timestamp).getTime() < 3600000).length // آخر ساعة
                };

                return stats;
            },

            // عرض تقرير الأخطاء
            showErrorReport() {
                const stats = this.getErrorStats();
                console.log('🚨 تقرير الأخطاء:');
                console.log(`- إجمالي الأخطاء: ${stats.total}`);
                console.log(`- أخطاء حرجة: ${stats.critical}`);
                console.log(`- أخطاء مهمة: ${stats.high}`);
                console.log(`- أخطاء متوسطة: ${stats.medium}`);
                console.log(`- أخطاء بسيطة: ${stats.low}`);
                console.log(`- أخطاء آخر ساعة: ${stats.recent}`);

                if (stats.total === 0) {
                    NotificationUtils.showSuccess('🎉 لا توجد أخطاء مسجلة!');
                } else {
                    NotificationUtils.showInfo(`🚨 تقرير الأخطاء:\n• إجمالي: ${stats.total}\n• حرجة: ${stats.critical}\n• مهمة: ${stats.high}\n• حديثة: ${stats.recent}`);
                }
            },

            // تنظيف الأخطاء القديمة
            cleanupOldErrors() {
                const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                const beforeCount = this.errors.length;

                this.errors = this.errors.filter(error =>
                    new Date(error.timestamp).getTime() > oneWeekAgo || error.severity === 'critical'
                );

                const cleaned = beforeCount - this.errors.length;
                console.log(`🧹 تم تنظيف ${cleaned} خطأ قديم`);

                if (cleaned > 0) {
                    NotificationUtils.showInfo(`تم تنظيف ${cleaned} خطأ قديم`);
                }
            }
        };

        // تسجيل معالج الأخطاء العام
        window.addEventListener('error', function(event) {
            ErrorHandler.logError(event.error || event.message, 'global', 'medium');
        });

        window.addEventListener('unhandledrejection', function(event) {
            ErrorHandler.logError(event.reason, 'promise', 'high');
        });

        // تحميل إعدادات الواجهة عند بدء التشغيل
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // تحميل إعدادات الواجهة
                loadUISettings();

                // تحميل سجل الأنشطة
                ActivityLogger.loadActivityLog();

                // فحص سلامة البيانات أولاً
                ensureDataIntegrity();

                // تحميل البيانات الأساسية
                loadData();

                // فحص سلامة البيانات مرة أخرى بعد التحميل
                ensureDataIntegrity();

                // تسجيل بدء التشغيل
                ActivityLogger.log('systemStartup', {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                });

                // تهيئة الخزنة إذا لم تكن موجودة
                if (!cashbox.balance && !cashbox.transactions) {
                    cashbox = {
                        balance: 0,
                        transactions: []
                    };
                }

                // تحديث جميع الأقسام
                StateManager.refreshSection('dashboard');
                StateManager.refreshSection('products');
                StateManager.refreshSection('suppliers');
                StateManager.refreshSection('customers');
                StateManager.refreshSection('expenses');
                StateManager.refreshSection('cashbox');

                // تحديث الجداول
                updateInvoicesTable();
                updateBudgetDisplay();
                updateBackupStatus();
                analyzeLocalStorage();

                // تهيئة الأنظمة المتقدمة
                console.log('🚀 تهيئة الأنظمة المتقدمة...');

                // تهيئة الوضع الداكن
                DarkModeManager.initialize();

                // تهيئة نظام اللغات
                LanguageManager.initialize();

                // تهيئة ملء الشاشة
                FullscreenManager.initialize();

                // تهيئة نظام التنبيهات
                AlertsManager.initialize();

                // بدء البيانات اللحظية
                RealTimeDataManager.start();

                // استعادة القسم الأخير
                const lastSection = localStorage.getItem('currentSection');
                if (lastSection && document.getElementById(lastSection)) {
                    showSection(lastSection);
                } else {
                    showSection('dashboard');
                }

                // تهيئة المخططات البيانية بعد عرض لوحة التحكم
                setTimeout(() => {
                    if (document.getElementById('dashboard') && document.getElementById('dashboard').classList.contains('active')) {
                        console.log('🎨 تهيئة المخططات للوحة التحكم...');
                        ChartsManager.initializeCharts();
                    }
                }, 2000);

                // استعادة حالة الأفكار السريعة
                restoreQuickIdeasState();

                // تطبيق إعدادات الأفكار السريعة
                setTimeout(() => {
                    applyQuickIdeasSettings();
                }, 500);

                // تحديث لوحة التحكم
                setTimeout(() => {
                    updateDashboard();
                }, 2500);

                // فحص تلقائي للنظام
                setTimeout(() => {
                    console.log('🔍 بدء الفحص التلقائي للنظام...');

                    // فحص الاتصال بين الأقسام
                    const connectivityScore = SectionConnectivityChecker.checkSectionConnectivity();

                    // فحص سلامة البيانات الأساسية
                    const dataIntegrity = validateSystemIntegrity();

                    console.log('✅ انتهى الفحص التلقائي');
                }, 2000);

                // عرض رسالة ترحيب
                setTimeout(() => {
                    NotificationUtils.showSuccess('مرحباً بك في نظام إدارة المتجر المطور! 🎉');
                }, 1000);

            } catch (error) {
                console.error('خطأ في تحميل النظام:', error);
                NotificationUtils.showError('حدث خطأ في تحميل النظام. يرجى إعادة تحميل الصفحة.');
            }

            // إضافة مستمعي الأحداث للتنقل العلوي
            document.querySelectorAll('.top-nav-tab').forEach(tab => {
                tab.addEventListener('mouseover', function() {
                    if (!this.classList.contains('active')) {
                        this.style.background = 'rgba(255,255,255,0.2)';
                        this.style.transform = 'translateY(-2px)';
                    }
                });

                tab.addEventListener('mouseout', function() {
                    if (!this.classList.contains('active')) {
                        this.style.background = 'rgba(255,255,255,0.1)';
                        this.style.transform = 'translateY(0)';
                    }
                });
            });

            // إغلاق لوحة التخصيص عند النقر خارجها
            document.addEventListener('click', function(e) {
                const selector = document.getElementById('themeSelector');
                const toggleBtn = document.querySelector('.theme-toggle-btn');

                if (selector && toggleBtn && !selector.contains(e.target) && !toggleBtn.contains(e.target)) {
                    selector.style.display = 'none';
                }
            });

            // إغلاق النوافذ المنبثقة عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    const modalId = e.target.id;
                    closeModal(modalId);
                }
            });

            // إغلاق النوافذ بمفتاح Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) {
                        closeModal(activeModal.id);
                    }
                }
            });

            // عرض رسالة ترحيب
            setTimeout(() => {
                showToast('مرحباً بك في نظام إدارة المتجر الاحترافي المتكامل! 🎉', 'success', 7000);
            }, 1000);

            // تحسينات احترافية متقدمة (حسب الإعدادات)
            setTimeout(() => {
                initAdvancedFeaturesConditionally();
            }, 100);

        // وظيفة تهيئة التأثيرات حسب الإعدادات
        function initAdvancedFeaturesConditionally() {
            // تحميل الإعدادات أولاً
            loadEffectsSettings();

            // تأثيرات التحميل (تعمل دائماً للأزرار الأساسية)
            if (effectsSettings.animations) {
                addLoadingEffects();
            }

            // تأثيرات التفاعل المتقدمة
            if (effectsSettings.animations) {
                addInteractionEffects();
            }

            // تحسينات الأداء (تعمل دائماً)
            optimizePerformance();

            // تأثيرات الصوت
            if (effectsSettings.soundEffects) {
                initSoundEffects();
            }

            // تتبع تفاعل المستخدم (يعمل دائماً)
            initUserInteractionTracking();
        }

        // الوظيفة الأصلية للتوافق مع الكود القديم
        function initAdvancedFeatures() {
            initAdvancedFeaturesConditionally();
        }

        // تأثيرات التحميل المتقدمة
        function addLoadingEffects() {
            // إضافة تأثير التحميل للأزرار
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (!this.classList.contains('loading')) {
                        this.classList.add('loading');

                        // إضافة spinner
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';

                        // إزالة التأثير بعد ثانيتين
                        setTimeout(() => {
                            this.classList.remove('loading');
                            this.innerHTML = originalText;
                        }, 2000);
                    }
                });
            });
        }

        // تأثيرات التفاعل المتقدمة
        function addInteractionEffects() {
            // التحقق من إعدادات التأثيرات
            if (!effectsSettings.animations) return;

            // تأثير الموجة عند النقر
            document.addEventListener('click', function(e) {
                if (!effectsSettings.animations) return;
                if (e.target.classList.contains('btn') || e.target.closest('.btn')) {
                    createRippleEffect(e);
                }
            });

            // تأثير التمرير المتقدم
            let ticking = false;
            document.addEventListener('scroll', function() {
                if (!effectsSettings.animations) return;
                if (!ticking) {
                    requestAnimationFrame(updateScrollEffects);
                    ticking = true;
                }
            });

            // تأثيرات الماوس المتقدمة
            if (effectsSettings.glowEffects) {
                document.querySelectorAll('.stat-card, .nav-link').forEach(element => {
                    element.addEventListener('mouseenter', function(e) {
                        if (effectsSettings.glowEffects) {
                            createGlowEffect(e.target);
                        }
                    });

                    element.addEventListener('mouseleave', function(e) {
                        removeGlowEffect(e.target);
                    });
                });
            }
        }

        // إنشاء تأثير الموجة
        function createRippleEffect(e) {
            // التحقق من إعدادات التأثيرات
            if (!effectsSettings.animations) return;

            const button = e.target.closest('.btn');
            if (!button) return;

            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;

            ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
                background: rgba(255,255,255,0.3);
                border-radius: 50%;
                transform: scale(0);
                animation: ripple 0.6s linear;
                pointer-events: none;
            `;

            button.style.position = 'relative';
            button.style.overflow = 'hidden';
            button.appendChild(ripple);

            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // تحديث تأثيرات التمرير
        function updateScrollEffects() {
            const scrolled = window.pageYOffset;
            const parallax = document.querySelector('.sidebar');

            if (parallax) {
                const speed = scrolled * 0.1;
                parallax.style.transform = `translateY(${speed}px)`;
            }

            // تأثير الظهور التدريجي للعناصر
            document.querySelectorAll('.stat-card, .table-container').forEach(element => {
                const elementTop = element.getBoundingClientRect().top;
                const elementVisible = 150;

                if (elementTop < window.innerHeight - elementVisible) {
                    element.classList.add('animate-in');
                }
            });

            ticking = false;
        }

        // إنشاء تأثير التوهج
        function createGlowEffect(element) {
            if (!effectsSettings.glowEffects) return;
            element.style.filter = 'drop-shadow(0 0 20px rgba(102, 126, 234, 0.5))';
            element.style.transition = 'filter 0.3s ease';
        }

        // إزالة تأثير التوهج
        function removeGlowEffect(element) {
            element.style.filter = 'none';
        }

        // تحسينات الأداء
        function optimizePerformance() {
            // تحسين الصور بالتحميل التدريجي
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy');
                            imageObserver.unobserve(img);
                        }
                    });
                });

                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            }

            // تحسين الذاكرة
            window.addEventListener('beforeunload', function() {
                // تنظيف المتغيرات
                clearInterval(window.autoSaveInterval);
                clearTimeout(window.notificationTimeout);
            });
        }

        // تأثيرات الصوت (اختيارية)
        function initSoundEffects() {
            // التحقق من إعدادات التأثيرات الصوتية
            if (!effectsSettings.soundEffects) {
                return; // إيقاف الأصوات إذا كانت معطلة
            }

            // إزالة المستمع السابق إن وجد
            document.removeEventListener('click', soundClickHandler);

            // إضافة مستمع النقر الصوتي
            document.addEventListener('click', soundClickHandler);

            // أصوات الإشعارات (تطبق مرة واحدة فقط)
            if (!window.soundEffectsInitialized) {
                const originalShowToast = window.showToast;
                if (originalShowToast) {
                    window.showToast = function(message, type, duration) {
                        originalShowToast(message, type, duration);
                        if (effectsSettings.soundEffects) {
                            playNotificationSound(type);
                        }
                    };
                }
                window.soundEffectsInitialized = true;
            }
        }

        // تشغيل صوت النقر
        function playClickSound() {
            // التحقق من إعدادات الصوت
            if (!effectsSettings.soundEffects) return;

            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.volume = 0.1;
                audio.play().catch(() => {}); // تجاهل الأخطاء
            } catch (e) {}
        }

        // تشغيل صوت الإشعار
        function playNotificationSound(type) {
            // التحقق من إعدادات الصوت
            if (!effectsSettings.soundEffects) return;

            try {
                let frequency = 800;
                switch(type) {
                    case 'success': frequency = 800; break;
                    case 'error': frequency = 400; break;
                    case 'warning': frequency = 600; break;
                    case 'info': frequency = 700; break;
                }

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {}
        }

        // تتبع تفاعل المستخدم
        function initUserInteractionTracking() {
            let userActivity = {
                clicks: 0,
                scrolls: 0,
                timeSpent: 0,
                startTime: Date.now()
            };

            // تتبع النقرات
            document.addEventListener('click', function() {
                userActivity.clicks++;
            });

            // تتبع التمرير
            document.addEventListener('scroll', function() {
                userActivity.scrolls++;
            });

            // حفظ الإحصائيات كل دقيقة
            setInterval(function() {
                userActivity.timeSpent = Math.floor((Date.now() - userActivity.startTime) / 1000);
                localStorage.setItem('userActivity', JSON.stringify(userActivity));
            }, 60000);

            // عرض إحصائيات الاستخدام (للمطورين)
            window.getUserActivity = function() {
                userActivity.timeSpent = Math.floor((Date.now() - userActivity.startTime) / 1000);
                return userActivity;
            };
        }

        // تأثيرات متقدمة للنوافذ المنبثقة
        function enhanceModals() {
            const originalShowModal = window.showModal;
            window.showModal = function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    // إضافة تأثير الضبابية للخلفية
                    document.body.style.filter = 'blur(2px)';
                    document.querySelector('.main-content').style.filter = 'blur(2px)';

                    // تشغيل الصوت
                    playClickSound();

                    // تأثير الاهتزاز للجوال
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }
                originalShowModal(modalId);
            };

            const originalCloseModal = window.closeModal;
            window.closeModal = function(modalId) {
                // إزالة تأثير الضبابية
                document.body.style.filter = 'none';
                document.querySelector('.main-content').style.filter = 'none';

                originalCloseModal(modalId);
            };
        }

        // تحسين تجربة المستخدم على الجوال
        function enhanceMobileExperience() {
            if (window.innerWidth <= 768) {
                // تحسين اللمس
                document.addEventListener('touchstart', function() {}, {passive: true});

                // منع التكبير المزدوج
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);

                // تحسين التمرير
                document.body.style.overscrollBehavior = 'contain';
            }
        }

        // تطبيق جميع التحسينات
        setTimeout(function() {
            enhanceModals();
            enhanceMobileExperience();

            // تطبيق التأثيرات حسب الإعدادات
            if (effectsSettings.animations) {
                initAdvancedEffects();
                initScrollReveal();
                initCounterAnimations();
            }

            if (effectsSettings.particles) {
                initParticleSystem();
            }
        }, 1000);

        // تأثيرات متقدمة إضافية
        function initAdvancedEffects() {
            // التحقق من الإعدادات قبل التطبيق
            if (!effectsSettings.animations) return;

            // إضافة تأثيرات الإضاءة الديناميكية
            if (effectsSettings.animations) {
                document.querySelectorAll('.stat-card, .section').forEach(element => {
                    element.classList.add('dynamic-lighting');
                });
            }

            // إضافة تأثيرات النص المتدرج
            if (effectsSettings.dynamicColors) {
                document.querySelectorAll('h1, h2, h3').forEach(element => {
                    element.classList.add('text-gradient');
                });
            }

            // إضافة تأثيرات الحدود المتحركة للبطاقات المهمة
            if (effectsSettings.dynamicColors) {
                document.querySelectorAll('.stat-card').forEach(element => {
                    element.classList.add('animated-border');
                });
            }

            // إضافة تأثيرات الظلال المتقدمة
            if (effectsSettings.glowEffects) {
                document.querySelectorAll('.modal-content, .table-container').forEach(element => {
                    element.classList.add('advanced-shadow');
                });
            }
        }

        // نظام الجسيمات المتحركة
        function initParticleSystem() {
            const particlesContainer = document.createElement('div');
            particlesContainer.className = 'particles-container';
            document.body.appendChild(particlesContainer);

            function createParticle() {
                const particle = document.createElement('div');
                particle.className = 'particle';

                // موضع عشوائي
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particle.style.animationDelay = Math.random() * 2 + 's';

                // ألوان عشوائية
                const colors = [
                    'rgba(102, 126, 234, 0.3)',
                    'rgba(118, 75, 162, 0.3)',
                    'rgba(255, 215, 0, 0.3)'
                ];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];

                particlesContainer.appendChild(particle);

                // إزالة الجسيم بعد انتهاء الحركة
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 6000);
            }

            // إنشاء جسيمات جديدة كل ثانيتين
            setInterval(createParticle, 2000);
        }

        // تأثيرات الظهور عند التمرير
        function initScrollReveal() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');

                        // إضافة تأثيرات إضافية
                        if (entry.target.classList.contains('stat-card')) {
                            entry.target.classList.add('success-glow');
                            setTimeout(() => {
                                entry.target.classList.remove('success-glow');
                            }, 1000);
                        }
                    }
                });
            }, observerOptions);

            // مراقبة العناصر
            document.querySelectorAll('.stat-card, .table-container, .section').forEach(element => {
                element.classList.add('scroll-reveal');
                observer.observe(element);
            });
        }

        // تحريك الأرقام والعدادات
        function initCounterAnimations() {
            function animateCounter(element, target, duration = 2000) {
                const start = 0;
                const increment = target / (duration / 16);
                let current = start;

                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current).toLocaleString();
                }, 16);
            }

            // تحريك أرقام الإحصائيات
            document.querySelectorAll('.stat-number').forEach(element => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const target = parseInt(entry.target.textContent.replace(/[^\d]/g, '')) || 100;
                            animateCounter(entry.target, target);
                            observer.unobserve(entry.target);
                        }
                    });
                });
                observer.observe(element);
            });
        }

        // تحسينات الأيقونات المتحركة
        function enhanceIcons() {
            // إضافة تأثيرات عشوائية للأيقونات
            document.querySelectorAll('.nav-link i, .stat-icon').forEach((icon, index) => {
                const animations = ['icon-bounce', 'icon-pulse'];
                const randomAnimation = animations[Math.floor(Math.random() * animations.length)];

                setTimeout(() => {
                    icon.classList.add(randomAnimation);
                }, index * 200);
            });
        }

        // تأثيرات الكتابة المتحركة
        function initTypewriterEffect() {
            function typeWriter(element, text, speed = 100) {
                let i = 0;
                element.innerHTML = '';

                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    }
                }
                type();
            }

            // تطبيق تأثير الكتابة على العناوين المهمة
            const mainTitle = document.querySelector('h1');
            if (mainTitle) {
                const originalText = mainTitle.textContent;
                typeWriter(mainTitle, originalText, 150);
            }
        }

        // تحسينات الألوان الديناميكية
        function initDynamicColors() {
            const colors = [
                { class: 'success-glow', color: 'rgba(40, 167, 69, 0.5)' },
                { class: 'error-glow', color: 'rgba(220, 53, 69, 0.5)' },
                { class: 'warning-glow', color: 'rgba(255, 193, 7, 0.5)' },
                { class: 'info-glow', color: 'rgba(23, 162, 184, 0.5)' }
            ];

            setInterval(() => {
                document.querySelectorAll('.stat-card').forEach(card => {
                    // إزالة الألوان السابقة
                    colors.forEach(color => card.classList.remove(color.class));

                    // إضافة لون عشوائي
                    const randomColor = colors[Math.floor(Math.random() * colors.length)];
                    card.classList.add(randomColor.class);

                    setTimeout(() => {
                        card.classList.remove(randomColor.class);
                    }, 3000);
                });
            }, 10000); // كل 10 ثوان
        }

        // تطبيق التحسينات الإضافية
        setTimeout(() => {
            if (effectsSettings.animations) {
                enhanceIcons();
                initTypewriterEffect();
                initAdvancedInteractions();
            }

            if (effectsSettings.dynamicColors) {
                initDynamicColors();
            }

            if (effectsSettings.mouseEffects) {
                initMouseEffects();
            }

            // تحسينات الأداء تعمل دائماً
            initPerformanceOptimizations();
        }, 2000);

        // تأثيرات الماوس المتقدمة
        function initMouseEffects() {
            // إنشاء عنصر تتبع الماوس
            const mouseTrail = document.createElement('div');
            mouseTrail.className = 'mouse-trail';
            document.body.appendChild(mouseTrail);

            const lightCursor = document.createElement('div');
            lightCursor.className = 'light-cursor';
            document.body.appendChild(lightCursor);

            // تتبع حركة الماوس
            let mouseX = 0, mouseY = 0;
            let trailX = 0, trailY = 0;
            let lightX = 0, lightY = 0;

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            // تحديث موضع المؤثرات
            function updateMouseEffects() {
                // تأثير التتبع المتأخر
                trailX += (mouseX - trailX) * 0.1;
                trailY += (mouseY - trailY) * 0.1;

                lightX += (mouseX - lightX) * 0.05;
                lightY += (mouseY - lightY) * 0.05;

                mouseTrail.style.left = trailX - 10 + 'px';
                mouseTrail.style.top = trailY - 10 + 'px';

                lightCursor.style.left = lightX - 20 + 'px';
                lightCursor.style.top = lightY - 20 + 'px';

                requestAnimationFrame(updateMouseEffects);
            }
            updateMouseEffects();

            // تأثيرات خاصة عند التمرير على العناصر
            document.querySelectorAll('.btn, .nav-link, .stat-card').forEach(element => {
                element.addEventListener('mouseenter', () => {
                    mouseTrail.style.transform = 'scale(2)';
                    lightCursor.style.transform = 'scale(1.5)';
                });

                element.addEventListener('mouseleave', () => {
                    mouseTrail.style.transform = 'scale(1)';
                    lightCursor.style.transform = 'scale(1)';
                });
            });
        }

        // تفاعلات متقدمة
        function initAdvancedInteractions() {
            // إضافة تأثيرات الطاقة للعناصر المهمة
            if (effectsSettings.animations) {
                document.querySelectorAll('.btn-primary, .btn-success').forEach(element => {
                    element.classList.add('energy-pulse');
                });
            }

            // إضافة تأثيرات الهولوجرام للبطاقات
            if (effectsSettings.hologramEffects) {
                document.querySelectorAll('.stat-card').forEach(element => {
                    element.classList.add('hologram-effect');
                });
            }

            // إضافة تأثيرات الانعكاس للجداول
            if (effectsSettings.glowEffects) {
                document.querySelectorAll('.table-container').forEach(element => {
                    element.classList.add('reflection-effect');
                });
            }

            // إضافة تأثيرات الزجاج المتقدمة للنوافذ
            if (effectsSettings.glowEffects) {
                document.querySelectorAll('.modal-content').forEach(element => {
                    element.classList.add('ultra-glass');
                });
            }

            // تأثيرات الاهتزاز للأخطاء
            window.addEventListener('error', () => {
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            });

            // تأثيرات بصرية للإشعارات (بدون صوت هنا)
            const originalShowToast = window.showToast;
            if (originalShowToast && !window.visualEffectsInitialized) {
                window.showToast = function(message, type, duration) {
                    originalShowToast(message, type, duration);

                    // تأثيرات بصرية حسب النوع
                    if (effectsSettings.glowEffects) {
                        const body = document.body;
                        body.classList.add(type + '-glow');
                        setTimeout(() => {
                            body.classList.remove(type + '-glow');
                        }, 500);
                    }

                    // تأثيرات صوتية منفصلة
                    if (effectsSettings.soundEffects) {
                        playNotificationSound(type);
                    }
                };
                window.visualEffectsInitialized = true;
            }
        }

        // تحسينات الأداء المتقدمة
        function initPerformanceOptimizations() {
            // إضافة تسريع GPU للعناصر المتحركة
            document.querySelectorAll('.btn, .nav-link, .stat-card, .modal-content').forEach(element => {
                element.classList.add('gpu-accelerated');
            });

            // تحسين الصور
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                img.loading = 'lazy';
                img.decoding = 'async';
            });

            // تحسين الخطوط
            if ('fonts' in document) {
                document.fonts.ready.then(() => {
                    document.body.classList.add('fonts-loaded');
                });
            }

            // تحسين التمرير
            let ticking = false;
            function updateOnScroll() {
                // تحديث العناصر المرئية فقط
                const viewportHeight = window.innerHeight;
                document.querySelectorAll('.stat-card, .table-container').forEach(element => {
                    const rect = element.getBoundingClientRect();
                    const isVisible = rect.top < viewportHeight && rect.bottom > 0;

                    if (isVisible && !element.classList.contains('in-viewport')) {
                        element.classList.add('in-viewport');
                    } else if (!isVisible && element.classList.contains('in-viewport')) {
                        element.classList.remove('in-viewport');
                    }
                });
                ticking = false;
            }

            window.addEventListener('scroll', () => {
                if (!ticking) {
                    requestAnimationFrame(updateOnScroll);
                    ticking = true;
                }
            });

            // تنظيف الذاكرة
            window.addEventListener('beforeunload', () => {
                // إزالة المستمعين
                document.removeEventListener('mousemove', () => {});
                document.removeEventListener('scroll', () => {});

                // تنظيف العناصر المؤقتة
                document.querySelectorAll('.mouse-trail, .light-cursor, .particle').forEach(element => {
                    if (element.parentNode) {
                        element.parentNode.removeChild(element);
                    }
                });
            });
        }

        // تحسينات الاستجابة التلقائية
        function initResponsiveEnhancements() {
            function updateForViewport() {
                const width = window.innerWidth;
                const body = document.body;

                // إزالة الفئات السابقة
                body.classList.remove('mobile-view', 'tablet-view', 'desktop-view');

                // إضافة الفئة المناسبة
                if (width <= 576) {
                    body.classList.add('mobile-view');
                    // تقليل التأثيرات للجوال
                    document.querySelectorAll('.particle').forEach(p => p.remove());
                } else if (width <= 992) {
                    body.classList.add('tablet-view');
                } else {
                    body.classList.add('desktop-view');
                }
            }

            updateForViewport();
            window.addEventListener('resize', updateForViewport);
        }

        // تطبيق التحسينات النهائية
        setTimeout(() => {
            initResponsiveEnhancements();

            // رسالة إكمال التحميل
            console.log('🚀 تم تحميل جميع التحسينات الاحترافية بنجاح!');

            // إشعار للمطور
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                showToast('تم تحميل جميع التحسينات الاحترافية! 🎉', 'success', 3000);
            }
        }, 3000);
        });
        // وظائف إضافية للنظام المطور
        function showCreateDummyInvoiceModal() {
            showToast('سيتم إضافة وظيفة إنشاء الفواتير الوهمية قريباً! 📄', 'info');
        }

        function exportInvoicesReport() {
            showToast('سيتم إضافة وظيفة تصدير تقرير الفواتير قريباً! 📊', 'info');
        }

        function showSuppliersReport() {
            showToast('سيتم إضافة تقرير الموردين قريباً! 📈', 'info');
        }

        function showCustomersReport() {
            showToast('سيتم إضافة تقرير العملاء قريباً! 👥', 'info');
        }

        function showDebtorsReport() {
            showToast('سيتم إضافة تقرير المدينين قريباً! ⚠️', 'info');
        }

        function showExpensesReport() {
            showToast('سيتم إضافة تقرير المصروفات قريباً! 💰', 'info');
        }

        function setBudgetLimit() {
            const budget = prompt('أدخل الميزانية الشهرية:');
            if (budget && !isNaN(budget) && parseFloat(budget) > 0) {
                settings.monthlyBudget = parseFloat(budget);
                saveData();
                showToast(`تم تحديد الميزانية الشهرية: ${budget} ${settings.currency} 💰`, 'success');
                updateBudgetDisplay();
            }
        }

        function updateBudgetDisplay() {
            const monthlyBudget = settings.monthlyBudget || 0;
            const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const currentMonthExpenses = expenses.filter(e => new Date(e.date) >= monthStart)
                .reduce((sum, expense) => sum + expense.amount, 0);

            const remaining = monthlyBudget - currentMonthExpenses;
            const usagePercentage = monthlyBudget > 0 ? (currentMonthExpenses / monthlyBudget) * 100 : 0;

            if (document.getElementById('monthlyBudget')) {
                document.getElementById('monthlyBudget').textContent = monthlyBudget > 0 ? `${monthlyBudget.toFixed(2)} ${settings.currency}` : 'غير محددة';
                document.getElementById('currentMonthExpenses').textContent = `${currentMonthExpenses.toFixed(2)} ${settings.currency}`;
                document.getElementById('remainingBudget').textContent = `${remaining.toFixed(2)} ${settings.currency}`;
                document.getElementById('budgetUsagePercentage').textContent = `${usagePercentage.toFixed(1)}%`;

                const progressBar = document.getElementById('budgetUsageBar');
                if (progressBar) {
                    progressBar.style.width = `${Math.min(usagePercentage, 100)}%`;
                    progressBar.style.background = usagePercentage > 90 ? '#dc3545' : usagePercentage > 70 ? '#ffc107' : '#28a745';
                }
            }
        }

        // وظائف النسخ الاحتياطي
        function checkBackupStatus() {
            showToast('تم تحديث حالة النسخ الاحتياطي! 🔄', 'info');
            updateBackupStatus();
        }

        function createManualBackup() {
            const backupData = {
                products: products,
                sales: sales,
                suppliers: suppliers,
                customers: customers,
                expenses: expenses,
                settings: settings,
                timestamp: new Date().toISOString(),
                version: '2.0.0'
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `store_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            URL.revokeObjectURL(url);
            showToast('تم إنشاء النسخة الاحتياطية وتحميلها! 💾', 'success');
            updateBackupStatus();
        }

        function updateBackupStatus() {
            const lastBackup = localStorage.getItem('lastBackupTime');
            const dataSize = new Blob([JSON.stringify({products, sales, suppliers, customers, expenses, settings})]).size;

            if (document.getElementById('lastBackupTime')) {
                document.getElementById('lastBackupTime').textContent = lastBackup ?
                    new Date(lastBackup).toLocaleString('ar-SA') : 'لم يتم إنشاء نسخة';
                document.getElementById('backupSize').textContent = `${(dataSize / 1024).toFixed(2)} KB`;
                document.getElementById('backupCount').textContent = '1';
            }

            localStorage.setItem('lastBackupTime', new Date().toISOString());
        }

        function exportDataAsJSON() {
            createManualBackup();
        }

        function exportDataAsExcel() {
            showToast('سيتم إضافة وظيفة التصدير إلى Excel قريباً! 📊', 'info');
        }

        function showImportDataModal() {
            showToast('سيتم إضافة وظيفة استيراد البيانات قريباً! 📥', 'info');
        }

        function syncWithCloud() {
            showToast('سيتم إضافة وظيفة المزامنة السحابية قريباً! ☁️', 'info');
        }

        function showRestoreModal() {
            showToast('سيتم إضافة وظيفة استعادة النسخ الاحتياطية قريباً! 🔄', 'info');
        }

        function cleanupOldBackups() {
            showToast('تم تنظيف النسخ القديمة! 🧹', 'success');
        }

        // وظائف الإعدادات المتقدمة
        function resetToDefaults() {
            if (confirm('هل أنت متأكد من إعادة تعيين جميع الإعدادات؟')) {
                settings = {
                    storeName: 'متجري الاحترافي',
                    currency: 'ريال',
                    lowStockThreshold: 10,
                    taxRate: 0,
                    normalCustomerDiscount: 0,
                    wholesaleCustomerDiscount: 5,
                    traderCustomerDiscount: 10,
                    loyaltyPointsPerRiyal: 1,
                    enableWhatsAppSend: true,
                    enableAutoPrint: true,
                    enableInvoiceNumbers: true,
                    whatsappMessage: 'شكراً لتعاملكم معنا. إليكم فاتورة مشترياتكم.',
                    invoicePrefix: 'INV',
                    defaultUnit: 'قطعة',
                    enableBarcodeGeneration: false,
                    enableStockAlerts: true,
                    productCategories: 'إلكترونيات، أسلاك، لمبات، أدوات، أخرى',
                    measurementUnits: 'قطعة، متر، كرتونة، كيلو، لتر، عبوة'
                };
                saveData();
                showToast('تم إعادة تعيين الإعدادات بنجاح! ✅', 'success');
                location.reload();
            }
        }

        function analyzeLocalStorage() {
            const storageUsed = new Blob([JSON.stringify({products, sales, suppliers, customers, expenses, settings})]).size;
            const productsCount = products.length;
            const invoicesCount = sales.length;
            const lastUpdate = localStorage.getItem('lastDataUpdate') || 'غير محدد';

            if (document.getElementById('storageUsed')) {
                document.getElementById('storageUsed').textContent = `${(storageUsed / 1024).toFixed(2)} KB`;
                document.getElementById('productsCount').textContent = productsCount;
                document.getElementById('invoicesCount').textContent = invoicesCount;
                document.getElementById('lastDataUpdate').textContent = lastUpdate;
            }

            showToast('تم تحليل البيانات المحلية! 📊', 'info');
        }

        function repairLocalStorage() {
            // إصلاح البيانات التالفة
            products = products.filter(p => p && p.id && p.name);
            sales = sales.filter(s => s && s.id && s.productId);
            suppliers = suppliers.filter(s => s && s.id && s.name);
            customers = customers.filter(c => c && c.id && c.name);
            expenses = expenses.filter(e => e && e.id && e.description);

            saveData();
            showToast('تم إصلاح البيانات بنجاح! 🔧', 'success');
        }

        function cleanupLocalStorage() {
            // تنظيف البيانات القديمة والمكررة
            const uniqueProducts = products.filter((product, index, self) =>
                index === self.findIndex(p => p.id === product.id)
            );
            const uniqueSales = sales.filter((sale, index, self) =>
                index === self.findIndex(s => s.id === sale.id)
            );

            products = uniqueProducts;
            sales = uniqueSales;

            saveData();
            showToast('تم تنظيف البيانات بنجاح! 🧹', 'success');
        }

        function clearAllData() {
            if (confirm('⚠️ تحذير: سيتم حذف جميع البيانات نهائياً!\n\nهل أنت متأكد؟')) {
                if (confirm('هذا الإجراء لا يمكن التراجع عنه!\n\nهل تريد المتابعة؟')) {
                    localStorage.clear();
                    NotificationUtils.showWarning('تم حذف جميع البيانات! 🗑️');
                    setTimeout(() => location.reload(), 2000);
                }
            }
        }

        // ===== وظائف اختبار التكامل =====

        const IntegrationTester = {
            // اختبار سيناريو بيع كامل
            testFullSaleScenario() {
                console.log('🧪 بدء اختبار سيناريو البيع الكامل...');

                try {
                    // 1. إضافة منتج للاختبار
                    const testProduct = {
                        id: Date.now(),
                        name: 'منتج اختبار',
                        price: 100,
                        costPrice: 70,
                        quantity: 10,
                        category: 'اختبار'
                    };

                    products.push(testProduct);
                    console.log('✅ تم إضافة منتج الاختبار');

                    // 2. إضافة عميل للاختبار
                    const testCustomer = {
                        id: Date.now() + 1,
                        code: 'TEST001',
                        name: 'عميل اختبار',
                        type: 'normal',
                        totalPurchases: 0,
                        outstandingDebt: 0,
                        loyaltyPoints: 0
                    };

                    customers.push(testCustomer);
                    console.log('✅ تم إضافة عميل الاختبار');

                    // 3. تسجيل بيع
                    const testSale = {
                        id: Date.now() + 2,
                        productId: testProduct.id,
                        productName: testProduct.name,
                        customerId: testCustomer.id,
                        customerName: testCustomer.name,
                        quantity: 2,
                        price: testProduct.price,
                        total: testProduct.price * 2,
                        paymentMethod: 'cash',
                        date: new Date().toISOString().split('T')[0]
                    };

                    // استخدام StateManager لتسجيل البيع
                    const result = StateManager.updateSection('sales', {
                        action: 'add',
                        sale: testSale
                    });

                    if (result.success) {
                        console.log('✅ تم تسجيل البيع بنجاح');

                        // 4. التحقق من التحديثات
                        const updatedProduct = products.find(p => p.id === testProduct.id);
                        const updatedCustomer = customers.find(c => c.id === testCustomer.id);
                        const cashBalance = CashboxUtils.getBalance();

                        console.log('📊 نتائج الاختبار:');
                        console.log(`- كمية المنتج بعد البيع: ${updatedProduct.quantity}`);
                        console.log(`- رصيد الخزنة: ${cashBalance}`);
                        console.log(`- إجمالي مشتريات العميل: ${updatedCustomer.totalPurchases}`);

                        // تنظيف بيانات الاختبار
                        this.cleanupTestData();

                        NotificationUtils.showSuccess('اختبار التكامل مكتمل بنجاح! ✅');
                        return true;
                    } else {
                        throw new Error('فشل في تسجيل البيع');
                    }

                } catch (error) {
                    console.error('❌ فشل اختبار التكامل:', error);
                    NotificationUtils.showError(`فشل اختبار التكامل: ${error.message}`);
                    this.cleanupTestData();
                    return false;
                }
            },

            // اختبار سيناريو المصروفات
            testExpenseScenario() {
                console.log('🧪 بدء اختبار سيناريو المصروفات...');

                try {
                    const initialBalance = CashboxUtils.getBalance();

                    const testExpense = {
                        id: Date.now(),
                        type: 'operational',
                        amount: 50,
                        description: 'مصروف اختبار',
                        date: new Date().toISOString().split('T')[0],
                        paymentMethod: 'cash',
                        responsible: 'نظام الاختبار'
                    };

                    const result = StateManager.updateSection('expenses', {
                        action: 'add',
                        expense: testExpense
                    });

                    if (result.success) {
                        const newBalance = CashboxUtils.getBalance();
                        const expectedBalance = initialBalance - testExpense.amount;

                        if (Math.abs(newBalance - expectedBalance) < 0.01) {
                            console.log('✅ اختبار المصروفات نجح');
                            NotificationUtils.showSuccess('اختبار المصروفات مكتمل بنجاح! ✅');
                            return true;
                        } else {
                            throw new Error(`رصيد الخزنة غير صحيح. المتوقع: ${expectedBalance}, الفعلي: ${newBalance}`);
                        }
                    } else {
                        throw new Error('فشل في إضافة المصروف');
                    }

                } catch (error) {
                    console.error('❌ فشل اختبار المصروفات:', error);
                    NotificationUtils.showError(`فشل اختبار المصروفات: ${error.message}`);
                    return false;
                }
            },

            // تنظيف بيانات الاختبار
            cleanupTestData() {
                products = products.filter(p => !p.name.includes('اختبار'));
                customers = customers.filter(c => !c.name.includes('اختبار'));
                sales = sales.filter(s => !s.productName.includes('اختبار'));
                expenses = expenses.filter(e => !e.description.includes('اختبار'));
                console.log('🧹 تم تنظيف بيانات الاختبار');
            },

            // اختبار شامل لجميع الوظائف
            runFullSystemTest() {
                console.log('🚀 بدء الاختبار الشامل للنظام...');

                const tests = [
                    { name: 'اختبار البيع', func: () => this.testFullSaleScenario() },
                    { name: 'اختبار المصروفات', func: () => this.testExpenseScenario() },
                    { name: 'اختبار التحقق', func: () => this.testValidationUtils() },
                    { name: 'اختبار الخصومات', func: () => this.testDiscountUtils() }
                ];

                let passedTests = 0;
                const totalTests = tests.length;

                tests.forEach((test, index) => {
                    setTimeout(() => {
                        console.log(`📝 تشغيل ${test.name}...`);
                        if (test.func()) {
                            passedTests++;
                        }

                        if (index === totalTests - 1) {
                            // عرض النتائج النهائية
                            setTimeout(() => {
                                const successRate = (passedTests / totalTests) * 100;
                                console.log(`📊 نتائج الاختبار: ${passedTests}/${totalTests} (${successRate}%)`);

                                if (successRate === 100) {
                                    NotificationUtils.showSuccess(`🎉 جميع الاختبارات نجحت! (${passedTests}/${totalTests})`);
                                } else {
                                    NotificationUtils.showWarning(`⚠️ نجح ${passedTests} من ${totalTests} اختبارات`);
                                }
                            }, 500);
                        }
                    }, index * 1000);
                });
            },

            // اختبار وحدة التحقق
            testValidationUtils() {
                try {
                    // اختبار التحقق من المنتج
                    const invalidProduct = { name: '', price: -10, quantity: -5 };
                    const validation = ValidationUtils.validateProduct(invalidProduct);

                    if (!validation.isValid && validation.errors.length > 0) {
                        console.log('✅ اختبار التحقق من المنتج نجح');
                        return true;
                    } else {
                        throw new Error('فشل في اكتشاف أخطاء المنتج');
                    }
                } catch (error) {
                    console.error('❌ فشل اختبار التحقق:', error);
                    return false;
                }
            },

            // اختبار وحدة الخصومات
            testDiscountUtils() {
                try {
                    const price = 100;
                    const discount = 10;
                    const result = DiscountUtils.applyDiscount(price, discount);

                    if (result.finalPrice === 90 && result.discountAmount === 10) {
                        console.log('✅ اختبار الخصومات نجح');
                        return true;
                    } else {
                        throw new Error('حساب الخصم غير صحيح');
                    }
                } catch (error) {
                    console.error('❌ فشل اختبار الخصومات:', error);
                    return false;
                }
            }
        };

        // إضافة وظيفة اختبار للقائمة المتقدمة
        function runSystemTests() {
            IntegrationTester.runFullSystemTest();
        }

        // ===== نظام المخططات البيانية التفاعلية =====

        const ChartsManager = {
            charts: {},

            // تهيئة جميع المخططات
            initializeCharts() {
                try {
                    console.log('🎨 بدء تهيئة المخططات البيانية...');

                    // التأكد من وجود Chart.js
                    if (typeof Chart === 'undefined') {
                        console.error('❌ مكتبة Chart.js غير محملة');
                        return;
                    }

                    // تدمير المخططات الموجودة أولاً
                    this.destroyAllCharts();

                    // انتظار قصير للتأكد من تحميل DOM
                    setTimeout(() => {
                        this.createSalesLineChart();
                        this.createProductsPieChart();
                        this.createTopProductsChart();
                        this.createProfitsChart();
                        console.log('✅ تم تهيئة جميع المخططات البيانية');
                    }, 100);
                } catch (error) {
                    console.error('❌ خطأ في تهيئة المخططات:', error);
                    ErrorHandler.logError(error, 'initializeCharts', 'high');
                }
            },

            // مخطط المبيعات الخطي
            createSalesLineChart() {
                try {
                    const ctx = document.getElementById('salesLineChart');
                    if (!ctx) {
                        console.warn('⚠️ عنصر salesLineChart غير موجود');
                        return;
                    }

                    const salesData = this.generateSalesData();

                    this.charts.salesLine = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: salesData.labels,
                            datasets: [{
                                label: 'المبيعات (ريال)',
                                data: salesData.values,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#28a745',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#ffffff',
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: '#28a745',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#ffffff',
                                        font: { size: 11 }
                                    },
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                x: {
                                    ticks: {
                                        color: '#ffffff',
                                        font: { size: 11 }
                                    },
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                }
                            }
                        }
                    });
                    console.log('✅ تم إنشاء مخطط المبيعات الخطي');
                } catch (error) {
                    console.error('❌ خطأ في إنشاء مخطط المبيعات:', error);
                    ErrorHandler.logError(error, 'createSalesLineChart', 'medium');
                }
            },

            // مخطط توزيع المنتجات الدائري
            createProductsPieChart() {
                try {
                    const ctx = document.getElementById('productsPieChart');
                    if (!ctx) {
                        console.warn('⚠️ عنصر productsPieChart غير موجود');
                        return;
                    }

                    const categoriesData = this.generateCategoriesData();

                    this.charts.productsPie = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: categoriesData.labels,
                            datasets: [{
                                data: categoriesData.values,
                                backgroundColor: [
                                    '#FF6384',
                                    '#36A2EB',
                                    '#FFCE56',
                                    '#4BC0C0',
                                    '#9966FF',
                                    '#FF9F40',
                                    '#FF6B6B',
                                    '#4ECDC4'
                                ],
                                borderWidth: 3,
                                borderColor: '#ffffff',
                                hoverBorderWidth: 4,
                                hoverBorderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '50%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#ffffff',
                                        font: { size: 11 },
                                        padding: 15,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: '#ffffff',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('✅ تم إنشاء مخطط توزيع المنتجات');
                } catch (error) {
                    console.error('❌ خطأ في إنشاء مخطط المنتجات:', error);
                    ErrorHandler.logError(error, 'createProductsPieChart', 'medium');
                }
            },

            // مخطط أكثر المنتجات مبيعاً
            createTopProductsChart() {
                const ctx = document.getElementById('topProductsChart');
                if (!ctx) return;

                const topProductsData = this.generateTopProductsData();

                this.charts.topProducts = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topProductsData.labels,
                        datasets: [{
                            label: 'الكمية المباعة',
                            data: topProductsData.values,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            },

            // مخطط الأرباح الشهرية
            createProfitsChart() {
                const ctx = document.getElementById('profitsChart');
                if (!ctx) return;

                const profitsData = this.generateProfitsData();

                this.charts.profits = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: profitsData.labels,
                        datasets: [{
                            label: 'الأرباح (ريال)',
                            data: profitsData.values,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            },

            // توليد بيانات المبيعات
            generateSalesData() {
                const labels = [];
                const values = [];

                try {
                    const salesArray = Array.isArray(sales) ? sales : [];

                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date.toLocaleDateString('ar-SA', { weekday: 'short' }));

                        // حساب المبيعات الفعلية لهذا اليوم
                        const dayStart = new Date(date);
                        dayStart.setHours(0, 0, 0, 0);
                        const dayEnd = new Date(date);
                        dayEnd.setHours(23, 59, 59, 999);

                        const daySales = salesArray.filter(sale => {
                            try {
                                if (!sale || !sale.date) return false;
                                const saleDate = new Date(sale.date);
                                return saleDate >= dayStart && saleDate <= dayEnd;
                            } catch {
                                return false;
                            }
                        }).reduce((sum, sale) => {
                            const saleTotal = parseFloat(sale?.total) || 0;
                            return sum + saleTotal;
                        }, 0);

                        values.push(daySales);
                    }
                } catch (error) {
                    console.error('❌ خطأ في توليد بيانات المبيعات:', error);
                    // إرجاع بيانات افتراضية
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date.toLocaleDateString('ar-SA', { weekday: 'short' }));
                        values.push(0);
                    }
                }

                return { labels, values };
            },

            // توليد بيانات الفئات
            generateCategoriesData() {
                const categories = {};

                try {
                    const productsArray = Array.isArray(products) ? products : [];

                    if (productsArray.length === 0) {
                        return {
                            labels: ['لا توجد منتجات'],
                            values: [1]
                        };
                    }

                    productsArray.forEach(product => {
                        if (product && typeof product === 'object') {
                            const category = product.category || 'غير محدد';
                            categories[category] = (categories[category] || 0) + 1;
                        }
                    });

                    // التأكد من وجود بيانات
                    if (Object.keys(categories).length === 0) {
                        return {
                            labels: ['لا توجد فئات'],
                            values: [1]
                        };
                    }

                } catch (error) {
                    console.error('❌ خطأ في توليد بيانات الفئات:', error);
                    return {
                        labels: ['خطأ في البيانات'],
                        values: [1]
                    };
                }

                return {
                    labels: Object.keys(categories),
                    values: Object.values(categories)
                };
            },

            // توليد بيانات أكثر المنتجات مبيعاً
            generateTopProductsData() {
                const productSales = {};

                try {
                    const salesArray = Array.isArray(sales) ? sales : [];

                    if (salesArray.length === 0) {
                        return {
                            labels: ['لا توجد مبيعات'],
                            values: [0]
                        };
                    }

                    salesArray.forEach(sale => {
                        if (sale && typeof sale === 'object') {
                            const productName = sale.productName || 'منتج غير محدد';
                            const quantity = parseInt(sale.quantity) || 1;
                            productSales[productName] = (productSales[productName] || 0) + quantity;
                        }
                    });

                    const entries = Object.entries(productSales);
                    if (entries.length === 0) {
                        return {
                            labels: ['لا توجد منتجات'],
                            values: [0]
                        };
                    }

                    const sorted = entries
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 5);

                    return {
                        labels: sorted.map(([name]) => name),
                        values: sorted.map(([,quantity]) => quantity)
                    };

                } catch (error) {
                    console.error('❌ خطأ في توليد بيانات أكثر المنتجات مبيعاً:', error);
                    return {
                        labels: ['خطأ في البيانات'],
                        values: [0]
                    };
                }
            },

            // توليد بيانات الأرباح
            generateProfitsData() {
                const labels = [];
                const values = [];

                try {
                    const salesArray = Array.isArray(sales) ? sales : [];

                    for (let i = 5; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        labels.push(date.toLocaleDateString('ar-SA', { month: 'short' }));

                        // حساب الأرباح الفعلية لهذا الشهر
                        const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                        const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

                        const monthProfits = salesArray.filter(sale => {
                            try {
                                if (!sale || !sale.date) return false;
                                const saleDate = new Date(sale.date);
                                return saleDate >= monthStart && saleDate <= monthEnd;
                            } catch {
                                return false;
                            }
                        }).reduce((sum, sale) => {
                            const saleTotal = parseFloat(sale?.total) || 0;
                            const saleProfit = parseFloat(sale?.profit) || (saleTotal * 0.2);
                            return sum + saleProfit;
                        }, 0);

                        values.push(monthProfits);
                    }
                } catch (error) {
                    console.error('❌ خطأ في توليد بيانات الأرباح:', error);
                    // إرجاع بيانات افتراضية
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        labels.push(date.toLocaleDateString('ar-SA', { month: 'short' }));
                        values.push(0);
                    }
                }

                return { labels, values };
            },

            // تحديث جميع المخططات
            updateAllCharts() {
                try {
                    console.log('🔄 بدء تحديث المخططات...');

                    Object.keys(this.charts).forEach(chartKey => {
                        const chart = this.charts[chartKey];
                        if (chart && typeof chart.update === 'function') {
                            try {
                                // تحديث البيانات حسب نوع المخطط
                                switch(chartKey) {
                                    case 'salesLine':
                                        const salesData = this.generateSalesData();
                                        chart.data.labels = salesData.labels;
                                        chart.data.datasets[0].data = salesData.values;
                                        break;
                                    case 'productsPie':
                                        const categoriesData = this.generateCategoriesData();
                                        chart.data.labels = categoriesData.labels;
                                        chart.data.datasets[0].data = categoriesData.values;
                                        break;
                                    case 'topProducts':
                                        const topProductsData = this.generateTopProductsData();
                                        chart.data.labels = topProductsData.labels;
                                        chart.data.datasets[0].data = topProductsData.values;
                                        break;
                                    case 'profits':
                                        const profitsData = this.generateProfitsData();
                                        chart.data.labels = profitsData.labels;
                                        chart.data.datasets[0].data = profitsData.values;
                                        break;
                                }
                                chart.update('active');
                            } catch (error) {
                                console.error(`❌ خطأ في تحديث المخطط ${chartKey}:`, error);
                            }
                        }
                    });
                    console.log('✅ تم تحديث جميع المخططات');
                } catch (error) {
                    console.error('❌ خطأ في تحديث المخططات:', error);
                    ErrorHandler.logError(error, 'updateAllCharts', 'medium');
                }
            },

            // تدمير جميع المخططات
            destroyAllCharts() {
                try {
                    Object.keys(this.charts).forEach(chartKey => {
                        const chart = this.charts[chartKey];
                        if (chart && typeof chart.destroy === 'function') {
                            try {
                                chart.destroy();
                                console.log(`🗑️ تم تدمير المخطط: ${chartKey}`);
                            } catch (error) {
                                console.error(`❌ خطأ في تدمير المخطط ${chartKey}:`, error);
                            }
                        }
                    });
                    this.charts = {};
                    console.log('✅ تم تدمير جميع المخططات');
                } catch (error) {
                    console.error('❌ خطأ في تدمير المخططات:', error);
                    this.charts = {};
                }
            },

            // إعادة تهيئة المخططات
            reinitializeCharts() {
                console.log('🔄 إعادة تهيئة المخططات...');
                this.destroyAllCharts();
                setTimeout(() => {
                    this.initializeCharts();
                }, 200);
            }
        };

        // ===== نظام البحث السريع المتقدم =====

        const QuickSearchManager = {
            searchTimeout: null,

            // تنفيذ البحث السريع
            performSearch(query) {
                if (!query || query.length < 2) {
                    this.hideResults();
                    return;
                }

                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    const results = this.searchAllData(query);
                    this.displayResults(results);
                }, 300);
            },

            // البحث في جميع البيانات
            searchAllData(query) {
                const results = [];
                const searchTerm = query.toLowerCase();

                // البحث في المنتجات
                products.forEach(product => {
                    if (product.name.toLowerCase().includes(searchTerm) ||
                        product.barcode?.includes(searchTerm) ||
                        product.category?.toLowerCase().includes(searchTerm)) {
                        results.push({
                            type: 'منتج',
                            title: product.name,
                            description: `الفئة: ${product.category || 'غير محدد'} - السعر: ${product.price} ريال`,
                            action: () => this.goToProduct(product.id),
                            icon: 'fas fa-box'
                        });
                    }
                });

                // البحث في العملاء
                customers.forEach(customer => {
                    if (customer.name.toLowerCase().includes(searchTerm) ||
                        customer.phone?.includes(searchTerm) ||
                        customer.email?.toLowerCase().includes(searchTerm)) {
                        results.push({
                            type: 'عميل',
                            title: customer.name,
                            description: `الهاتف: ${customer.phone || 'غير محدد'} - النوع: ${customer.type || 'عادي'}`,
                            action: () => this.goToCustomer(customer.id),
                            icon: 'fas fa-user'
                        });
                    }
                });

                // البحث في الموردين
                suppliers.forEach(supplier => {
                    if (supplier.name.toLowerCase().includes(searchTerm) ||
                        supplier.phone?.includes(searchTerm) ||
                        supplier.email?.toLowerCase().includes(searchTerm)) {
                        results.push({
                            type: 'مورد',
                            title: supplier.name,
                            description: `الهاتف: ${supplier.phone || 'غير محدد'} - الشركة: ${supplier.company || 'غير محدد'}`,
                            action: () => this.goToSupplier(supplier.id),
                            icon: 'fas fa-industry'
                        });
                    }
                });

                // البحث في المبيعات
                sales.forEach(sale => {
                    if (sale.productName?.toLowerCase().includes(searchTerm) ||
                        sale.customerName?.toLowerCase().includes(searchTerm) ||
                        sale.id?.toString().includes(searchTerm)) {
                        results.push({
                            type: 'فاتورة',
                            title: `فاتورة #${sale.id}`,
                            description: `المنتج: ${sale.productName} - العميل: ${sale.customerName || 'نقدي'} - المبلغ: ${sale.total} ريال`,
                            action: () => this.goToInvoice(sale.id),
                            icon: 'fas fa-receipt'
                        });
                    }
                });

                return results.slice(0, 10); // أول 10 نتائج فقط
            },

            // عرض النتائج
            displayResults(results) {
                const container = document.getElementById('quickSearchResults');
                if (!container) return;

                if (results.length === 0) {
                    container.innerHTML = '<div style="padding: 15px; text-align: center; color: #ccc;">لا توجد نتائج</div>';
                    container.style.display = 'block';
                    return;
                }

                const html = results.map(result => `
                    <div class="search-result-item" onclick="QuickSearchManager.executeAction('${result.type}', '${result.title}')">
                        <div class="search-result-type">
                            <i class="${result.icon}"></i> ${result.type}
                        </div>
                        <div class="search-result-title">${result.title}</div>
                        <div class="search-result-description">${result.description}</div>
                    </div>
                `).join('');

                container.innerHTML = html;
                container.style.display = 'block';
            },

            // إخفاء النتائج
            hideResults() {
                const container = document.getElementById('quickSearchResults');
                if (container) {
                    container.style.display = 'none';
                }
            },

            // تنفيذ الإجراء
            executeAction(type, title) {
                this.hideResults();
                document.getElementById('quickSearch').value = '';

                switch(type) {
                    case 'منتج':
                        showSection('products');
                        NotificationUtils.showInfo(`تم الانتقال إلى قسم المنتجات للبحث عن: ${title}`);
                        break;
                    case 'عميل':
                        showSection('customers');
                        NotificationUtils.showInfo(`تم الانتقال إلى قسم العملاء للبحث عن: ${title}`);
                        break;
                    case 'مورد':
                        showSection('suppliers');
                        NotificationUtils.showInfo(`تم الانتقال إلى قسم الموردين للبحث عن: ${title}`);
                        break;
                    case 'فاتورة':
                        showSection('invoice-inquiry');
                        NotificationUtils.showInfo(`تم الانتقال إلى استعلام الفواتير للبحث عن: ${title}`);
                        break;
                }
            },

            // الانتقال إلى منتج
            goToProduct(productId) {
                showSection('products');
                // يمكن إضافة منطق للتمرير إلى المنتج المحدد
            },

            // الانتقال إلى عميل
            goToCustomer(customerId) {
                showSection('customers');
                // يمكن إضافة منطق للتمرير إلى العميل المحدد
            },

            // الانتقال إلى مورد
            goToSupplier(supplierId) {
                showSection('suppliers');
                // يمكن إضافة منطق للتمرير إلى المورد المحدد
            },

            // الانتقال إلى فاتورة
            goToInvoice(invoiceId) {
                showSection('invoice-inquiry');
                // يمكن إضافة منطق للبحث عن الفاتورة المحددة
            }
        };

        // ===== نظام التنبيهات والإشعارات المتقدم =====

        const AlertsManager = {
            alerts: [],

            // تهيئة نظام التنبيهات
            initialize() {
                this.checkStockAlerts();
                this.checkSystemAlerts();
                this.updateAlertsDisplay();

                // تحديث دوري كل 5 دقائق
                setInterval(() => {
                    this.checkStockAlerts();
                    this.checkSystemAlerts();
                    this.updateAlertsDisplay();
                }, 5 * 60 * 1000);
            },

            // فحص تنبيهات المخزون
            checkStockAlerts() {
                const lowStockProducts = products.filter(product =>
                    product.quantity <= (settings.lowStockThreshold || 10)
                );

                // إزالة التنبيهات القديمة للمخزون
                this.alerts = this.alerts.filter(alert => alert.type !== 'stock');

                lowStockProducts.forEach(product => {
                    this.addAlert({
                        id: `stock_${product.id}`,
                        type: 'stock',
                        level: product.quantity === 0 ? 'critical' : 'warning',
                        title: product.quantity === 0 ? 'نفد المخزون' : 'مخزون منخفض',
                        message: `${product.name}: ${product.quantity} قطعة متبقية`,
                        action: () => showSection('products'),
                        timestamp: new Date()
                    });
                });
            },

            // فحص تنبيهات النظام
            checkSystemAlerts() {
                // فحص حجم البيانات
                const dataSize = new Blob([JSON.stringify({products, sales, customers, suppliers, expenses})]).size;
                if (dataSize > 5 * 1024 * 1024) { // أكثر من 5 ميجا
                    this.addAlert({
                        id: 'data_size',
                        type: 'system',
                        level: 'warning',
                        title: 'حجم البيانات كبير',
                        message: `حجم البيانات: ${(dataSize / 1024 / 1024).toFixed(2)} ميجا. يُنصح بعمل نسخة احتياطية`,
                        action: () => showSection('backup'),
                        timestamp: new Date()
                    });
                }

                // فحص آخر نسخة احتياطية
                const lastBackup = localStorage.getItem('lastBackupDate');
                if (!lastBackup || (Date.now() - new Date(lastBackup).getTime()) > 7 * 24 * 60 * 60 * 1000) {
                    this.addAlert({
                        id: 'backup_reminder',
                        type: 'system',
                        level: 'info',
                        title: 'تذكير النسخ الاحتياطي',
                        message: 'لم يتم عمل نسخة احتياطية منذ أكثر من أسبوع',
                        action: () => showSection('backup'),
                        timestamp: new Date()
                    });
                }
            },

            // إضافة تنبيه
            addAlert(alert) {
                // تجنب التكرار
                const existingIndex = this.alerts.findIndex(a => a.id === alert.id);
                if (existingIndex !== -1) {
                    this.alerts[existingIndex] = alert;
                } else {
                    this.alerts.push(alert);
                }

                // الاحتفاظ بآخر 20 تنبيه فقط
                if (this.alerts.length > 20) {
                    this.alerts = this.alerts.slice(-20);
                }
            },

            // تحديث عرض التنبيهات
            updateAlertsDisplay() {
                const container = document.getElementById('alertsList');
                const counter = document.getElementById('alertsCount');

                if (!container || !counter) return;

                counter.textContent = this.alerts.length;

                if (this.alerts.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #ccc; padding: 20px;">
                            <i class="fas fa-check-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                            <p>لا توجد تنبيهات جديدة</p>
                        </div>
                    `;
                    return;
                }

                const html = this.alerts.slice(-5).reverse().map(alert => `
                    <div class="alert-item ${alert.level}" onclick="AlertsManager.handleAlertClick('${alert.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px;">${alert.title}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">${alert.message}</div>
                                <div style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">
                                    ${alert.timestamp.toLocaleString('ar-SA')}
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); AlertsManager.dismissAlert('${alert.id}')"
                                    style="background: none; border: none; color: inherit; opacity: 0.7; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
            },

            // التعامل مع النقر على التنبيه
            handleAlertClick(alertId) {
                const alert = this.alerts.find(a => a.id === alertId);
                if (alert && alert.action) {
                    alert.action();
                }
            },

            // إزالة تنبيه
            dismissAlert(alertId) {
                this.alerts = this.alerts.filter(a => a.id !== alertId);
                this.updateAlertsDisplay();
            },

            // إزالة جميع التنبيهات
            clearAllAlerts() {
                this.alerts = [];
                this.updateAlertsDisplay();
                NotificationUtils.showSuccess('تم مسح جميع التنبيهات');
            }
        };

        // ===== نظام البيانات اللحظية =====

        const RealTimeDataManager = {
            updateInterval: null,

            // بدء تحديث البيانات اللحظية
            start() {
                this.updateRealTimeData();
                this.updateInterval = setInterval(() => {
                    this.updateRealTimeData();
                }, 1000); // تحديث كل ثانية
            },

            // إيقاف تحديث البيانات اللحظية
            stop() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            },

            // تحديث البيانات اللحظية
            updateRealTimeData() {
                this.updateCurrentTime();
                this.updateActiveUsers();
                this.updateTodayOrders();
                this.updateSystemLoad();
            },

            // تحديث الوقت الحالي
            updateCurrentTime() {
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    const now = new Date();
                    timeElement.textContent = now.toLocaleTimeString('ar-SA', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
            },

            // تحديث المستخدمين النشطين
            updateActiveUsers() {
                const usersElement = document.getElementById('activeUsers');
                if (usersElement) {
                    // محاكاة عدد المستخدمين النشطين
                    const activeUsers = Math.floor(Math.random() * 3) + 1;
                    usersElement.textContent = activeUsers;
                }
            },

            // تحديث طلبات اليوم
            updateTodayOrders() {
                const ordersElement = document.getElementById('todayOrders');
                if (ordersElement) {
                    try {
                        const salesArray = Array.isArray(sales) ? sales : [];
                        const today = new Date().toDateString();
                        const todayOrders = salesArray.filter(sale => {
                            try {
                                if (!sale || !sale.date) return false;
                                return new Date(sale.date).toDateString() === today;
                            } catch {
                                return false;
                            }
                        }).length;
                        ordersElement.textContent = todayOrders.toString();
                    } catch (error) {
                        console.error('❌ خطأ في تحديث طلبات اليوم:', error);
                        ordersElement.textContent = '0';
                    }
                }
            },

            // تحديث حمولة النظام
            updateSystemLoad() {
                const loadElement = document.getElementById('systemLoad');
                if (loadElement) {
                    try {
                        const productsCount = Array.isArray(products) ? products.length : 0;
                        const salesCount = Array.isArray(sales) ? sales.length : 0;
                        const customersCount = Array.isArray(customers) ? customers.length : 0;
                        const suppliersCount = Array.isArray(suppliers) ? suppliers.length : 0;

                        const totalRecords = productsCount + salesCount + customersCount + suppliersCount;
                        let loadLevel = 'منخفض';
                        let loadColor = '#28a745';

                        if (totalRecords > 1000) {
                            loadLevel = 'عالي';
                            loadColor = '#dc3545';
                        } else if (totalRecords > 500) {
                            loadLevel = 'متوسط';
                            loadColor = '#ffc107';
                        }

                        loadElement.textContent = loadLevel;
                        loadElement.style.color = loadColor;
                    } catch (error) {
                        console.error('❌ خطأ في تحديث حمولة النظام:', error);
                        loadElement.textContent = 'غير محدد';
                        loadElement.style.color = '#6c757d';
                    }
                }
            }
        };

        // ===== وظائف لوحة التحكم التفاعلية =====

        // البحث السريع
        function performQuickSearch(query) {
            QuickSearchManager.performSearch(query);
        }

        // إخفاء/إظهار المخططات
        function toggleChartsVisibility() {
            try {
                const container = document.getElementById('chartsContainer');
                const icon = document.getElementById('chartsToggleIcon');
                const text = document.getElementById('chartsToggleText');

                if (!container || !icon || !text) {
                    console.warn('⚠️ عناصر التحكم في المخططات غير موجودة');
                    return;
                }

                if (container.style.display === 'none') {
                    container.style.display = 'grid';
                    icon.className = 'fas fa-eye';
                    text.textContent = 'إخفاء';

                    // إعادة تهيئة المخططات عند الإظهار
                    setTimeout(() => {
                        ChartsManager.reinitializeCharts();
                    }, 300);

                    NotificationUtils.showInfo('تم إظهار المخططات البيانية 📊');
                } else {
                    container.style.display = 'none';
                    icon.className = 'fas fa-eye-slash';
                    text.textContent = 'إظهار';
                    NotificationUtils.showInfo('تم إخفاء المخططات البيانية 👁️');
                }

                ActivityLogger.log('toggleChartsVisibility', { visible: container.style.display !== 'none' });
            } catch (error) {
                console.error('❌ خطأ في تبديل عرض المخططات:', error);
                ErrorHandler.logError(error, 'toggleChartsVisibility', 'low');
            }
        }

        // إخفاء الأفكار السريعة (الزر يخفي النافذة فقط)
        function toggleQuickIdeas() {
            try {
                const quickIdeas = document.getElementById('quickIdeas');
                const toggleIcon = document.getElementById('quickIdeasToggleIcon');

                if (!quickIdeas || !toggleIcon) {
                    console.warn('⚠️ عناصر الأفكار السريعة غير موجودة');
                    return;
                }

                const isCollapsed = quickIdeas.classList.contains('collapsed');

                // إخفاء النافذة دائماً عند الضغط على الزر
                quickIdeas.style.display = 'none';
                NotificationUtils.showInfo('تم إخفاء الأفكار السريعة. استخدم الزر الخارجي للوصول إليها مرة أخرى 💡');

                ActivityLogger.log('toggleQuickIdeas', { collapsed: !isCollapsed });
            } catch (error) {
                console.error('❌ خطأ في تبديل الأفكار السريعة:', error);
                ErrorHandler.logError(error, 'toggleQuickIdeas', 'low');
            }
        }

        // استعادة حالة الأفكار السريعة عند التحميل
        function restoreQuickIdeasState() {
            try {
                const quickIdeas = document.getElementById('quickIdeas');
                const toggleIcon = document.getElementById('quickIdeasToggleIcon');
                const isCollapsed = localStorage.getItem('quickIdeasCollapsed') === 'true';

                if (quickIdeas && toggleIcon && isCollapsed) {
                    quickIdeas.classList.add('collapsed');
                    toggleIcon.className = 'fas fa-chevron-right';
                }

                // تحميل الأفكار المخصصة
                loadCustomQuickIdeas();
            } catch (error) {
                console.error('❌ خطأ في استعادة حالة الأفكار السريعة:', error);
            }
        }

        // إدارة الأفكار السريعة المخصصة
        let customQuickIdeas = [];
        let quickIdeasSettings = {
            enabled: false,           // القيمة الافتراضية: إخفاء
            position: 'bottom-left',
            size: 'medium',
            opacity: 0.95,
            autoCollapse: false
        };

        // إعدادات التأثيرات والحركة
        let effectsSettings = {
            animations: false,           // القيمة الافتراضية: إيقاف
            particles: false,           // القيمة الافتراضية: إيقاف
            mouseEffects: false,        // القيمة الافتراضية: إيقاف
            soundEffects: false,        // القيمة الافتراضية: إيقاف
            glowEffects: false,         // القيمة الافتراضية: إيقاف
            hologramEffects: false,     // القيمة الافتراضية: إيقاف
            dynamicColors: false,       // القيمة الافتراضية: إيقاف
            animationSpeed: 'normal'    // القيمة الافتراضية: عادي
        };

        // تحميل الأفكار المخصصة من localStorage
        function loadCustomQuickIdeas() {
            try {
                const saved = localStorage.getItem('customQuickIdeas');
                if (saved) {
                    customQuickIdeas = JSON.parse(saved);
                    updateQuickIdeasDisplay();
                }

                // تحميل إعدادات الأفكار السريعة
                const savedSettings = localStorage.getItem('quickIdeasSettings');
                if (savedSettings) {
                    quickIdeasSettings = { ...quickIdeasSettings, ...JSON.parse(savedSettings) };
                    applyQuickIdeasSettings();
                }

                // تحميل إعدادات التأثيرات
                loadEffectsSettings();
            } catch (error) {
                console.error('خطأ في تحميل الأفكار المخصصة:', error);
            }
        }

        // تحميل إعدادات التأثيرات
        function loadEffectsSettings() {
            try {
                const saved = localStorage.getItem('effectsSettings');
                if (saved) {
                    effectsSettings = { ...effectsSettings, ...JSON.parse(saved) };
                }
                updateEffectsUI();
                applyEffectsSettings();
            } catch (error) {
                console.error('خطأ في تحميل إعدادات التأثيرات:', error);
            }
        }

        // حفظ إعدادات التأثيرات
        function saveEffectsSettings() {
            try {
                localStorage.setItem('effectsSettings', JSON.stringify(effectsSettings));
            } catch (error) {
                console.error('خطأ في حفظ إعدادات التأثيرات:', error);
            }
        }

        // تحديث واجهة إعدادات التأثيرات
        function updateEffectsUI() {
            const checkboxes = {
                'enableAnimations': effectsSettings.animations,
                'enableParticles': effectsSettings.particles,
                'enableMouseEffects': effectsSettings.mouseEffects,
                'enableSoundEffects': effectsSettings.soundEffects,
                'enableGlowEffects': effectsSettings.glowEffects,
                'enableHologramEffects': effectsSettings.hologramEffects,
                'enableDynamicColors': effectsSettings.dynamicColors
            };

            Object.keys(checkboxes).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = checkboxes[id];
            });

            const speedSelect = document.getElementById('animationSpeed');
            if (speedSelect) speedSelect.value = effectsSettings.animationSpeed;
        }

        // تطبيق إعدادات التأثيرات
        function applyEffectsSettings() {
            // تطبيق سرعة التأثيرات
            const speedMultiplier = {
                'slow': 2,
                'normal': 1,
                'fast': 0.5
            };

            const speed = speedMultiplier[effectsSettings.animationSpeed] || 1;
            document.documentElement.style.setProperty('--animation-speed', speed);

            // تطبيق CSS للتحكم في التأثيرات
            const style = document.getElementById('effects-control-style') || document.createElement('style');
            style.id = 'effects-control-style';

            let css = '';

            if (!effectsSettings.animations) {
                css += `
                    *, *::before, *::after {
                        animation-duration: 0.01ms !important;
                        animation-iteration-count: 1 !important;
                        transition-duration: 0.01ms !important;
                    }
                    .btn:hover, .nav-link:hover, .stat-card:hover, .table tr:hover {
                        transform: none !important;
                    }
                    .ripple, .energy-pulse::before {
                        display: none !important;
                    }
                    .sidebar, .main-content, .section.active, .stat-card {
                        animation: none !important;
                    }
                    .animate-in, .scroll-reveal {
                        animation: none !important;
                    }
                `;
            }

            if (!effectsSettings.particles) {
                css += '.particles-container, .particle { display: none !important; }';
            }

            if (!effectsSettings.mouseEffects) {
                css += '.mouse-trail, .light-cursor { display: none !important; }';
            }

            if (!effectsSettings.glowEffects) {
                css += `
                    .success-glow, .error-glow, .warning-glow, .info-glow,
                    .advanced-shadow { box-shadow: none !important; }
                    .stat-card:hover, .btn:hover, .nav-link:hover {
                        box-shadow: none !important;
                        filter: none !important;
                    }
                    .glowing-border::after {
                        display: none !important;
                    }
                `;
            }

            if (!effectsSettings.hologramEffects) {
                css += `
                    .hologram-effect {
                        background: none !important;
                        animation: none !important;
                    }
                    .reflection-effect::after {
                        display: none !important;
                    }
                `;
            }

            if (!effectsSettings.dynamicColors) {
                css += `
                    .text-gradient {
                        background: none !important;
                        -webkit-text-fill-color: inherit !important;
                        color: var(--text-primary) !important;
                        animation: none !important;
                    }
                    .animated-border {
                        border: 1px solid var(--border-color) !important;
                        animation: none !important;
                        filter: none !important;
                    }
                    .mesh-gradient {
                        background: var(--bg-secondary) !important;
                        animation: none !important;
                    }
                `;
            }

            style.textContent = css;
            if (!document.head.contains(style)) {
                document.head.appendChild(style);
            }

            // إزالة العناصر المتحركة إذا كانت معطلة
            if (!effectsSettings.particles) {
                document.querySelectorAll('.particle').forEach(p => p.remove());
            }

            if (!effectsSettings.mouseEffects) {
                document.querySelectorAll('.mouse-trail, .light-cursor').forEach(el => el.remove());
            }
        }

        // وظائف التحكم في التأثيرات الفردية
        function toggleAnimations() {
            const checkbox = document.getElementById('enableAnimations');
            effectsSettings.animations = checkbox.checked;
            saveEffectsSettings();
            applyEffectsSettings();

            // إعادة تشغيل التأثيرات عند التفعيل
            if (effectsSettings.animations) {
                addInteractionEffects();
                if (window.initScrollReveal) initScrollReveal();
                if (window.initCounterAnimations) initCounterAnimations();
            }

            const message = effectsSettings.animations ? 'تم تفعيل التأثيرات الحركية ✨' : 'تم إيقاف التأثيرات الحركية ⏸️';
            NotificationUtils.showInfo(message);
        }

        function toggleParticles() {
            const checkbox = document.getElementById('enableParticles');
            effectsSettings.particles = checkbox.checked;
            saveEffectsSettings();
            applyEffectsSettings();

            if (effectsSettings.particles && window.initParticleSystem) {
                setTimeout(() => {
                    initParticleSystem();
                }, 100);
            } else {
                // إزالة الجسيمات الموجودة
                document.querySelectorAll('.particle').forEach(p => p.remove());
                const container = document.querySelector('.particles-container');
                if (container) container.remove();
            }

            const message = effectsSettings.particles ? 'تم تفعيل نظام الجسيمات 🌟' : 'تم إيقاف نظام الجسيمات ❌';
            NotificationUtils.showInfo(message);
        }

        function toggleMouseEffects() {
            const checkbox = document.getElementById('enableMouseEffects');
            effectsSettings.mouseEffects = checkbox.checked;
            saveEffectsSettings();
            applyEffectsSettings();

            if (effectsSettings.mouseEffects && window.initMouseEffects) {
                setTimeout(() => {
                    initMouseEffects();
                }, 100);
            } else {
                // إزالة تأثيرات الماوس الموجودة
                document.querySelectorAll('.mouse-trail, .light-cursor').forEach(el => el.remove());
            }

            const message = effectsSettings.mouseEffects ? 'تم تفعيل تأثيرات الماوس 🖱️' : 'تم إيقاف تأثيرات الماوس ❌';
            NotificationUtils.showInfo(message);
        }

        function toggleSoundEffects() {
            const checkbox = document.getElementById('enableSoundEffects');
            effectsSettings.soundEffects = checkbox.checked;
            saveEffectsSettings();
            localStorage.setItem('soundEnabled', effectsSettings.soundEffects);

            // إعادة تهيئة التأثيرات الصوتية
            if (effectsSettings.soundEffects) {
                initSoundEffects();
            } else {
                // إزالة مستمعي الأحداث الصوتية
                removeSoundEventListeners();
            }

            const message = effectsSettings.soundEffects ? 'تم تفعيل التأثيرات الصوتية 🔊' : 'تم إيقاف التأثيرات الصوتية 🔇';
            NotificationUtils.showInfo(message);
        }

        // إزالة مستمعي الأحداث الصوتية
        function removeSoundEventListeners() {
            // إزالة مستمع النقر الصوتي
            document.removeEventListener('click', soundClickHandler);
        }

        // معالج النقر الصوتي (منفصل للتمكن من إزالته)
        function soundClickHandler(e) {
            if (!effectsSettings.soundEffects) return;

            if (e.target.classList.contains('btn') || e.target.closest('.btn') ||
                e.target.classList.contains('nav-link') || e.target.closest('.nav-link')) {
                playClickSound();
            }
        }

        function toggleGlowEffects() {
            const checkbox = document.getElementById('enableGlowEffects');
            effectsSettings.glowEffects = checkbox.checked;
            saveEffectsSettings();
            applyEffectsSettings();

            const message = effectsSettings.glowEffects ? 'تم تفعيل تأثيرات التوهج ✨' : 'تم إيقاف تأثيرات التوهج ❌';
            NotificationUtils.showInfo(message);
        }

        function toggleHologramEffects() {
            const checkbox = document.getElementById('enableHologramEffects');
            effectsSettings.hologramEffects = checkbox.checked;
            saveEffectsSettings();
            applyEffectsSettings();

            const message = effectsSettings.hologramEffects ? 'تم تفعيل تأثيرات الهولوجرام 🌈' : 'تم إيقاف تأثيرات الهولوجرام ❌';
            NotificationUtils.showInfo(message);
        }

        function toggleDynamicColors() {
            const checkbox = document.getElementById('enableDynamicColors');
            effectsSettings.dynamicColors = checkbox.checked;
            saveEffectsSettings();

            if (effectsSettings.dynamicColors && window.initDynamicColors) {
                initDynamicColors();
            }

            const message = effectsSettings.dynamicColors ? 'تم تفعيل الألوان الديناميكية 🎨' : 'تم إيقاف الألوان الديناميكية ❌';
            NotificationUtils.showInfo(message);
        }

        function changeAnimationSpeed() {
            const select = document.getElementById('animationSpeed');
            effectsSettings.animationSpeed = select.value;
            saveEffectsSettings();
            applyEffectsSettings();

            const speedNames = {
                'slow': 'بطيء',
                'normal': 'عادي',
                'fast': 'سريع'
            };

            NotificationUtils.showInfo(`تم تغيير سرعة التأثيرات إلى: ${speedNames[effectsSettings.animationSpeed]} ⚡`);
        }

        // وظائف التحكم الشامل
        function resetEffectsToDefault() {
            if (confirm('هل تريد استعادة الإعدادات الافتراضية للتأثيرات؟')) {
                effectsSettings = {
                    animations: false,
                    particles: false,
                    mouseEffects: false,
                    soundEffects: false,
                    glowEffects: false,
                    hologramEffects: false,
                    dynamicColors: false,
                    animationSpeed: 'normal'
                };

                saveEffectsSettings();
                updateEffectsUI();
                applyEffectsSettings();

                NotificationUtils.showSuccess('تم استعادة الإعدادات الافتراضية ✅');
            }
        }

        function disableAllEffects() {
            if (confirm('هل تريد إيقاف جميع التأثيرات؟')) {
                Object.keys(effectsSettings).forEach(key => {
                    if (key !== 'animationSpeed') {
                        effectsSettings[key] = false;
                    }
                });

                saveEffectsSettings();
                updateEffectsUI();
                applyEffectsSettings();

                NotificationUtils.showWarning('تم إيقاف جميع التأثيرات ⏸️');
            }
        }

        function enableAllEffects() {
            if (confirm('هل تريد تفعيل جميع التأثيرات؟')) {
                Object.keys(effectsSettings).forEach(key => {
                    if (key !== 'animationSpeed') {
                        effectsSettings[key] = true;
                    }
                });

                saveEffectsSettings();
                updateEffectsUI();
                applyEffectsSettings();

                // إعادة تشغيل التأثيرات
                setTimeout(() => {
                    if (window.initParticleSystem) initParticleSystem();
                    if (window.initMouseEffects) initMouseEffects();
                    if (window.initDynamicColors) initDynamicColors();
                }, 500);

                NotificationUtils.showSuccess('تم تفعيل جميع التأثيرات! 🎉✨');
            }
        }

        // حفظ الأفكار المخصصة
        function saveCustomQuickIdeas() {
            try {
                localStorage.setItem('customQuickIdeas', JSON.stringify(customQuickIdeas));
            } catch (error) {
                console.error('خطأ في حفظ الأفكار المخصصة:', error);
            }
        }

        // حفظ إعدادات الأفكار السريعة
        function saveQuickIdeasSettings() {
            try {
                localStorage.setItem('quickIdeasSettings', JSON.stringify(quickIdeasSettings));
            } catch (error) {
                console.error('خطأ في حفظ إعدادات الأفكار السريعة:', error);
            }
        }

        // عرض نافذة إدارة الأفكار السريعة
        function showQuickIdeasManager() {
            try {
                // إظهار الأفكار السريعة مؤقتاً
                const quickIdeas = document.getElementById('quickIdeas');
                if (quickIdeas) {
                    quickIdeas.style.display = 'block';

                    // إخفاءها تلقائياً بعد 10 ثوانٍ
                    setTimeout(() => {
                        quickIdeas.style.display = 'none';
                    }, 10000);
                }

                updateCurrentIdeasList();
                showModal('quickIdeasManagerModal');
                ActivityLogger.log('showQuickIdeasManager');
            } catch (error) {
                console.error('خطأ في عرض إدارة الأفكار:', error);
                NotificationUtils.showError('خطأ في فتح إدارة الأفكار');
            }
        }

        // تحديث قائمة الأفكار الحالية في النافذة
        function updateCurrentIdeasList() {
            const container = document.getElementById('currentIdeasList');
            if (!container) return;

            const defaultIdeas = [
                { title: 'إضافة منتج جديد', description: 'أضف منتجات جديدة لمتجرك', func: 'showAddProductModal()', isDefault: true },
                { title: 'بيع سريع', description: 'ابدأ عملية بيع فورية', func: 'showQuickSaleModal()', isDefault: true },
                { title: 'لوحة التحكم', description: 'اطلع على أداء اليوم', func: "showSection('dashboard')", isDefault: true },
                { title: 'نقطة البيع', description: 'ابدأ عملية بيع جديدة', func: "showSection('pos')", isDefault: true },
                { title: 'إدارة المنتجات', description: 'عرض وتعديل المنتجات', func: "showSection('products')", isDefault: true }
            ];

            const allIdeas = [...defaultIdeas, ...customQuickIdeas];

            container.innerHTML = allIdeas.map((idea, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${idea.isDefault ? 'linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1))' : 'linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 193, 7, 0.1))'}; border-radius: 6px; margin-bottom: 8px; border: 1px solid ${idea.isDefault ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255, 193, 7, 0.3)'};">
                    <div>
                        <strong style="color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${idea.title}</strong><br>
                        <small style="color: rgba(255,255,255,0.8);">${idea.description}</small><br>
                        <code style="font-size: 11px; color: #ffeb3b; background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 3px;">${idea.func}</code>
                    </div>
                    <div>
                        ${idea.isDefault ?
                            '<span style="color: #4caf50; font-size: 12px; background: rgba(76, 175, 80, 0.2); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(76, 175, 80, 0.3);"><i class="fas fa-lock"></i> افتراضي</span>' :
                            `<button onclick="removeCustomQuickIdea(${index - defaultIdeas.length})" class="btn btn-sm btn-danger" style="padding: 5px 8px; font-size: 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); border: none; color: white;"><i class="fas fa-trash"></i></button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        // إضافة فكرة جديدة
        function addNewQuickIdea() {
            try {
                const title = document.getElementById('newIdeaTitle').value.trim();
                const description = document.getElementById('newIdeaDescription').value.trim();
                const actionSelect = document.getElementById('newIdeaAction');
                const customFunction = document.getElementById('newIdeaFunction').value.trim();

                if (!title || !description) {
                    NotificationUtils.showWarning('يرجى إدخال العنوان والوصف! ⚠️');
                    return;
                }

                let func = '';
                if (actionSelect.value === 'custom') {
                    if (!customFunction) {
                        NotificationUtils.showWarning('يرجى إدخال الوظيفة المخصصة! ⚠️');
                        return;
                    }
                    func = customFunction;
                } else if (actionSelect.value) {
                    func = actionSelect.value;
                } else {
                    NotificationUtils.showWarning('يرجى اختيار إجراء! ⚠️');
                    return;
                }

                const newIdea = {
                    title: title,
                    description: description,
                    func: func,
                    isDefault: false
                };

                customQuickIdeas.push(newIdea);
                saveCustomQuickIdeas();
                updateQuickIdeasDisplay();
                updateCurrentIdeasList();

                // مسح النموذج
                document.getElementById('newIdeaTitle').value = '';
                document.getElementById('newIdeaDescription').value = '';
                document.getElementById('newIdeaAction').value = '';
                document.getElementById('newIdeaFunction').value = '';
                document.getElementById('customFunctionDiv').style.display = 'none';

                NotificationUtils.showSuccess(`تم إضافة "${title}" ✅`);
                ActivityLogger.log('addNewQuickIdea', { title: title });
            } catch (error) {
                console.error('خطأ في إضافة الفكرة:', error);
                NotificationUtils.showError('خطأ في إضافة الفكرة! ❌');
            }
        }

        // حذف فكرة مخصصة
        function removeCustomQuickIdea(index) {
            try {
                if (index >= 0 && index < customQuickIdeas.length) {
                    const idea = customQuickIdeas[index];
                    if (confirm(`حذف "${idea.title}"؟`)) {
                        customQuickIdeas.splice(index, 1);
                        saveCustomQuickIdeas();
                        updateQuickIdeasDisplay();
                        updateCurrentIdeasList();
                        NotificationUtils.showSuccess(`تم حذف "${idea.title}" 🗑️`);
                        ActivityLogger.log('removeCustomQuickIdea', { title: idea.title });
                    }
                }
            } catch (error) {
                console.error('خطأ في حذف الفكرة:', error);
                NotificationUtils.showError('خطأ في حذف الفكرة! ❌');
            }
        }

        // استعادة الأفكار الافتراضية
        function resetQuickIdeasToDefault() {
            try {
                if (confirm('هل تريد حذف جميع الأفكار المخصصة واستعادة الافتراضية؟')) {
                    customQuickIdeas = [];
                    saveCustomQuickIdeas();
                    updateQuickIdeasDisplay();
                    updateCurrentIdeasList();
                    NotificationUtils.showSuccess('تم استعادة الأفكار الافتراضية ✅');
                    ActivityLogger.log('resetQuickIdeasToDefault');
                }
            } catch (error) {
                console.error('خطأ في استعادة الأفكار الافتراضية:', error);
                NotificationUtils.showError('خطأ في الاستعادة! ❌');
            }
        }

        // وظائف إضافية للخيارات الجديدة
        function showAddExpenseModal() {
            NotificationUtils.showInfo('سيتم إضافة نافذة إضافة المصروفات قريباً 🚧');
        }

        function showAddCategoryModal() {
            NotificationUtils.showInfo('سيتم إضافة نافذة إضافة الفئات قريباً 🚧');
        }

        function showQuickPurchaseModal() {
            NotificationUtils.showInfo('سيتم إضافة نافذة الشراء السريع قريباً 🚧');
        }

        function showInventoryCheckModal() {
            NotificationUtils.showInfo('سيتم إضافة نافذة الجرد السريع قريباً 🚧');
        }

        function showDailyReportModal() {
            NotificationUtils.showInfo('سيتم إضافة التقرير اليومي قريباً 📊');
        }

        function showCashCountModal() {
            NotificationUtils.showInfo('سيتم إضافة نافذة عد النقدية قريباً 💵');
        }

        function generateSalesReport() {
            NotificationUtils.showInfo('سيتم إضافة تقرير المبيعات قريباً 📈');
        }

        function generateInventoryReport() {
            NotificationUtils.showInfo('سيتم إضافة تقرير المخزون قريباً 📦');
        }

        function generateProfitReport() {
            NotificationUtils.showInfo('سيتم إضافة تقرير الأرباح قريباً 💰');
        }

        function backupData() {
            NotificationUtils.showInfo('سيتم إضافة النسخ الاحتياطي قريباً 💾');
        }

        function showCalculatorModal() {
            NotificationUtils.showInfo('سيتم إضافة الآلة الحاسبة قريباً 🧮');
        }

        function showNotesModal() {
            NotificationUtils.showInfo('سيتم إضافة الملاحظات السريعة قريباً 📝');
        }

        function showHelpModal() {
            NotificationUtils.showInfo('سيتم إضافة نافذة المساعدة قريباً ❓');
        }

        function showShortcutsModal() {
            NotificationUtils.showInfo('سيتم إضافة اختصارات لوحة المفاتيح قريباً ⌨️');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    NotificationUtils.showSuccess('تم تفعيل ملء الشاشة 🖥️');
                }).catch(() => {
                    NotificationUtils.showError('فشل في تفعيل ملء الشاشة ❌');
                });
            } else {
                document.exitFullscreen().then(() => {
                    NotificationUtils.showSuccess('تم إلغاء ملء الشاشة 📱');
                });
            }
        }

        function clearCache() {
            if (confirm('هل تريد مسح التخزين المؤقت؟ سيتم إعادة تحميل الصفحة.')) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload();
            }
        }

        function resetSettings() {
            if (confirm('هل تريد إعادة تعيين جميع الإعدادات؟')) {
                localStorage.removeItem('quickIdeasSettings');
                localStorage.removeItem('effectsSettings');
                localStorage.removeItem('customQuickIdeas');
                NotificationUtils.showSuccess('تم إعادة تعيين الإعدادات ✅');
                setTimeout(() => location.reload(), 1000);
            }
        }

        function showSystemInfo() {
            const info = `
🖥️ معلومات النظام:
• المتصفح: ${navigator.userAgent.split(' ')[0]}
• الإصدار: 2.0.0
• آخر تحديث: ${new Date().toLocaleDateString('ar')}
• الذاكرة المستخدمة: ${(performance.memory?.usedJSHeapSize / 1024 / 1024).toFixed(2) || 'غير متاح'} MB
            `;
            alert(info);
        }

        function checkForUpdates() {
            NotificationUtils.showInfo('جاري فحص التحديثات... 🔄');
            setTimeout(() => {
                NotificationUtils.showSuccess('النظام محدث لآخر إصدار! ✅');
            }, 2000);
        }

        // ===== نظام تحليل الكلمات المتقدم =====

        // تحليل الكلمات المفتاحية
        function analyzeKeywords() {
            try {
                const results = document.getElementById('smartAnalysisResults');
                results.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> جاري تحليل الكلمات...</div>';

                setTimeout(() => {
                    const keywordAnalysis = performKeywordAnalysis();
                    displayKeywordResults(keywordAnalysis);
                }, 1000);

            } catch (error) {
                console.error('خطأ في تحليل الكلمات:', error);
                NotificationUtils.showError('خطأ في تحليل الكلمات');
            }
        }

        // تنفيذ تحليل الكلمات
        function performKeywordAnalysis() {
            const allText = [];

            // جمع النصوص من المنتجات
            products.forEach(product => {
                if (product.name) allText.push(product.name);
                if (product.description) allText.push(product.description);
                if (product.category) allText.push(product.category);
            });

            // جمع النصوص من العملاء
            customers.forEach(customer => {
                if (customer.name) allText.push(customer.name);
                if (customer.notes) allText.push(customer.notes);
            });

            // جمع النصوص من الموردين
            suppliers.forEach(supplier => {
                if (supplier.name) allText.push(supplier.name);
                if (supplier.company) allText.push(supplier.company);
                if (supplier.notes) allText.push(supplier.notes);
            });

            // تحليل الكلمات
            const wordFrequency = analyzeWordFrequency(allText);
            const categories = analyzeCategoryDistribution();
            const trends = analyzeSearchTrends();

            return {
                wordFrequency,
                categories,
                trends,
                totalWords: allText.join(' ').split(' ').length,
                uniqueWords: Object.keys(wordFrequency).length
            };
        }

        // تحليل تكرار الكلمات
        function analyzeWordFrequency(textArray) {
            const frequency = {};
            const stopWords = ['في', 'من', 'إلى', 'على', 'عن', 'مع', 'هذا', 'هذه', 'ذلك', 'تلك', 'التي', 'الذي', 'و', 'أو', 'لا', 'نعم'];

            textArray.forEach(text => {
                if (!text) return;
                const words = text.toLowerCase()
                    .replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\s]/g, '')
                    .split(/\s+/)
                    .filter(word => word.length > 2 && !stopWords.includes(word));

                words.forEach(word => {
                    frequency[word] = (frequency[word] || 0) + 1;
                });
            });

            // ترتيب حسب التكرار
            return Object.entries(frequency)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20)
                .reduce((obj, [word, count]) => {
                    obj[word] = count;
                    return obj;
                }, {});
        }

        // تحليل توزيع الفئات
        function analyzeCategoryDistribution() {
            const categoryCount = {};
            products.forEach(product => {
                const category = product.category || 'غير محدد';
                categoryCount[category] = (categoryCount[category] || 0) + 1;
            });
            return categoryCount;
        }

        // تحليل اتجاهات البحث (محاكاة)
        function analyzeSearchTrends() {
            const trends = [
                { keyword: 'إلكترونيات', trend: '+15%', color: '#4CAF50' },
                { keyword: 'أسلاك', trend: '+8%', color: '#2196F3' },
                { keyword: 'لمبات', trend: '-3%', color: '#FF9800' },
                { keyword: 'أدوات', trend: '+12%', color: '#9C27B0' },
                { keyword: 'ملابس', trend: '+5%', color: '#607D8B' }
            ];
            return trends;
        }

        // عرض نتائج تحليل الكلمات
        function displayKeywordResults(analysis) {
            const results = document.getElementById('smartAnalysisResults');

            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-bar"></i>
                        نتائج تحليل الكلمات المفتاحية
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${analysis.totalWords}</div>
                            <div style="font-size: 12px; opacity: 0.8;">إجمالي الكلمات</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${analysis.uniqueWords}</div>
                            <div style="font-size: 12px; opacity: 0.8;">كلمات فريدة</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${Object.keys(analysis.categories).length}</div>
                            <div style="font-size: 12px; opacity: 0.8;">فئات المنتجات</div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- الكلمات الأكثر تكراراً -->
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                        <h5 style="margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-fire"></i>
                            الكلمات الأكثر تكراراً
                        </h5>
                        <div style="max-height: 300px; overflow-y: auto;">
            `;

            Object.entries(analysis.wordFrequency).forEach(([word, count], index) => {
                const percentage = (count / Math.max(...Object.values(analysis.wordFrequency)) * 100).toFixed(1);
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: ${getColorByIndex(index)}; color: white; padding: 4px 8px; border-radius: 15px; font-size: 12px; font-weight: bold;">${index + 1}</span>
                            <span style="font-weight: 500;">${word}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="background: rgba(255,255,255,0.1); height: 6px; width: 60px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColorByIndex(index)}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-size: 12px; color: #ccc;">${count}</span>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>

                    <!-- توزيع الفئات -->
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                        <h5 style="margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chart-pie"></i>
                            توزيع فئات المنتجات
                        </h5>
                        <div style="max-height: 300px; overflow-y: auto;">
            `;

            Object.entries(analysis.categories).forEach(([category, count], index) => {
                const percentage = (count / products.length * 100).toFixed(1);
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; background: ${getColorByIndex(index)}; border-radius: 50%;"></div>
                            <span style="font-weight: 500;">${category}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 12px; color: #ccc;">${count} منتج</span>
                            <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 10px;">${percentage}%</span>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>

                <!-- اتجاهات البحث -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                    <h5 style="margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-trending-up"></i>
                        اتجاهات البحث والكلمات الرائجة
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            `;

            analysis.trends.forEach(trend => {
                html += `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${trend.keyword}</div>
                        <div style="color: ${trend.color}; font-weight: bold; font-size: 18px;">${trend.trend}</div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="exportKeywordAnalysis()" class="btn btn-success" style="margin-left: 10px;">
                        <i class="fas fa-download"></i> تصدير التحليل
                    </button>
                    <button onclick="generateKeywordRecommendations()" class="btn btn-info">
                        <i class="fas fa-lightbulb"></i> توصيات ذكية
                    </button>
                </div>
            `;

            results.innerHTML = html;
            NotificationUtils.showSuccess('تم تحليل الكلمات بنجاح! 📊');
        }

        // الحصول على لون حسب الفهرس
        function getColorByIndex(index) {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
            ];
            return colors[index % colors.length];
        }

        // الوظائف المساعدة لنظام التحليل
        function exportKeywordAnalysis() {
            NotificationUtils.showSuccess('سيتم إضافة تصدير التحليل قريباً! 📊');
        }

        function generateKeywordRecommendations() {
            const recommendations = [
                '💡 ركز على الكلمات الأكثر تكراراً في وصف المنتجات',
                '🎯 استخدم الكلمات الرائجة في حملاتك التسويقية',
                '📈 اهتم بالفئات ذات النمو المرتفع',
                '🔍 حسّن محركات البحث باستخدام الكلمات المفتاحية'
            ];

            let html = '<div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-top: 20px;">';
            html += '<h5 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-lightbulb"></i> توصيات ذكية</h5>';

            recommendations.forEach((rec, index) => {
                html += `<div style="padding: 10px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid ${getColorByIndex(index)};">${rec}</div>`;
            });

            html += '</div>';
            document.getElementById('smartAnalysisResults').innerHTML += html;
            NotificationUtils.showSuccess('تم إنشاء التوصيات الذكية! 💡');
        }

        function analyzeCustomerBehavior() {
            const results = document.getElementById('smartAnalysisResults');
            results.innerHTML = `
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 15px; color: white;">
                    <h4 style="margin-bottom: 15px;"><i class="fas fa-users"></i> تحليل سلوك العملاء</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${customers.length}</div>
                            <div style="font-size: 12px;">إجمالي العملاء</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">85%</div>
                            <div style="font-size: 12px;">معدل الرضا</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">3.2</div>
                            <div style="font-size: 12px;">متوسط الزيارات</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <h5>📊 أهم النتائج:</h5>
                        <ul style="margin: 10px 0; padding-right: 20px;">
                            <li>العملاء يفضلون التسوق في فترة الظهيرة</li>
                            <li>المنتجات الإلكترونية الأكثر طلباً</li>
                            <li>معدل العودة للشراء مرتفع (75%)</li>
                            <li>العملاء الجدد يشكلون 30% من المبيعات</li>
                        </ul>
                    </div>
                </div>
            `;
            NotificationUtils.showSuccess('تم تحليل سلوك العملاء! 👥');
        }

        // تحليل سلوك العملاء
        function analyzeCustomerBehavior() {
            try {
                const results = document.getElementById('smartAnalysisResults');
                results.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> جاري تحليل سلوك العملاء...</div>';

                setTimeout(() => {
                    const customerAnalysis = performCustomerAnalysis();
                    displayCustomerResults(customerAnalysis);
                }, 1000);

            } catch (error) {
                console.error('خطأ في تحليل العملاء:', error);
                NotificationUtils.showError('خطأ في تحليل سلوك العملاء');
            }
        }

        // تنفيذ تحليل العملاء
        function performCustomerAnalysis() {
            const customerSegments = {
                'عملاء جدد': customers.filter(c => !c.totalPurchases || c.totalPurchases < 3).length,
                'عملاء منتظمون': customers.filter(c => c.totalPurchases >= 3 && c.totalPurchases < 10).length,
                'عملاء مميزون': customers.filter(c => c.totalPurchases >= 10).length
            };

            const purchasePatterns = analyzePurchasePatterns();
            const loyaltyMetrics = calculateLoyaltyMetrics();
            const demographicData = analyzeDemographics();

            return {
                totalCustomers: customers.length,
                segments: customerSegments,
                patterns: purchasePatterns,
                loyalty: loyaltyMetrics,
                demographics: demographicData
            };
        }

        // تحليل أنماط الشراء
        function analyzePurchasePatterns() {
            return {
                'صباحاً (6-12)': Math.floor(Math.random() * 30) + 20,
                'ظهراً (12-18)': Math.floor(Math.random() * 40) + 35,
                'مساءً (18-24)': Math.floor(Math.random() * 25) + 15,
                'ليلاً (24-6)': Math.floor(Math.random() * 10) + 5
            };
        }

        // حساب مقاييس الولاء
        function calculateLoyaltyMetrics() {
            return {
                averageVisits: (Math.random() * 5 + 2).toFixed(1),
                retentionRate: (Math.random() * 30 + 65).toFixed(1) + '%',
                averageSpend: (Math.random() * 200 + 150).toFixed(0) + ' ريال',
                satisfactionScore: (Math.random() * 1 + 4).toFixed(1) + '/5'
            };
        }

        // تحليل البيانات الديموغرافية
        function analyzeDemographics() {
            return {
                'الرياض': 35,
                'جدة': 25,
                'الدمام': 20,
                'مكة': 15,
                'أخرى': 5
            };
        }

        // عرض نتائج تحليل العملاء
        function displayCustomerResults(analysis) {
            const results = document.getElementById('smartAnalysisResults');

            let html = `
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-users"></i>
                        تحليل سلوك العملاء
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${analysis.totalCustomers}</div>
                            <div style="font-size: 12px; opacity: 0.8;">إجمالي العملاء</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${analysis.loyalty.retentionRate}</div>
                            <div style="font-size: 12px; opacity: 0.8;">معدل الاحتفاظ</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${analysis.loyalty.averageSpend}</div>
                            <div style="font-size: 12px; opacity: 0.8;">متوسط الإنفاق</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${analysis.loyalty.satisfactionScore}</div>
                            <div style="font-size: 12px; opacity: 0.8;">رضا العملاء</div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- شرائح العملاء -->
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                        <h5 style="margin-bottom: 15px; color: #f5576c; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chart-pie"></i>
                            شرائح العملاء
                        </h5>
            `;

            Object.entries(analysis.segments).forEach(([segment, count], index) => {
                const percentage = (count / analysis.totalCustomers * 100).toFixed(1);
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; background: ${getColorByIndex(index)}; border-radius: 50%;"></div>
                            <span style="font-weight: 500;">${segment}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 12px; color: #ccc;">${count} عميل</span>
                            <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 10px;">${percentage}%</span>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>

                    <!-- أنماط الشراء -->
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                        <h5 style="margin-bottom: 15px; color: #f5576c; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-clock"></i>
                            أنماط الشراء حسب الوقت
                        </h5>
            `;

            Object.entries(analysis.patterns).forEach(([time, percentage], index) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <span style="font-weight: 500;">${time}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="background: rgba(255,255,255,0.1); height: 6px; width: 60px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColorByIndex(index + 3)}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-size: 12px; color: #ccc;">${percentage}%</span>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="generateCustomerReport()" class="btn btn-success" style="margin-left: 10px;">
                        <i class="fas fa-file-alt"></i> تقرير العملاء
                    </button>
                    <button onclick="createCustomerSegments()" class="btn btn-info">
                        <i class="fas fa-users-cog"></i> إنشاء شرائح مخصصة
                    </button>
                </div>
            `;

            results.innerHTML = html;
            NotificationUtils.showSuccess('تم تحليل سلوك العملاء بنجاح! 👥');
        }

        // وظائف التحكم في إعدادات الأفكار السريعة من قسم الإعدادات
        function toggleQuickIdeasFromSettings() {
            const checkbox = document.getElementById('enableQuickIdeas');
            // الأفكار السريعة تبقى مخفية دائماً - هذا الإعداد يتحكم في إظهار الزر الخارجي فقط
            quickIdeasSettings.enabled = false; // دائماً مخفية
            checkbox.checked = false; // إعادة تعيين الصندوق
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();

            NotificationUtils.showInfo('الأفكار السريعة تبقى مخفية دائماً. استخدم الزر الخارجي للوصول إليها 💡');
        }

        function updateQuickIdeasPosition() {
            const select = document.getElementById('quickIdeasPosition');
            quickIdeasSettings.position = select.value;
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();
            NotificationUtils.showSuccess('تم تحديث موضع الأفكار السريعة ✅');
        }

        function updateQuickIdeasSize() {
            const select = document.getElementById('quickIdeasSize');
            quickIdeasSettings.size = select.value;
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();
            NotificationUtils.showSuccess('تم تحديث حجم الأفكار السريعة ✅');
        }

        function updateQuickIdeasOpacity() {
            const slider = document.getElementById('quickIdeasOpacity');
            const valueSpan = document.getElementById('quickIdeasOpacityValue');
            quickIdeasSettings.opacity = parseFloat(slider.value);
            valueSpan.textContent = slider.value;
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();
        }

        function toggleQuickIdeasAutoCollapse() {
            const checkbox = document.getElementById('quickIdeasAutoCollapse');
            quickIdeasSettings.autoCollapse = checkbox.checked;
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();

            const message = quickIdeasSettings.autoCollapse ? 'تم تفعيل الطي التلقائي 📁' : 'تم إلغاء الطي التلقائي 📂';
            NotificationUtils.showInfo(message);
        }

        // تحديث عرض الأفكار السريعة
        function updateQuickIdeasDisplay() {
            const container = document.getElementById('quickIdeasList');
            if (!container) return;

            const defaultIdeas = [
                { title: 'إضافة منتج جديد', description: 'أضف منتجات جديدة لمتجرك', func: 'showAddProductModal()' },
                { title: 'بيع سريع', description: 'ابدأ عملية بيع فورية', func: 'showQuickSaleModal()' },
                { title: 'لوحة التحكم', description: 'اطلع على أداء اليوم', func: "showSection('dashboard')" },
                { title: 'نقطة البيع', description: 'ابدأ عملية بيع جديدة', func: "showSection('pos')" },
                { title: 'إدارة المنتجات', description: 'عرض وتعديل المنتجات', func: "showSection('products')" }
            ];

            const allIdeas = [...defaultIdeas, ...customQuickIdeas];

            container.innerHTML = allIdeas.map(idea => `
                <div class="idea-item" onclick="${idea.func}">
                    <strong>${idea.title}</strong><br>
                    <small>${idea.description}</small>
                </div>
            `).join('');
        }

        // تطبيق إعدادات الأفكار السريعة
        function applyQuickIdeasSettings() {
            const quickIdeas = document.getElementById('quickIdeas');
            const externalManager = document.getElementById('quickIdeasExternalManager');
            if (!quickIdeas || !externalManager) return;

            // الأفكار السريعة تبقى مخفية دائماً
            quickIdeas.style.display = 'none';
            externalManager.classList.remove('hidden');

            // فرض القيمة لتكون false دائماً
            quickIdeasSettings.enabled = false;

            // تطبيق الموضع
            quickIdeas.className = 'quick-ideas';
            quickIdeas.classList.remove('position-bottom-left', 'position-bottom-right', 'position-top-left', 'position-top-right');
            quickIdeas.classList.add(`position-${quickIdeasSettings.position}`);

            // تطبيق الحجم
            quickIdeas.classList.remove('size-small', 'size-medium', 'size-large');
            quickIdeas.classList.add(`size-${quickIdeasSettings.size}`);

            // تطبيق الشفافية
            quickIdeas.style.background = `linear-gradient(135deg, rgba(26, 35, 126, ${quickIdeasSettings.opacity}) 0%, rgba(74, 144, 226, ${quickIdeasSettings.opacity}) 100%)`;

            // تطبيق الطي التلقائي
            if (quickIdeasSettings.autoCollapse) {
                quickIdeas.classList.add('collapsed');
                const toggleIcon = document.getElementById('quickIdeasToggleIcon');
                if (toggleIcon) toggleIcon.className = 'fas fa-chevron-right';
            }

            // تحديث عناصر الإعدادات
            updateSettingsUI();
        }

        // تحديث واجهة الإعدادات
        function updateSettingsUI() {
            // تحديث إعدادات الأفكار السريعة
            const enableCheckbox = document.getElementById('enableQuickIdeas');
            const positionSelect = document.getElementById('quickIdeasPosition');
            const sizeSelect = document.getElementById('quickIdeasSize');
            const opacityRange = document.getElementById('quickIdeasOpacity');
            const opacityValue = document.getElementById('quickIdeasOpacityValue');
            const autoCollapseCheckbox = document.getElementById('quickIdeasAutoCollapse');

            if (enableCheckbox) enableCheckbox.checked = false; // دائماً مخفية
            if (positionSelect) positionSelect.value = quickIdeasSettings.position;
            if (sizeSelect) sizeSelect.value = quickIdeasSettings.size;
            if (opacityRange) {
                opacityRange.value = quickIdeasSettings.opacity;
                if (opacityValue) opacityValue.textContent = quickIdeasSettings.opacity;
            }
            if (autoCollapseCheckbox) autoCollapseCheckbox.checked = quickIdeasSettings.autoCollapse;

            // تحديث إعدادات التأثيرات
            const animationsCheckbox = document.getElementById('enableAnimations');
            const particlesCheckbox = document.getElementById('enableParticles');
            const mouseEffectsCheckbox = document.getElementById('enableMouseEffects');
            const soundEffectsCheckbox = document.getElementById('enableSoundEffects');
            const glowEffectsCheckbox = document.getElementById('enableGlowEffects');
            const hologramEffectsCheckbox = document.getElementById('enableHologramEffects');
            const dynamicColorsCheckbox = document.getElementById('enableDynamicColors');
            const animationSpeedSelect = document.getElementById('animationSpeed');

            if (animationsCheckbox) animationsCheckbox.checked = effectsSettings.animations;
            if (particlesCheckbox) particlesCheckbox.checked = effectsSettings.particles;
            if (mouseEffectsCheckbox) mouseEffectsCheckbox.checked = effectsSettings.mouseEffects;
            if (soundEffectsCheckbox) soundEffectsCheckbox.checked = effectsSettings.soundEffects;
            if (glowEffectsCheckbox) glowEffectsCheckbox.checked = effectsSettings.glowEffects;
            if (hologramEffectsCheckbox) hologramEffectsCheckbox.checked = effectsSettings.hologramEffects;
            if (dynamicColorsCheckbox) dynamicColorsCheckbox.checked = effectsSettings.dynamicColors;
            if (animationSpeedSelect) animationSpeedSelect.value = effectsSettings.animationSpeed;
        }

        // تبديل رؤية الأفكار السريعة
        function toggleQuickIdeasVisibility() {
            const checkbox = document.getElementById('enableQuickIdeas');
            quickIdeasSettings.enabled = checkbox.checked;
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();

            NotificationUtils.showInfo(quickIdeasSettings.enabled ? 'تم تفعيل الأفكار السريعة ✅' : 'تم إخفاء الأفكار السريعة ❌');
        }

        // تغيير موضع الأفكار السريعة
        function changeQuickIdeasPosition() {
            const select = document.getElementById('quickIdeasPosition');
            quickIdeasSettings.position = select.value;
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();
            NotificationUtils.showInfo('تم تغيير موضع الأداة ✅');
        }

        // تغيير حجم الأفكار السريعة
        function changeQuickIdeasSize() {
            const select = document.getElementById('quickIdeasSize');
            quickIdeasSettings.size = select.value;
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();
            NotificationUtils.showInfo('تم تغيير حجم الأداة ✅');
        }

        // تغيير شفافية الأفكار السريعة
        function changeQuickIdeasOpacity() {
            const range = document.getElementById('quickIdeasOpacity');
            quickIdeasSettings.opacity = parseFloat(range.value);
            saveQuickIdeasSettings();
            applyQuickIdeasSettings();
        }

        // تحديث حقل الوظيفة حسب الاختيار
        function updateFunctionField() {
            const actionSelect = document.getElementById('newIdeaAction');
            const customDiv = document.getElementById('customFunctionDiv');
            const functionInput = document.getElementById('newIdeaFunction');

            if (actionSelect.value === 'custom') {
                customDiv.style.display = 'block';
                functionInput.value = '';
            } else {
                customDiv.style.display = 'none';
                functionInput.value = actionSelect.value;
            }
        }

        // تبديل وضع لوحة التحكم
        function toggleDashboardMode() {
            const chartsSection = document.getElementById('chartsSection');
            const realTimeData = document.getElementById('realTimeData');
            const modeText = document.getElementById('dashboardModeText');

            if (chartsSection.style.display === 'none') {
                // الوضع المتقدم
                chartsSection.style.display = 'block';
                realTimeData.style.display = 'block';
                modeText.textContent = 'الوضع المبسط';
                ChartsManager.updateAllCharts();
                NotificationUtils.showInfo('تم التبديل إلى الوضع المتقدم');
            } else {
                // الوضع المبسط
                chartsSection.style.display = 'none';
                realTimeData.style.display = 'none';
                modeText.textContent = 'الوضع المتقدم';
                NotificationUtils.showInfo('تم التبديل إلى الوضع المبسط');
            }
        }

        // عرض البحث المتقدم
        function showAdvancedSearch() {
            NotificationUtils.showInfo('سيتم إضافة البحث المتقدم قريباً! 🔍');
        }

        // تصدير تقرير لوحة التحكم
        function exportDashboardReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                totalSales: sales.reduce((sum, sale) => sum + sale.total, 0),
                totalProducts: products.length,
                totalCustomers: customers.length,
                totalSuppliers: suppliers.length,
                lowStockProducts: products.filter(p => p.quantity <= (settings.lowStockThreshold || 10)),
                topSellingProducts: ChartsManager.generateTopProductsData(),
                salesData: ChartsManager.generateSalesData(),
                profitsData: ChartsManager.generateProfitsData()
            };

            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            NotificationUtils.showSuccess('تم تصدير تقرير لوحة التحكم بنجاح! 📊');
        }

        // عرض التقرير اليومي
        function showDailyReport() {
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
            const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const totalOrders = todaySales.length;

            const reportHtml = `
                <div style="text-align: center; padding: 20px;">
                    <h3>📊 التقرير اليومي</h3>
                    <p><strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-SA')}</p>
                    <hr>
                    <p><strong>إجمالي المبيعات:</strong> ${totalSales.toFixed(2)} ريال</p>
                    <p><strong>عدد الطلبات:</strong> ${totalOrders}</p>
                    <p><strong>متوسط قيمة الطلب:</strong> ${totalOrders > 0 ? (totalSales / totalOrders).toFixed(2) : 0} ريال</p>
                </div>
            `;

            NotificationUtils.showInfo(reportHtml);
        }

        // تحديث لوحة التحكم
        function updateDashboard() {
            const operationId = PerformanceMonitor.logOperation('updateDashboard');

            try {
                // تحديث الإحصائيات
                updateDashboardStats();

                // تحديث متوازي للأداء
                setTimeout(() => ChartsManager.updateAllCharts(), 0);
                setTimeout(() => {
                    AlertsManager.checkStockAlerts();
                    AlertsManager.checkSystemAlerts();
                    AlertsManager.updateAlertsDisplay();
                }, 0);
                setTimeout(() => RealTimeDataManager.updateRealTimeData(), 0);

                PerformanceMonitor.endOperation(operationId, true);

            } catch (error) {
                PerformanceMonitor.endOperation(operationId, false);
                ErrorHandler.logError(error, 'updateDashboard', 'medium');
                NotificationUtils.showError('خطأ في تحديث لوحة التحكم');
            }
        }

        // تحديث إحصائيات لوحة التحكم
        function updateDashboardStats() {
            try {
                // التأكد من وجود البيانات
                const salesArray = Array.isArray(sales) ? sales : [];
                const productsArray = Array.isArray(products) ? products : [];
                const customersArray = Array.isArray(customers) ? customers : [];

                // تحديث إجمالي المبيعات
                const totalSales = salesArray.reduce((sum, sale) => {
                    const saleTotal = parseFloat(sale?.total) || 0;
                    return sum + saleTotal;
                }, 0);

                const totalSalesElement = document.getElementById('totalSales');
                if (totalSalesElement) {
                    totalSalesElement.textContent = totalSales.toFixed(2);
                }

                // تحديث صافي الربح
                const totalProfit = salesArray.reduce((sum, sale) => {
                    const saleTotal = parseFloat(sale?.total) || 0;
                    const saleProfit = parseFloat(sale?.profit) || (saleTotal * 0.2);
                    return sum + saleProfit;
                }, 0);

                const totalProfitElement = document.getElementById('totalProfit');
                if (totalProfitElement) {
                    totalProfitElement.textContent = totalProfit.toFixed(2);
                }

                // تحديث عدد المنتجات
                const totalProductsElement = document.getElementById('totalProducts');
                if (totalProductsElement) {
                    totalProductsElement.textContent = productsArray.length.toString();
                }

                // تحديث عدد العملاء
                const totalCustomersElement = document.getElementById('totalCustomers');
                if (totalCustomersElement) {
                    totalCustomersElement.textContent = customersArray.length.toString();
                }

                // تحديث إحصائيات إضافية
                updateAdditionalStats(salesArray, productsArray, customersArray);

            } catch (error) {
                console.error('❌ خطأ في تحديث إحصائيات لوحة التحكم:', error);
                ErrorHandler.logError(error, 'updateDashboardStats', 'medium');

                // عرض قيم افتراضية في حالة الخطأ
                setDefaultStats();
            }
        }

        // تحديث إحصائيات إضافية
        function updateAdditionalStats(salesArray, productsArray, customersArray) {
            try {
                // تحديث مبيعات اليوم
                const today = new Date().toDateString();
                const todaySales = salesArray.filter(sale => {
                    try {
                        return new Date(sale.date).toDateString() === today;
                    } catch {
                        return false;
                    }
                });

                const todaySalesTotal = todaySales.reduce((sum, sale) => {
                    return sum + (parseFloat(sale?.total) || 0);
                }, 0);

                const todaySalesElement = document.getElementById('todaySales');
                if (todaySalesElement) {
                    todaySalesElement.textContent = `${todaySalesTotal.toFixed(2)} ريال`;
                }

                // تحديث مبيعات الأسبوع
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);

                const weekSales = salesArray.filter(sale => {
                    try {
                        return new Date(sale.date) >= weekAgo;
                    } catch {
                        return false;
                    }
                });

                const weekSalesTotal = weekSales.reduce((sum, sale) => {
                    return sum + (parseFloat(sale?.total) || 0);
                }, 0);

                const weekSalesElement = document.getElementById('weekSales');
                if (weekSalesElement) {
                    weekSalesElement.textContent = `${weekSalesTotal.toFixed(2)} ريال`;
                }

                // تحديث مبيعات الشهر
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);

                const monthSales = salesArray.filter(sale => {
                    try {
                        return new Date(sale.date) >= monthAgo;
                    } catch {
                        return false;
                    }
                });

                const monthSalesTotal = monthSales.reduce((sum, sale) => {
                    return sum + (parseFloat(sale?.total) || 0);
                }, 0);

                const monthSalesElement = document.getElementById('monthSales');
                if (monthSalesElement) {
                    monthSalesElement.textContent = `${monthSalesTotal.toFixed(2)} ريال`;
                }

                // تحديث إجمالي جميع المبيعات
                const totalAllSalesElement = document.getElementById('totalAllSales');
                if (totalAllSalesElement) {
                    const totalAll = salesArray.reduce((sum, sale) => {
                        return sum + (parseFloat(sale?.total) || 0);
                    }, 0);
                    totalAllSalesElement.textContent = `${totalAll.toFixed(2)} ريال`;
                }

            } catch (error) {
                console.error('❌ خطأ في تحديث الإحصائيات الإضافية:', error);
                ErrorHandler.logError(error, 'updateAdditionalStats', 'low');
            }
        }

        // تعيين قيم افتراضية في حالة الخطأ
        function setDefaultStats() {
            const defaultElements = [
                { id: 'totalSales', value: '0.00' },
                { id: 'totalProfit', value: '0.00' },
                { id: 'totalProducts', value: '0' },
                { id: 'totalCustomers', value: '0' },
                { id: 'todaySales', value: '0.00 ريال' },
                { id: 'weekSales', value: '0.00 ريال' },
                { id: 'monthSales', value: '0.00 ريال' },
                { id: 'totalAllSales', value: '0.00 ريال' }
            ];

            defaultElements.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    element.textContent = item.value;
                }
            });
        }

        // ===== نظام التحقق من التكامل الشامل =====

        const SystemIntegrityChecker = {
            // فحص شامل للنظام
            performFullSystemCheck() {
                console.log('🔍 بدء الفحص الشامل للنظام...');

                const results = {
                    navigation: this.checkNavigationIntegrity(),
                    dataIntegrity: this.checkDataIntegrity(),
                    uiConsistency: this.checkUIConsistency(),
                    functionalIntegrity: this.checkFunctionalIntegrity()
                };

                this.generateSystemReport(results);
                return results;
            },

            // فحص سلامة التنقل
            checkNavigationIntegrity() {
                const issues = [];
                const sections = ['dashboard', 'products', 'pos', 'invoice-inquiry', 'suppliers', 'customers', 'expenses', 'backup', 'settings', 'advanced'];

                sections.forEach(sectionId => {
                    // فحص وجود القسم
                    if (!document.getElementById(sectionId)) {
                        issues.push(`القسم غير موجود: ${sectionId}`);
                    }

                    // فحص وجود الرابط في الشريط الجانبي
                    const sidebarLink = document.querySelector(`.nav-link[onclick="showSection('${sectionId}')"]`);
                    if (!sidebarLink) {
                        issues.push(`رابط الشريط الجانبي مفقود: ${sectionId}`);
                    }

                    // فحص وجود التبويب العلوي
                    const topTab = document.querySelector(`.top-nav-tab[data-section="${sectionId}"]`);
                    if (!topTab) {
                        issues.push(`تبويب علوي مفقود: ${sectionId}`);
                    }
                });

                return {
                    passed: issues.length === 0,
                    issues: issues,
                    score: Math.max(0, 100 - (issues.length * 10))
                };
            },

            // فحص سلامة البيانات
            checkDataIntegrity() {
                const issues = [];

                // فحص المنتجات
                products.forEach((product, index) => {
                    if (!product.id || !product.name) {
                        issues.push(`منتج بدون معرف أو اسم في الفهرس ${index}`);
                    }
                    if (product.price < 0) {
                        issues.push(`منتج بسعر سالب: ${product.name}`);
                    }
                });

                // فحص المبيعات
                sales.forEach((sale, index) => {
                    if (!sale.id || !sale.productId) {
                        issues.push(`بيع بدون معرف في الفهرس ${index}`);
                    }
                    const product = products.find(p => p.id === sale.productId);
                    if (!product) {
                        issues.push(`بيع لمنتج غير موجود: ${sale.productName}`);
                    }
                });

                // فحص العملاء
                customers.forEach((customer, index) => {
                    if (!customer.id || !customer.name) {
                        issues.push(`عميل بدون معرف أو اسم في الفهرس ${index}`);
                    }
                });

                return {
                    passed: issues.length === 0,
                    issues: issues,
                    score: Math.max(0, 100 - (issues.length * 5))
                };
            },

            // فحص اتساق الواجهة
            checkUIConsistency() {
                const issues = [];

                // فحص وجود العناصر الأساسية
                const essentialElements = [
                    'notificationContainer',
                    'themeSelector',
                    'sidebar',
                    'main-content'
                ];

                essentialElements.forEach(elementId => {
                    if (!document.getElementById(elementId)) {
                        issues.push(`عنصر أساسي مفقود: ${elementId}`);
                    }
                });

                // فحص الأنماط
                const requiredClasses = [
                    'section',
                    'nav-link',
                    'top-nav-tab',
                    'btn',
                    'form-control'
                ];

                requiredClasses.forEach(className => {
                    if (document.querySelectorAll(`.${className}`).length === 0) {
                        issues.push(`فئة CSS مفقودة: ${className}`);
                    }
                });

                return {
                    passed: issues.length === 0,
                    issues: issues,
                    score: Math.max(0, 100 - (issues.length * 15))
                };
            },

            // فحص سلامة الوظائف
            checkFunctionalIntegrity() {
                const issues = [];

                // فحص الوظائف الأساسية
                const essentialFunctions = [
                    'showSection',
                    'saveData',
                    'loadData',
                    'updateDashboard',
                    'showModal',
                    'closeModal'
                ];

                essentialFunctions.forEach(funcName => {
                    if (typeof window[funcName] !== 'function') {
                        issues.push(`وظيفة مفقودة: ${funcName}`);
                    }
                });

                // فحص الكائنات المساعدة
                const utilityObjects = [
                    'StateManager',
                    'ValidationUtils',
                    'NotificationUtils',
                    'CashboxUtils',
                    'DiscountUtils'
                ];

                utilityObjects.forEach(objName => {
                    if (typeof window[objName] === 'undefined') {
                        issues.push(`كائن مساعد مفقود: ${objName}`);
                    }
                });

                return {
                    passed: issues.length === 0,
                    issues: issues,
                    score: Math.max(0, 100 - (issues.length * 20))
                };
            },

            // إنشاء تقرير النظام
            generateSystemReport(results) {
                const totalScore = (results.navigation.score + results.dataIntegrity.score +
                                 results.uiConsistency.score + results.functionalIntegrity.score) / 4;

                console.log('📊 تقرير سلامة النظام:');
                console.log(`- التنقل: ${results.navigation.score}%`);
                console.log(`- سلامة البيانات: ${results.dataIntegrity.score}%`);
                console.log(`- اتساق الواجهة: ${results.uiConsistency.score}%`);
                console.log(`- سلامة الوظائف: ${results.functionalIntegrity.score}%`);
                console.log(`- النتيجة الإجمالية: ${totalScore.toFixed(1)}%`);

                // عرض النتيجة للمستخدم
                if (totalScore >= 90) {
                    NotificationUtils.showSuccess(`🎉 النظام يعمل بشكل ممتاز! النتيجة: ${totalScore.toFixed(1)}%`);
                } else if (totalScore >= 70) {
                    NotificationUtils.showInfo(`✅ النظام يعمل بشكل جيد. النتيجة: ${totalScore.toFixed(1)}%`);
                } else {
                    NotificationUtils.showWarning(`⚠️ النظام يحتاج تحسينات. النتيجة: ${totalScore.toFixed(1)}%`);
                }

                return totalScore;
            }
        };

        // ===== نظام مراقبة الأداء =====

        const PerformanceMonitor = {
            startTime: Date.now(),
            operations: [],

            // تسجيل عملية
            logOperation(operationType, details = {}) {
                const operation = {
                    id: Date.now(),
                    type: operationType,
                    timestamp: new Date().toISOString(),
                    details: details,
                    duration: null
                };

                this.operations.push(operation);
                console.log(`⏱️ بدء العملية: ${operationType}`);

                return operation.id;
            },

            // إنهاء عملية
            endOperation(operationId, success = true) {
                const operation = this.operations.find(op => op.id === operationId);
                if (operation) {
                    operation.duration = Date.now() - operation.id;
                    operation.success = success;
                    console.log(`✅ انتهاء العملية: ${operation.type} (${operation.duration}ms)`);
                }
            },

            // إحصائيات الأداء
            getPerformanceStats() {
                const totalOperations = this.operations.length;
                const successfulOperations = this.operations.filter(op => op.success).length;
                const avgDuration = this.operations.reduce((sum, op) => sum + (op.duration || 0), 0) / totalOperations;

                return {
                    totalOperations,
                    successfulOperations,
                    successRate: (successfulOperations / totalOperations) * 100,
                    avgDuration: avgDuration.toFixed(2),
                    uptime: Date.now() - this.startTime
                };
            },

            // عرض تقرير الأداء
            showPerformanceReport() {
                const stats = this.getPerformanceStats();
                console.log('📊 تقرير الأداء:');
                console.log(`- إجمالي العمليات: ${stats.totalOperations}`);
                console.log(`- العمليات الناجحة: ${stats.successfulOperations}`);
                console.log(`- معدل النجاح: ${stats.successRate.toFixed(1)}%`);
                console.log(`- متوسط وقت التنفيذ: ${stats.avgDuration}ms`);
                console.log(`- وقت التشغيل: ${(stats.uptime / 1000 / 60).toFixed(1)} دقيقة`);

                NotificationUtils.showInfo(`📊 تقرير الأداء:\n• العمليات: ${stats.totalOperations}\n• معدل النجاح: ${stats.successRate.toFixed(1)}%\n• متوسط التنفيذ: ${stats.avgDuration}ms`);
            }
        };

        // فحص سلامة البيانات
        function validateSystemIntegrity() {
            console.log('🔍 بدء فحص سلامة البيانات...');

            const issues = [];
            let checkedItems = 0;

            try {
                // فحص المنتجات
                products.forEach(product => {
                    checkedItems++;
                    if (!product.id || !product.name) {
                        issues.push(`منتج بدون معرف أو اسم: ${product.name || 'غير محدد'}`);
                    }
                    if (product.price < 0) {
                        issues.push(`منتج بسعر سالب: ${product.name}`);
                    }
                    if (product.quantity < 0) {
                        issues.push(`منتج بكمية سالبة: ${product.name}`);
                    }
                });

                // فحص العملاء
                customers.forEach(customer => {
                    checkedItems++;
                    if (!customer.id || !customer.name) {
                        issues.push(`عميل بدون معرف أو اسم: ${customer.name || 'غير محدد'}`);
                    }
                    if (customer.outstandingDebt < 0) {
                        issues.push(`عميل بدين سالب: ${customer.name}`);
                    }
                });

                // فحص الموردين
                suppliers.forEach(supplier => {
                    checkedItems++;
                    if (!supplier.id || !supplier.name) {
                        issues.push(`مورد بدون معرف أو اسم: ${supplier.name || 'غير محدد'}`);
                    }
                });

                // فحص المبيعات
                sales.forEach(sale => {
                    checkedItems++;
                    if (!sale.id || !sale.productId) {
                        issues.push(`بيع بدون معرف أو منتج: ${sale.id || 'غير محدد'}`);
                    }
                    if (sale.total < 0) {
                        issues.push(`بيع بإجمالي سالب: ${sale.id}`);
                    }

                    // التحقق من وجود المنتج
                    const product = products.find(p => p.id === sale.productId);
                    if (!product) {
                        issues.push(`بيع لمنتج غير موجود: ${sale.productName}`);
                    }
                });

                // فحص المصروفات
                expenses.forEach(expense => {
                    checkedItems++;
                    if (!expense.id || !expense.description) {
                        issues.push(`مصروف بدون معرف أو وصف: ${expense.description || 'غير محدد'}`);
                    }
                    if (expense.amount <= 0) {
                        issues.push(`مصروف بمبلغ سالب أو صفر: ${expense.description}`);
                    }
                });

                // فحص الخزنة
                if (isNaN(cashbox.balance)) {
                    issues.push('رصيد الخزنة غير صحيح');
                }

                // عرض النتائج
                console.log(`📊 تم فحص ${checkedItems} عنصر`);

                if (issues.length === 0) {
                    NotificationUtils.showSuccess(`✅ فحص سلامة البيانات مكتمل!\n\nتم فحص ${checkedItems} عنصر - لا توجد مشاكل`);
                } else {
                    console.warn('⚠️ تم العثور على مشاكل:', issues);
                    NotificationUtils.showWarning(`⚠️ تم العثور على ${issues.length} مشكلة:\n\n${issues.slice(0, 5).join('\n')}${issues.length > 5 ? '\n...' : ''}`);
                }

                return {
                    checkedItems: checkedItems,
                    issues: issues,
                    isHealthy: issues.length === 0
                };

            } catch (error) {
                console.error('❌ خطأ في فحص سلامة البيانات:', error);
                NotificationUtils.showError(`خطأ في فحص سلامة البيانات: ${error.message}`);
                return {
                    checkedItems: checkedItems,
                    issues: [error.message],
                    isHealthy: false
                };
            }
        }

        // ===== نظام الوضع الداكن =====

        const DarkModeManager = {
            isDarkMode: false,

            // تهيئة الوضع الداكن
            initialize() {
                const savedMode = localStorage.getItem('darkMode');
                if (savedMode === 'true') {
                    this.enableDarkMode();
                }
            },

            // تفعيل الوضع الداكن
            enableDarkMode() {
                this.isDarkMode = true;
                document.body.classList.add('dark-mode');

                // تحديث أيقونة الزر
                const icon = document.getElementById('darkModeIcon');
                if (icon) {
                    icon.className = 'fas fa-sun';
                }

                // تحديث المخططات للوضع الداكن
                this.updateChartsForDarkMode();

                localStorage.setItem('darkMode', 'true');
                console.log('🌙 تم تفعيل الوضع الداكن');
            },

            // إلغاء تفعيل الوضع الداكن
            disableDarkMode() {
                this.isDarkMode = false;
                document.body.classList.remove('dark-mode');

                // تحديث أيقونة الزر
                const icon = document.getElementById('darkModeIcon');
                if (icon) {
                    icon.className = 'fas fa-moon';
                }

                // تحديث المخططات للوضع العادي
                this.updateChartsForLightMode();

                localStorage.setItem('darkMode', 'false');
                console.log('☀️ تم إلغاء تفعيل الوضع الداكن');
            },

            // تبديل الوضع الداكن
            toggle() {
                if (this.isDarkMode) {
                    this.disableDarkMode();
                    NotificationUtils.showInfo('تم التبديل إلى الوضع العادي ☀️');
                } else {
                    this.enableDarkMode();
                    NotificationUtils.showInfo('تم التبديل إلى الوضع الداكن 🌙');
                }
            },

            // تحديث المخططات للوضع الداكن
            updateChartsForDarkMode() {
                if (typeof ChartsManager !== 'undefined') {
                    console.log('🌙 تحديث المخططات للوضع الداكن...');
                    setTimeout(() => {
                        ChartsManager.reinitializeCharts();
                    }, 500);
                }
            },

            // تحديث المخططات للوضع العادي
            updateChartsForLightMode() {
                if (typeof ChartsManager !== 'undefined') {
                    console.log('☀️ تحديث المخططات للوضع العادي...');
                    setTimeout(() => {
                        ChartsManager.reinitializeCharts();
                    }, 500);
                }
            }
        };

        // ===== نظام تعدد اللغات =====

        const LanguageManager = {
            currentLanguage: 'ar',
            languages: {
                ar: 'العربية',
                en: 'English'
            },

            // تهيئة نظام اللغات
            initialize() {
                const savedLanguage = localStorage.getItem('language') || 'ar';
                this.setLanguage(savedLanguage);
            },

            // تعيين اللغة
            setLanguage(lang) {
                this.currentLanguage = lang;
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

                localStorage.setItem('language', lang);
                console.log(`🌐 تم تعيين اللغة: ${this.languages[lang]}`);
            },

            // تبديل اللغة
            toggle() {
                const newLang = this.currentLanguage === 'ar' ? 'en' : 'ar';
                this.setLanguage(newLang);

                if (newLang === 'en') {
                    NotificationUtils.showInfo('Language switched to English 🇺🇸');
                } else {
                    NotificationUtils.showInfo('تم التبديل إلى العربية 🇸🇦');
                }
            }
        };

        // ===== نظام ملء الشاشة =====

        const FullscreenManager = {
            isFullscreen: false,

            // تبديل ملء الشاشة
            toggle() {
                if (!this.isFullscreen) {
                    this.enterFullscreen();
                } else {
                    this.exitFullscreen();
                }
            },

            // دخول ملء الشاشة
            enterFullscreen() {
                const elem = document.documentElement;

                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }

                this.isFullscreen = true;
                this.updateIcon();
                NotificationUtils.showInfo('تم تفعيل ملء الشاشة 📺');
            },

            // الخروج من ملء الشاشة
            exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }

                this.isFullscreen = false;
                this.updateIcon();
                NotificationUtils.showInfo('تم إلغاء ملء الشاشة 🖥️');
            },

            // تحديث الأيقونة
            updateIcon() {
                const icon = document.getElementById('fullscreenIcon');
                if (icon) {
                    icon.className = this.isFullscreen ? 'fas fa-compress' : 'fas fa-expand';
                }
            },

            // مراقبة تغييرات ملء الشاشة
            initialize() {
                document.addEventListener('fullscreenchange', () => {
                    this.isFullscreen = !!document.fullscreenElement;
                    this.updateIcon();
                });

                document.addEventListener('webkitfullscreenchange', () => {
                    this.isFullscreen = !!document.webkitFullscreenElement;
                    this.updateIcon();
                });
            }
        };

        // ===== الوظائف العامة للأزرار =====

        // تبديل الوضع الداكن
        function toggleDarkMode() {
            DarkModeManager.toggle();
        }

        // تبديل اللغة
        function toggleLanguage() {
            LanguageManager.toggle();
        }

        // تبديل ملء الشاشة
        function toggleFullscreen() {
            FullscreenManager.toggle();
        }

    </script>
</body>
</html>
